<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KINGU ELECTRICAL COMPANY LIMITED - Invoice System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF Library for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --kingu-green: #116a41;
            --kingu-red: #e63946;
            --kingu-yellow-start: #ffae42;
            --kingu-yellow-end: #ffea00;
            --kingu-dark: #0a4d2a;
            --kingu-light: #e8f5e9;
            --kingu-accent: #ff6b35;
            --kingu-success: #2a9d8f;
            --kingu-white: #ffffff;
            --kingu-blue: #2980b9;
        }

        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: linear-gradient(135deg, var(--kingu-green) 0%, var(--kingu-dark) 100%);
            color: white;
            padding: 25px 20px;
            box-shadow: 2px 0 15px rgba(17, 106, 65, 0.3);
        }

        .logo-container {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--kingu-yellow-start) 0%, var(--kingu-yellow-end) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }

        .logo:before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            background: white;
            border-radius: 50%;
            z-index: 1;
        }

        .logo i {
            font-size: 28px;
            color: var(--kingu-red);
            z-index: 2;
            position: relative;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .company-header {
            line-height: 1.2;
            margin-bottom: 3px;
        }

        .company-header .kingu {
            font-size: 20px;
            font-weight: 800;
            color: white;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            display: block;
        }

        .company-header .electrical {
            font-size: 16px;
            font-weight: 700;
            color: var(--kingu-red);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            display: block;
            margin-top: -2px;
        }

        .company-full-name {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 2px;
            font-weight: 500;
            line-height: 1;
        }

        .company-tagline {
            font-size: 11px;
            opacity: 0.9;
            margin-top: 8px;
            color: rgba(255, 255, 255, 0.9);
            font-style: italic;
            line-height: 1.3;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 5px;
        }

        .nav-menu {
            list-style: none;
            margin-top: 30px;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            color: white;
            text-decoration: none;
            padding: 12px 15px;
            border-radius: 8px;
            transition: all 0.3s;
            border-left: 3px solid transparent;
            cursor: pointer;
        }

        .nav-link i {
            margin-right: 12px;
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.15);
            border-left: 3px solid var(--kingu-red);
        }

        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-left: 3px solid var(--kingu-red);
            font-weight: 600;
        }

        /* Company Info in Sidebar */
        .company-info-sidebar {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 13px;
        }

        .company-info-sidebar p {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            line-height: 1.4;
        }

        .company-info-sidebar i {
            margin-right: 10px;
            margin-top: 3px;
            color: var(--kingu-yellow-end);
            min-width: 16px;
        }

        .contact-badge {
            display: inline-block;
            background-color: var(--kingu-red);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            font-weight: bold;
        }

        /* Contact Badges */
        .contact-badges {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .contact-badge-small {
            display: inline-flex;
            align-items: center;
            background-color: var(--kingu-light);
            color: var(--kingu-green);
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 600;
            border: 1px solid rgba(17, 106, 65, 0.2);
        }

        .contact-badge-small i {
            margin-right: 5px;
            font-size: 14px;
        }

        .whatsapp-badge {
            background-color: rgba(37, 211, 102, 0.1);
            color: #128C7E;
            border-color: rgba(37, 211, 102, 0.3);
        }

        .email-badge {
            background-color: rgba(66, 133, 244, 0.1);
            color: #4285f4;
            border-color: rgba(66, 133, 244, 0.3);
        }

        .color-scheme {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .color-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .green { background-color: var(--kingu-green); }
        .red { background-color: var(--kingu-red); }
        .yellow-start { background-color: var(--kingu-yellow-start); }
        .yellow-end { background-color: var(--kingu-yellow-end); }
        .blue { background-color: var(--kingu-blue); }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background-color: var(--kingu-white);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--kingu-light);
        }

        .header h1 {
            color: var(--kingu-green);
            font-size: 28px;
            position: relative;
            padding-left: 15px;
        }

        .header h1:before {
            content: '';
            position: absolute;
            left: 0;
            top: 5px;
            bottom: 5px;
            width: 4px;
            background: linear-gradient(to bottom, var(--kingu-green), var(--kingu-red));
            border-radius: 2px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background-color: var(--kingu-green);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--kingu-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(17, 106, 65, 0.2);
        }

        .btn-success {
            background-color: var(--kingu-success);
            color: white;
        }

        .btn-success:hover {
            background-color: #21867a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(42, 157, 143, 0.2);
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
            transform: translateY(-2px);
        }

        .btn-accent {
            background-color: var(--kingu-red);
            color: white;
        }

        .btn-accent:hover {
            background-color: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(230, 57, 70, 0.2);
        }

        .btn-whatsapp {
            background-color: #25D366;
            color: white;
        }

        .btn-whatsapp:hover {
            background-color: #128C7E;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.2);
        }

        .btn-pdf {
            background-color: #d32f2f;
            color: white;
        }

        .btn-pdf:hover {
            background-color: #b71c1c;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(211, 47, 47, 0.2);
        }

        .btn i {
            margin-right: 8px;
        }

        /* Invoice Type Selector */
        .invoice-type-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(17, 106, 65, 0.1);
            border-left: 4px solid var(--kingu-green);
        }

        .type-btn {
            padding: 10px 25px;
            border: 2px solid var(--kingu-green);
            background: white;
            color: var(--kingu-green);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .type-btn.active {
            background: var(--kingu-green);
            color: white;
        }

        .type-btn.quotation-active {
            background: var(--kingu-blue);
            color: white;
            border-color: var(--kingu-blue);
        }

        .type-btn:hover:not(.active):not(.quotation-active) {
            background-color: var(--kingu-light);
        }

        /* Invoice Form Container */
        .invoice-form-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(17, 106, 65, 0.1);
            padding: 30px;
            margin-bottom: 30px;
            border-top: 4px solid var(--kingu-green);
            max-width: 100%;
            overflow-x: hidden;
        }

        .quotation-form-container {
            border-top: 4px solid var(--kingu-blue);
        }

        .form-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 18px;
            color: var(--kingu-green);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--kingu-light);
            display: flex;
            align-items: center;
        }

        .quotation-section-title {
            color: var(--kingu-blue);
        }

        .section-title i {
            margin-right: 10px;
            color: var(--kingu-red);
        }

        .quotation-section-title i {
            color: var(--kingu-blue);
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -15px;
        }

        .form-group {
            flex: 1;
            min-width: 250px;
            padding: 0 15px;
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--kingu-dark);
            font-size: 14px;
        }

        .quotation-form-group label {
            color: var(--kingu-blue);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--kingu-green);
            box-shadow: 0 0 0 3px rgba(17, 106, 65, 0.1);
        }

        .quotation-control:focus {
            border-color: var(--kingu-blue);
            box-shadow: 0 0 0 3px rgba(41, 128, 185, 0.1);
        }

        /* Invoice Items Table */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .items-table thead {
            background-color: var(--kingu-green);
        }

        .quotation-items-table thead {
            background-color: var(--kingu-blue);
        }

        .items-table th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: white;
            border-bottom: 2px solid var(--kingu-dark);
        }

        .quotation-items-table th {
            border-bottom: 2px solid #1a5276;
        }

        .items-table td {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        .items-table tr:hover {
            background-color: #f9fafb;
        }

        .items-table input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        .delete-item {
            background-color: var(--kingu-red);
            color: white;
            border: none;
            border-radius: 4px;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .delete-item:hover {
            background-color: #c62828;
            transform: scale(1.05);
        }

        .add-item-btn {
            margin-top: 15px;
            background-color: var(--kingu-light);
            color: var(--kingu-green);
            border: 2px dashed var(--kingu-green);
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            transition: all 0.3s;
        }

        .quotation-add-item-btn {
            background-color: rgba(41, 128, 185, 0.1);
            color: var(--kingu-blue);
            border: 2px dashed var(--kingu-blue);
        }

        .add-item-btn:hover {
            background-color: var(--kingu-green);
            color: white;
            border-color: var(--kingu-green);
        }

        .quotation-add-item-btn:hover {
            background-color: var(--kingu-blue);
            color: white;
            border-color: var(--kingu-blue);
        }

        .add-item-btn i {
            margin-right: 8px;
        }

        /* Totals Section */
        .totals-section {
            background: linear-gradient(135deg, #f8fafc 0%, var(--kingu-light) 100%);
            padding: 25px;
            border-radius: 8px;
            margin-top: 30px;
            border-left: 4px solid var(--kingu-green);
        }

        .quotation-totals-section {
            background: linear-gradient(135deg, #f8fafc 0%, rgba(41, 128, 185, 0.1) 100%);
            border-left: 4px solid var(--kingu-blue);
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(17, 106, 65, 0.1);
        }

        .quotation-total-row {
            border-bottom: 1px solid rgba(41, 128, 185, 0.2);
        }

        .total-label {
            font-weight: 600;
            color: var(--kingu-dark);
        }

        .quotation-total-label {
            color: var(--kingu-blue);
        }

        .total-value {
            font-weight: 700;
            color: var(--kingu-green);
        }

        .quotation-total-value {
            color: var(--kingu-blue);
        }

        .grand-total {
            font-size: 20px;
            border-top: 2px solid var(--kingu-green);
            margin-top: 10px;
            padding-top: 15px;
            color: var(--kingu-dark);
        }

        .quotation-grand-total {
            border-top: 2px solid var(--kingu-blue);
            color: var(--kingu-blue);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }

        /* History Containers */
        .history-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(17, 106, 65, 0.1);
            padding: 30px;
            margin-top: 20px;
            border-top: 4px solid var(--kingu-green);
            display: none;
        }

        /* A4 Preview Container */
        .a4-preview-container {
            display: none;
            width: 210mm;
            min-height: 297mm;
            margin: 20px auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
            padding: 20mm;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.3;
        }

        /* A4 Print Styles */
        @media print {
            @page {
                size: A4;
                margin: 0;
            }
            
            body, html {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                width: 210mm !important;
                height: 297mm !important;
            }
            
            body * {
                visibility: hidden;
            }
            
            .print-content,
            .print-content * {
                visibility: visible !important;
            }
            
            .print-content {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 210mm !important;
                min-height: 297mm !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                background-color: white !important;
                border: none !important;
                border-radius: 0 !important;
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
            }
            
            /* Hide non-printable elements */
            .sidebar, 
            .header, 
            .invoice-form-container, 
            .action-buttons, 
            .invoice-type-selector,
            .nav-menu,
            .btn,
            button,
            .history-container,
            .main-content > *:not(.print-content),
            .no-print,
            .a4-preview-container {
                display: none !important;
                visibility: hidden !important;
            }
            
            .container {
                display: block !important;
                width: 100% !important;
                height: 100% !important;
            }
            
            .main-content {
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
                height: 100% !important;
            }
        }

        @media screen and (max-width: 1024px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .action-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .a4-preview-container {
                width: 100%;
                padding: 10mm;
                zoom: 0.8;
            }
        }

        /* A4 specific styles for screen preview */
        @media screen and (min-width: 800px) {
            .a4-preview-container {
                width: 210mm;
                min-height: 297mm;
                padding: 20mm;
                margin: 20px auto;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
                position: relative;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo-container">
                <div class="logo">
                    <i class="fas fa-bolt"></i>
                </div>
                <div class="logo-text">
                    <div class="company-header">
                        <span class="kingu">Kingu</span>
                        <span class="electrical">Electrical</span>
                    </div>
                    <div class="company-full-name">Company Limited</div>
                    <div class="company-tagline">Quality Electrical Services with Professional Experience</div>
                </div>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" id="nav-create">
                        <i class="fas fa-file-invoice-dollar"></i> Create Invoice
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="nav-proforma">
                        <i class="fas fa-file-contract"></i> Proforma Invoices
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="nav-history">
                        <i class="fas fa-history"></i> Document History
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="nav-clients">
                        <i class="fas fa-users"></i> Client Database
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="nav-reports">
                        <i class="fas fa-chart-bar"></i> Reports & Analytics
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="nav-settings">
                        <i class="fas fa-cog"></i> System Settings
                    </a>
                </li>
            </ul>
            
            <div class="company-info-sidebar">
                <p><i class="fas fa-map-marker-alt"></i> <span>P.O. Box 62313<br>Dar Es Salaam Tanzania</span></p>
                <p><i class="fas fa-hashtag"></i> TIN: 157-024-493</p>
                <p><i class="fas fa-phone"></i> +255 677 01 47 40</p>
                <p><i class="fas fa-phone"></i> +255 763 95 79 08</p>
                <p><i class="fas fa-phone"></i> +255 682 84 35 52</p>
                <p><i class="fab fa-whatsapp"></i> +255 682 84 35 52 <span class="contact-badge">WHATSAPP</span></p>
                <p><i class="fas fa-envelope"></i> kinguelectricaltz@gmail.com</p>
                <p><i class="fas fa-university"></i> STANBIC BANK<br>912 000 275 9274</p>
                
                <div class="contact-badges">
                    <span class="contact-badge-small">
                        <i class="fas fa-phone"></i> Call Us
                    </span>
                    <span class="contact-badge-small whatsapp-badge">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </span>
                    <span class="contact-badge-small email-badge">
                        <i class="fas fa-envelope"></i> Email
                    </span>
                </div>
                
                <div class="color-scheme">
                    <div class="color-box green" title="Kingu Green: #116a41"></div>
                    <div class="color-box red" title="Electrical Red: #e63946"></div>
                    <div class="color-box yellow-start" title="Light Bulb Start: #ffae42"></div>
                    <div class="color-box yellow-end" title="Light Bulb End: #ffea00"></div>
                    <div class="color-box blue" title="Quotation Blue: #2980b9"></div>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <div class="header">
                <h1 id="page-title">Create Proforma Invoice</h1>
                <div>
                    <button class="btn btn-whatsapp" id="whatsapp-btn" style="margin-right: 10px;">
                        <i class="fab fa-whatsapp"></i> Share Document
                    </button>
                    <button class="btn btn-pdf" id="pdf-btn" style="display: none; margin-right: 10px;">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                    <button class="btn btn-accent" id="load-sample-btn">
                        <i class="fas fa-file-import"></i> Load Sample
                    </button>
                    <button class="btn btn-secondary" id="print-btn" style="display: none;">
                        <i class="fas fa-print"></i> Print Document
                    </button>
                    <button class="btn btn-success" id="new-document-btn" style="margin-right: 10px;">
                        <i class="fas fa-plus"></i> New Document
                    </button>
                </div>
            </div>
            
            <div class="invoice-type-selector">
                <button class="type-btn active" id="btn-proforma">Proforma Invoice</button>
                <button class="type-btn" id="btn-standard">Standard Invoice</button>
                <button class="type-btn" id="btn-quotation">Quotation</button>
            </div>
            
            <!-- Invoice Form -->
            <div id="invoice-form" class="invoice-form-container">
                <div class="form-section">
                    <h3 class="section-title" id="details-title"><i class="fas fa-info-circle"></i> Invoice Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="invoice-number" id="doc-number-label">Invoice Number</label>
                            <div style="display: flex; align-items: center;">
                                <input type="text" id="invoice-number" class="form-control" value="PROFORMAGL/06/2025/001" style="flex: 1;">
                                <button class="btn" style="margin-left: 10px; padding: 10px 15px; background-color: var(--kingu-light);" id="generate-number-btn" title="Generate New Number">
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="invoice-date" id="doc-date-label">Invoice Date</label>
                            <input type="date" id="invoice-date" class="form-control" value="">
                        </div>
                        <div class="form-group">
                            <label for="due-date">Due Date</label>
                            <input type="date" id="due-date" class="form-control" value="">
                        </div>
                    </div>
                    
                    <div class="proforma-fields" id="extra-fields">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="currency">Currency</label>
                                <select id="currency" class="form-control currency-select">
                                    <option value="TSh">Tanzanian Shilling (TSh)</option>
                                    <option value="USD">US Dollar ($)</option>
                                    <option value="EUR">Euro (€)</option>
                                    <option value="GBP">British Pound (£)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="delivery-time">Delivery Time (Days after PO)</label>
                                <input type="number" id="delivery-time" class="form-control" value="7" min="1">
                            </div>
                            <div class="form-group">
                                <label for="payment-terms">Payment Terms</label>
                                <select id="payment-terms" class="form-control">
                                    <option value="100% after delivery">100% after delivery</option>
                                    <option value="50% advance, 50% after delivery">50% advance, 50% after delivery</option>
                                    <option value="30 days net">30 days net</option>
                                    <option value="Custom">Custom</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row" id="custom-terms-container" style="display: none;">
                            <div class="form-group">
                                <label for="custom-payment-terms">Custom Payment Terms</label>
                                <textarea id="custom-payment-terms" class="form-control" rows="2" placeholder="Enter custom payment terms"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-user-tie"></i> Client Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="client-name">Client Name</label>
                            <div style="display: flex;">
                                <input type="text" id="client-name" class="form-control" placeholder="Enter client name" value="GREENLIGHT PLANNET TANZANIA LTD">
                                <button class="btn" style="margin-left: 10px; padding: 10px 15px; background-color: var(--kingu-light);" id="client-search-btn" title="Search Client Database">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="client-email">Client Email</label>
                            <input type="email" id="client-email" class="form-control" placeholder="Enter client email" value="accounts@greenlight.co.tz">
                        </div>
                        <div class="form-group">
                            <label for="client-phone">Client Phone</label>
                            <input type="text" id="client-phone" class="form-control" placeholder="Enter client phone" value="+255 765 432 100">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="client-address">Client Address</label>
                            <textarea id="client-address" class="form-control" rows="2" placeholder="Enter client address">ARUSHA, TANZANIA</textarea>
                        </div>
                        <div class="form-group">
                            <label for="client-tin">TIN Number</label>
                            <input type="text" id="client-tin" class="form-control" placeholder="Enter TIN number" value="109-628-980">
                        </div>
                        <div class="form-group">
                            <label for="client-vat">VAT Number (if applicable)</label>
                            <input type="text" id="client-vat" class="form-control" placeholder="Enter VAT number">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="section-title" id="items-title"><i class="fas fa-list-alt"></i> Invoice Items</h3>
                    <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                        <button class="btn" style="background-color: var(--kingu-light); color: var(--kingu-green);" id="add-service-item">
                            <i class="fas fa-wrench"></i> Add Service
                        </button>
                        <button class="btn" style="background-color: var(--kingu-light); color: var(--kingu-green);" id="add-product-item">
                            <i class="fas fa-box"></i> Add Product
                        </button>
                        <button class="btn" style="background-color: var(--kingu-light); color: var(--kingu-green);" id="add-labor-item">
                            <i class="fas fa-user-hard-hat"></i> Add Labor
                        </button>
                    </div>
                    <table class="items-table" id="items-table">
                        <thead>
                            <tr>
                                <th>DESCRIPTION</th>
                                <th style="width: 100px;">UNITS</th>
                                <th style="width: 150px;">UNIT PRICE</th>
                                <th style="width: 150px;">AMOUNT</th>
                                <th style="width: 80px;">ACTION</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-items">
                            <tr>
                                <td><input type="text" class="item-description" placeholder="Service description" value="Engine service and Preventive maintenance"></td>
                                <td><input type="number" class="item-quantity" min="0" step="0.01" value="1.00"></td>
                                <td>
                                    <div style="display: flex; align-items: center;">
                                        <span class="currency-symbol" style="margin-right: 5px;">TSh</span>
                                        <input type="number" class="item-price" min="0" step="0.01" value="350000.00" style="flex: 1;">
                                    </div>
                                </td>
                                <td class="item-total text-right">TSh 350,000.00</td>
                                <td class="text-center"><button class="delete-item"><i class="fas fa-trash"></i></button></td>
                            </tr>
                            <tr>
                                <td><input type="text" class="item-description" placeholder="Service description" value="PLC check and configuration"></td>
                                <td><input type="number" class="item-quantity" min="0" step="0.01" value="1.00"></td>
                                <td>
                                    <div style="display: flex; align-items: center;">
                                        <span class="currency-symbol" style="margin-right: 5px;">TSh</span>
                                        <input type="number" class="item-price" min="0" step="0.01" value="250000.00" style="flex: 1;">
                                    </div>
                                </td>
                                <td class="item-total text-right">TSh 250,000.00</td>
                                <td class="text-center"><button class="delete-item"><i class="fas fa-trash"></i></button></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <button class="add-item-btn" id="add-item-btn">
                        <i class="fas fa-plus-circle"></i> Add Custom Item
                    </button>
                    
                    <div style="margin-top: 20px; display: flex; gap: 15px; align-items: center;">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label for="discount-type">Discount</label>
                            <select id="discount-type" class="form-control">
                                <option value="none">No Discount</option>
                                <option value="percentage">Percentage %</option>
                                <option value="fixed">Fixed Amount</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1; margin-bottom: 0; display: none;" id="discount-value-container">
                            <label for="discount-value">Discount Value</label>
                            <input type="number" id="discount-value" class="form-control" min="0" step="0.01" value="0">
                        </div>
                    </div>
                </div>
                
                <div class="totals-section" id="totals-section">
                    <div class="total-row">
                        <span class="total-label">Subtotal:</span>
                        <span class="total-value" id="subtotal">TSh 600,000.00</span>
                    </div>
                    <div class="total-row" id="discount-row" style="display: none;">
                        <span class="total-label" id="discount-label">Discount:</span>
                        <span class="total-value" id="discount-amount">TSh 0.00</span>
                    </div>
                    <div class="total-row">
                        <span class="total-label">VAT (18%):</span>
                        <span class="total-value" id="tax">TSh 108,000.00</span>
                    </div>
                    <div class="total-row grand-total">
                        <span class="total-label" id="grand-total-label">GRAND TOTAL:</span>
                        <span class="total-value" id="grand-total">TSh 708,000.00</span>
                    </div>
                    <div class="total-row" style="margin-top: 10px; font-size: 14px; color: #666;">
                        <span class="total-label">Amount in Words:</span>
                        <span class="total-value" id="amount-words">Seven hundred eight thousand Tanzanian Shillings only</span>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-file-signature"></i> Terms & Conditions</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bank-details">Bank Details</label>
                            <textarea id="bank-details" class="form-control" rows="3">BANK: STANBIC BANK TANZANIA LIMITED
ACCOUNT NAME: KINGU ELECTRICAL COMPANY LIMITED
ACCOUNT NUMBER: 912 000 275 9274
SWIFT CODE: SBICTZTX</textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="notes">Additional Notes / Special Instructions</label>
                            <textarea id="notes" class="form-control" rows="4" placeholder="Add any additional notes here...">1. This Proforma shall remain valid for 30 days only.
2. Prices are inclusive of VAT where applicable.
3. Delivery subject to stock availability.
4. All disputes subject to Dar es Salaam jurisdiction.</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="clear-btn">
                        <i class="fas fa-redo"></i> Clear Form
                    </button>
                    <button class="btn btn-success" id="preview-btn">
                        <i class="fas fa-eye"></i> Preview Document
                    </button>
                    <button class="btn btn-primary" id="save-btn">
                        <i class="fas fa-save"></i> Save Proforma
                    </button>
                    <button class="btn" style="background-color: var(--kingu-accent); color: white;" id="send-email-btn">
                        <i class="fas fa-paper-plane"></i> Send via Email
                    </button>
                </div>
            </div>
            
            <!-- A4 Preview Container -->
            <div id="a4-preview" class="a4-preview-container">
                <div class="print-content" id="print-content">
                    <!-- Content will be inserted here by JavaScript -->
                </div>
            </div>
            
            <!-- Other sections remain unchanged -->
            <div id="client-database" class="history-container">
                <h2 style="color: var(--kingu-green); margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;">
                    <span><i class="fas fa-users" style="margin-right: 10px;"></i> Client Database</span>
                    <button class="btn btn-primary" id="add-client-btn">
                        <i class="fas fa-user-plus"></i> Add New Client
                    </button>
                </h2>
                <div id="client-list">
                    <p>Loading client database...</p>
                </div>
            </div>
            
            <div id="proforma-invoices" class="history-container">
                <h2 style="color: var(--kingu-green); margin-bottom: 20px; display: flex; align-items: center;">
                    <i class="fas fa-file-contract" style="margin-right: 10px;"></i> Proforma Invoices
                </h2>
                <div id="proforma-list">
                    <p>Loading proforma invoices...</p>
                </div>
            </div>
            
            <!-- Other sections... -->
        </main>
    </div>

    <script>
        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        
        // A4 Document Generator
        class A4DocumentGenerator {
            constructor() {
                this.currentDocument = null;
            }
            
            async getHeaderHTML() {
                try {
                    // Try to fetch external header file
                    const response = await fetch('/invoice/header.html');
                    if (response.ok) {
                        return await response.text();
                    }
                } catch (error) {
                    console.log('Using default header');
                }
                
                // Default header if external file not found
                return `
                    <div style="border-bottom: 2px solid #116a41; margin-bottom: 20px; padding-bottom: 10px;">
                        <table style="width: 100%;">
                            <tr>
                                <td style="width: 70%;">
                                    <h1 style="color: #116a41; margin: 0; font-size: 18pt; line-height: 1.2;">
                                        <span style="display: block; font-weight: bold;">KINGU ELECTRICAL</span>
                                        <span style="display: block; font-weight: bold;">COMPANY LIMITED</span>
                                    </h1>
                                    <p style="margin: 3px 0; font-size: 10pt;">TIN: 157-024-493</p>
                                    <p style="margin: 3px 0; font-size: 9pt; font-style: italic; color: #555;">
                                        Quality Electrical Services with Professional Experience
                                    </p>
                                    <p style="margin: 3px 0; font-size: 9pt;">
                                        P.O. Box 62313, Dar Es Salaam Tanzania<br>
                                        Tel: +255 677 01 47 40 | +255 763 95 79 08 | +255 682 84 35 52<br>
                                        Email: kinguelectricaltz@gmail.com
                                    </p>
                                </td>
                                <td style="width: 30%; text-align: right; vertical-align: top;">
                    <div style="border: 2px solid #116a41; padding: 10px; display: inline-block; text-align: center;">
                        <strong style="font-size: 14pt; color: #116a41;">{{DOCUMENT_TYPE}}</strong><br>
                        <span style="font-size: 9pt;">{{DOCUMENT_NUMBER}}</span>
                    </div>
                </td>
            </tr>
        </table>
    </div>
                `;
            }
            
            async getFooterHTML() {
                try {
                    // Try to fetch external footer file
                    const response = await fetch('/invoice/footer.html');
                    if (response.ok) {
                        return await response.text();
                    }
                } catch (error) {
                    console.log('Using default footer');
                }
                
                // Default footer if external file not found
                return `
                    <div style="border-top: 2px solid #116a41; margin-top: 30px; padding-top: 20px; font-size: 9pt;">
                        <table style="width: 100%;">
                            <tr>
                                <td style="width: 60%;">
                                    <p style="margin: 5px 0;"><strong>Bank Details:</strong></p>
                                    <p style="margin: 5px 0; white-space: pre-line;">{{BANK_DETAILS}}</p>
                                </td>
                                <td style="width: 40%; text-align: right;">
                                    <p style="margin: 5px 0;">
                                        <i class="fas fa-phone"></i> +255 677 014 740<br>
                                        <i class="fab fa-whatsapp"></i> +255 682 843 552<br>
                                        <i class="fas fa-envelope"></i> Kinguelectricaltz@gmail.com
                                    </p>
                                </td>
                            </tr>
                        </table>
                        <div style="text-align: center; margin-top: 20px;">
                            <div style="width: 200px; border-top: 1px solid #000; margin: 20px auto 5px;"></div>
                            <p style="margin: 5px 0;">Authorized Signature & Company Stamp</p>
                            <p style="margin: 5px 0; font-style: italic;">This is a computer-generated document. No signature is required.</p>
                            <p style="margin: 10px 0 0 0; font-weight: bold; color: #116a41;">Website: kingueletrical.com</p>
                        </div>
                    </div>
                `;
            }
            
            createDocumentTemplate(data) {
                const isQuotation = data.type === 'Quotation';
                const isStandard = data.type === 'Standard';
                const documentType = isQuotation ? 'QUOTATION' : (isStandard ? 'TAX INVOICE' : 'PROFORMA INVOICE');
                
                return `
                    <div class="print-content" style="padding: 15mm; font-family: Arial, sans-serif; font-size: 11pt; line-height: 1.3;">
                        <!-- Header will be inserted here -->
                        <div id="document-header"></div>
                        
                        <!-- Document Details Section -->
                        <div style="display: flex; justify-content: space-between; margin: 20px 0; gap: 20px;">
                            <div style="flex: 1; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                <h3 style="color: #116a41; margin: 0 0 10px 0; font-size: 12pt;">${isQuotation ? 'TO:' : 'BILL TO:'}</h3>
                                <p style="margin: 5px 0; font-size: 10pt;"><strong>${data.clientName || 'Client Name'}</strong></p>
                                <p style="margin: 5px 0; font-size: 10pt;">${data.clientAddress || 'Client Address'}</p>
                                ${data.clientTIN ? `<p style="margin: 5px 0; font-size: 10pt;"><strong>TIN:</strong> ${data.clientTIN}</p>` : ''}
                                ${data.clientPhone ? `<p style="margin: 5px 0; font-size: 10pt;"><strong>Phone:</strong> ${data.clientPhone}</p>` : ''}
                                ${data.clientEmail ? `<p style="margin: 5px 0; font-size: 10pt;"><strong>Email:</strong> ${data.clientEmail}</p>` : ''}
                            </div>
                            
                            <div style="flex: 1; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                <h3 style="color: #116a41; margin: 0 0 10px 0; font-size: 12pt;">DOCUMENT DETAILS:</h3>
                                <p style="margin: 5px 0; font-size: 10pt;"><strong>${isQuotation ? 'Quotation #:' : 'Invoice #:'}</strong> ${data.documentNumber || ''}</p>
                                <p style="margin: 5px 0; font-size: 10pt;"><strong>${isQuotation ? 'Quotation Date:' : 'Invoice Date:'}</strong> ${this.formatDate(data.documentDate)}</p>
                                <p style="margin: 5px 0; font-size: 10pt;"><strong>Due Date:</strong> ${this.formatDate(data.dueDate)}</p>
                                <p style="margin: 5px 0; font-size: 10pt;"><strong>Delivery:</strong> ${data.deliveryTime || '7'} days after PO</p>
                                <p style="margin: 5px 0; font-size: 10pt;"><strong>Payment Terms:</strong> ${data.paymentTerms || '100% after delivery'}</p>
                            </div>
                        </div>
                        
                        <!-- Subject Line -->
                        <div style="margin: 20px 0; padding-bottom: 10px; border-bottom: 1px solid #116a41;">
                            <h3 style="color: #116a41; margin: 0 0 5px 0; font-size: 12pt;">
                                Subject: ${isQuotation ? 'Quotation for Electrical Services' : (data.type === 'Proforma' ? 'Proforma Invoice for Electrical Services' : 'Invoice for Electrical Services')}
                            </h3>
                            <p style="margin: 0; font-size: 10pt; color: #555; font-style: italic;">
                                ${isQuotation ? 
                                    'Thank you for your inquiry. We are pleased to submit our quotation for the requested electrical services. All prices are inclusive of VAT where applicable and are valid for 30 days.' : 
                                    (data.type === 'Proforma' ? 
                                    'This proforma invoice is prepared for the services rendered. All prices are inclusive of VAT where applicable.' : 
                                    'This invoice is prepared for the services rendered. All prices are inclusive of VAT where applicable.')}
                            </p>
                        </div>
                        
                        <!-- Items Table -->
                        <table style="width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 10pt;">
                            <thead>
                                <tr style="background: #116a41; color: white;">
                                    <th style="padding: 8px; text-align: left; font-weight: bold;">DESCRIPTION</th>
                                    <th style="padding: 8px; text-align: center; font-weight: bold;">UNITS</th>
                                    <th style="padding: 8px; text-align: right; font-weight: bold;">UNIT PRICE</th>
                                    <th style="padding: 8px; text-align: right; font-weight: bold;">AMOUNT</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${this.generateItemsHTML(data.items || [], data.currency)}
                            </tbody>
                        </table>
                        
                        <!-- Totals -->
                        <div style="width: 300px; margin-left: auto; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; font-size: 10pt;">
                            <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #ddd;">
                                <span>Subtotal:</span>
                                <span>${this.formatCurrency(data.subtotal || 0, data.currency)}</span>
                            </div>
                            ${data.discount > 0 ? `
                            <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #ddd;">
                                <span>Discount:</span>
                                <span>${this.formatCurrency(data.discount || 0, data.currency)}</span>
                            </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #ddd;">
                                <span>VAT (18%):</span>
                                <span>${this.formatCurrency(data.tax || 0, data.currency)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-top: 2px solid #116a41; margin-top: 10px; font-weight: bold; font-size: 11pt;">
                                <span>${isQuotation ? 'TOTAL QUOTATION:' : 'GRAND TOTAL:'}</span>
                                <span>${this.formatCurrency(data.grandTotal || 0, data.currency)}</span>
                            </div>
                            <div style="margin-top: 10px; padding: 8px; background: #e8f5e9; border-radius: 3px; font-style: italic;">
                                <strong>Amount in Words:</strong> ${this.numberToWords(Math.round(data.grandTotal || 0))}
                            </div>
                        </div>
                        
                        <!-- Terms & Notes -->
                        <div style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 5px; font-size: 9pt;">
                            ${data.notes ? `<p style="margin: 0 0 10px 0; white-space: pre-line;">${data.notes}</p>` : ''}
                        </div>
                        
                        <!-- Footer will be inserted here -->
                        <div id="document-footer"></div>
                    </div>
                `;
            }
            
            generateItemsHTML(items, currency) {
                if (!items || items.length === 0) {
                    return '<tr><td colspan="4" style="text-align: center; padding: 20px;">No items</td></tr>';
                }
                
                return items.map(item => `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 6px;">${item.description || ''}</td>
                        <td style="padding: 6px; text-align: center;">${parseFloat(item.quantity || 0).toFixed(2)}</td>
                        <td style="padding: 6px; text-align: right;">${this.formatCurrency(item.price || 0, currency)}</td>
                        <td style="padding: 6px; text-align: right;">${this.formatCurrency(item.total || 0, currency)}</td>
                    </tr>
                `).join('');
            }
            
            formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '';
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
            
            formatCurrency(amount, currency = 'TSh') {
                const symbol = currency === 'TSh' ? 'TSh ' : 
                              currency === 'USD' ? '$' :
                              currency === 'EUR' ? '€' : '£';
                const formatted = parseFloat(amount).toFixed(2)
                    .replace(/\d(?=(\d{3})+\.)/g, '$&,');
                return symbol + formatted;
            }
            
            numberToWords(num) {
                const units = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
                const teens = ['ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen'];
                const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
                
                if (num === 0) return 'zero Tanzanian Shillings only';
                
                let words = '';
                const million = Math.floor(num / 1000000);
                const thousand = Math.floor((num % 1000000) / 1000);
                const remainder = num % 1000;
                
                if (million > 0) {
                    words += this.convertThreeDigits(million) + ' million ';
                }
                if (thousand > 0) {
                    words += this.convertThreeDigits(thousand) + ' thousand ';
                }
                if (remainder > 0) {
                    words += this.convertThreeDigits(remainder);
                }
                
                return words.trim() + ' Tanzanian Shillings only';
            }
            
            convertThreeDigits(n) {
                const units = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
                const teens = ['ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen'];
                const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
                
                let result = '';
                if (n >= 100) {
                    result += units[Math.floor(n / 100)] + ' hundred ';
                    n %= 100;
                }
                if (n >= 20) {
                    result += tens[Math.floor(n / 10)] + ' ';
                    n %= 10;
                } else if (n >= 10) {
                    result += teens[n - 10] + ' ';
                    n = 0;
                }
                if (n > 0) {
                    result += units[n] + ' ';
                }
                return result.trim();
            }
            
            async generatePDF(documentElement, data, filename = 'document.pdf') {
                return new Promise((resolve, reject) => {
                    try {
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        
                        // Set PDF properties
                        pdf.setProperties({
                            title: filename.replace('.pdf', ''),
                            subject: 'Invoice Document',
                            author: 'KINGU ELECTRICAL COMPANY LIMITED',
                            keywords: 'invoice, proforma, quotation, electrical',
                            creator: 'KINGU Invoice System'
                        });
                        
                        html2canvas(documentElement, {
                            scale: 2,
                            useCORS: true,
                            logging: false,
                            backgroundColor: '#ffffff',
                            width: documentElement.offsetWidth,
                            height: documentElement.offsetHeight
                        }).then(canvas => {
                            const imgData = canvas.toDataURL('image/png');
                            const imgWidth = 210;
                            const imgHeight = (canvas.height * imgWidth) / canvas.width;
                            
                            // Add content
                            pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                            
                            // Save the PDF
                            pdf.save(filename);
                            resolve(pdf);
                        }).catch(reject);
                    } catch (error) {
                        reject(error);
                    }
                });
            }
            
            async printDocument(data) {
                const printWindow = window.open('', '_blank');
                
                // Get header and footer
                const headerHTML = await this.getHeaderHTML();
                const footerHTML = await this.getFooterHTML();
                
                // Replace placeholders in header
                const isQuotation = data.type === 'Quotation';
                const isStandard = data.type === 'Standard';
                const documentType = isQuotation ? 'QUOTATION' : (isStandard ? 'TAX INVOICE' : 'PROFORMA INVOICE');
                
                let processedHeader = headerHTML
                    .replace('{{DOCUMENT_TYPE}}', documentType)
                    .replace('{{DOCUMENT_NUMBER}}', data.documentNumber || '');
                
                let processedFooter = footerHTML
                    .replace('{{BANK_DETAILS}}', data.bankDetails || '');
                
                // Create complete document
                const documentHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${documentType} - ${data.documentNumber}</title>
                        <style>
                            @page {
                                size: A4;
                                margin: 15mm;
                            }
                            body {
                                margin: 0;
                                padding: 0;
                                font-family: Arial, sans-serif;
                                font-size: 11pt;
                                line-height: 1.3;
                                color: #000;
                                width: 210mm;
                            }
                            .document-container {
                                width: 210mm;
                                min-height: 297mm;
                                padding: 15mm;
                                box-sizing: border-box;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                page-break-inside: avoid;
                            }
                            th, td {
                                padding: 4pt 6pt;
                                border: 1px solid #ddd;
                                font-size: 10pt;
                            }
                            .no-break {
                                page-break-inside: avoid;
                            }
                            .totals {
                                width: 300px;
                                margin-left: auto;
                                margin-top: 20px;
                            }
                            .amount-words {
                                background: #e8f5e9;
                                padding: 8px;
                                border-radius: 3px;
                                font-style: italic;
                                margin-top: 10px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="document-container">
                            ${processedHeader}
                            
                            <div style="display: flex; justify-content: space-between; margin: 20px 0; gap: 20px;">
                                <div style="flex: 1; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                    <h3 style="color: #116a41; margin: 0 0 10px 0; font-size: 12pt;">${isQuotation ? 'TO:' : 'BILL TO:'}</h3>
                                    <p style="margin: 5px 0; font-size: 10pt;"><strong>${data.clientName || 'Client Name'}</strong></p>
                                    <p style="margin: 5px 0; font-size: 10pt;">${data.clientAddress || 'Client Address'}</p>
                                    ${data.clientTIN ? `<p style="margin: 5px 0; font-size: 10pt;"><strong>TIN:</strong> ${data.clientTIN}</p>` : ''}
                                    ${data.clientPhone ? `<p style="margin: 5px 0; font-size: 10pt;"><strong>Phone:</strong> ${data.clientPhone}</p>` : ''}
                                    ${data.clientEmail ? `<p style="margin: 5px 0; font-size: 10pt;"><strong>Email:</strong> ${data.clientEmail}</p>` : ''}
                                </div>
                                
                                <div style="flex: 1; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                    <h3 style="color: #116a41; margin: 0 0 10px 0; font-size: 12pt;">DOCUMENT DETAILS:</h3>
                                    <p style="margin: 5px 0; font-size: 10pt;"><strong>${isQuotation ? 'Quotation #:' : 'Invoice #:'}</strong> ${data.documentNumber || ''}</p>
                                    <p style="margin: 5px 0; font-size: 10pt;"><strong>${isQuotation ? 'Quotation Date:' : 'Invoice Date:'}</strong> ${this.formatDate(data.documentDate)}</p>
                                    <p style="margin: 5px 0; font-size: 10pt;"><strong>Due Date:</strong> ${this.formatDate(data.dueDate)}</p>
                                    <p style="margin: 5px 0; font-size: 10pt;"><strong>Delivery:</strong> ${data.deliveryTime || '7'} days after PO</p>
                                    <p style="margin: 5px 0; font-size: 10pt;"><strong>Payment Terms:</strong> ${data.paymentTerms || '100% after delivery'}</p>
                                </div>
                            </div>
                            
                            <div style="margin: 20px 0; padding-bottom: 10px; border-bottom: 1px solid #116a41;">
                                <h3 style="color: #116a41; margin: 0 0 5px 0; font-size: 12pt;">
                                    Subject: ${isQuotation ? 'Quotation for Electrical Services' : (data.type === 'Proforma' ? 'Proforma Invoice for Electrical Services' : 'Invoice for Electrical Services')}
                                </h3>
                                <p style="margin: 0; font-size: 10pt; color: #555; font-style: italic;">
                                    ${isQuotation ? 
                                        'Thank you for your inquiry. We are pleased to submit our quotation for the requested electrical services. All prices are inclusive of VAT where applicable and are valid for 30 days.' : 
                                        (data.type === 'Proforma' ? 
                                        'This proforma invoice is prepared for the services rendered. All prices are inclusive of VAT where applicable.' : 
                                        'This invoice is prepared for the services rendered. All prices are inclusive of VAT where applicable.')}
                                </p>
                            </div>
                            
                            <table style="width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 10pt;">
                                <thead>
                                    <tr style="background: #116a41; color: white;">
                                        <th style="padding: 8px; text-align: left; font-weight: bold;">DESCRIPTION</th>
                                        <th style="padding: 8px; text-align: center; font-weight: bold;">UNITS</th>
                                        <th style="padding: 8px; text-align: right; font-weight: bold;">UNIT PRICE</th>
                                        <th style="padding: 8px; text-align: right; font-weight: bold;">AMOUNT</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${this.generateItemsHTML(data.items || [], data.currency)}
                                </tbody>
                            </table>
                            
                            <div class="totals">
                                <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #ddd; font-size: 10pt;">
                                    <span>Subtotal:</span>
                                    <span>${this.formatCurrency(data.subtotal || 0, data.currency)}</span>
                                </div>
                                ${data.discount > 0 ? `
                                <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #ddd; font-size: 10pt;">
                                    <span>Discount:</span>
                                    <span>${this.formatCurrency(data.discount || 0, data.currency)}</span>
                                </div>
                                ` : ''}
                                <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #ddd; font-size: 10pt;">
                                    <span>VAT (18%):</span>
                                    <span>${this.formatCurrency(data.tax || 0, data.currency)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-top: 2px solid #116a41; margin-top: 10px; font-weight: bold; font-size: 11pt;">
                                    <span>${isQuotation ? 'TOTAL QUOTATION:' : 'GRAND TOTAL:'}</span>
                                    <span>${this.formatCurrency(data.grandTotal || 0, data.currency)}</span>
                                </div>
                                <div class="amount-words" style="font-size: 9pt;">
                                    <strong>Amount in Words:</strong> ${this.numberToWords(Math.round(data.grandTotal || 0))}
                                </div>
                            </div>
                            
                            <div style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 5px; font-size: 9pt;">
                                ${data.notes ? `<p style="margin: 0 0 10px 0; white-space: pre-line;">${data.notes}</p>` : ''}
                            </div>
                            
                            ${processedFooter}
                        </div>
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(() => window.close(), 1000);
                            };
                        <\/script>
                    </body>
                    </html>
                `;
                
                printWindow.document.write(documentHTML);
                printWindow.document.close();
            }
        }
        
        // Main Application
        document.addEventListener('DOMContentLoaded', function() {
            const docGenerator = new A4DocumentGenerator();
            
            // DOM Elements
            const invoiceForm = document.getElementById('invoice-form');
            const a4Preview = document.getElementById('a4-preview');
            const printContent = document.getElementById('print-content');
            const printBtn = document.getElementById('print-btn');
            const pdfBtn = document.getElementById('pdf-btn');
            const previewBtn = document.getElementById('preview-btn');
            const saveBtn = document.getElementById('save-btn');
            
            // Set default dates
            const today = new Date();
            document.getElementById('invoice-date').valueAsDate = today;
            
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            document.getElementById('due-date').valueAsDate = dueDate;
            
            // Initialize totals
            updateTotals();
            
            // Setup event listeners
            setupEventListeners();
            
            // Preview Functionality
            previewBtn.addEventListener('click', async function() {
                const formData = collectFormData();
                const template = docGenerator.createDocumentTemplate(formData);
                
                printContent.innerHTML = template;
                
                // Load header and footer
                const headerHTML = await docGenerator.getHeaderHTML();
                const footerHTML = await docGenerator.getFooterHTML();
                
                // Replace placeholders
                const isQuotation = formData.type === 'Quotation';
                const isStandard = formData.type === 'Standard';
                const documentType = isQuotation ? 'QUOTATION' : (isStandard ? 'TAX INVOICE' : 'PROFORMA INVOICE');
                
                let processedHeader = headerHTML
                    .replace('{{DOCUMENT_TYPE}}', documentType)
                    .replace('{{DOCUMENT_NUMBER}}', formData.documentNumber || '');
                
                let processedFooter = footerHTML
                    .replace('{{BANK_DETAILS}}', formData.bankDetails || '');
                
                // Insert header and footer
                document.getElementById('document-header').innerHTML = processedHeader;
                document.getElementById('document-footer').innerHTML = processedFooter;
                
                a4Preview.style.display = 'block';
                invoiceForm.style.display = 'none';
                
                // Show action buttons
                printBtn.style.display = 'inline-flex';
                pdfBtn.style.display = 'inline-flex';
                
                // Hide all other sections
                document.querySelectorAll('.history-container').forEach(container => {
                    container.style.display = 'none';
                });
            });
            
            // Print Functionality
            printBtn.addEventListener('click', async function() {
                const formData = collectFormData();
                await docGenerator.printDocument(formData);
            });
            
            // PDF Export
            pdfBtn.addEventListener('click', function() {
                const formData = collectFormData();
                const filename = `Kingu_${formData.type || 'Proforma'}_${formData.documentNumber || 'Document'}.pdf`;
                
                pdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
                pdfBtn.disabled = true;
                
                docGenerator.generatePDF(printContent, formData, filename)
                    .then(() => {
                        pdfBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Export PDF';
                        pdfBtn.disabled = false;
                    })
                    .catch(error => {
                        console.error('PDF generation error:', error);
                        pdfBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Export PDF';
                        pdfBtn.disabled = false;
                        alert('Error generating PDF. Please try again.');
                    });
            });
            
            // Save Functionality
            saveBtn.addEventListener('click', function() {
                const formData = collectFormData();
                
                // Save to localStorage
                let documents = JSON.parse(localStorage.getItem('kinguDocuments')) || [];
                documents.push({
                    ...formData,
                    id: Date.now(),
                    savedDate: new Date().toISOString()
                });
                localStorage.setItem('kinguDocuments', JSON.stringify(documents));
                
                // Generate PDF automatically
                const filename = `Kingu_${formData.type || 'Proforma'}_${formData.documentNumber || 'Document'}.pdf`;
                docGenerator.generatePDF(printContent, formData, filename);
                
                alert(`${formData.type || 'Document'} saved successfully!\nPDF has been generated and saved.`);
            });
            
            // Helper Functions
            function collectFormData() {
                const isProforma = document.getElementById('btn-proforma').classList.contains('active');
                const isStandard = document.getElementById('btn-standard').classList.contains('active');
                const isQuotation = document.getElementById('btn-quotation').classList.contains('quotation-active');
                
                return {
                    type: isQuotation ? 'Quotation' : (isProforma ? 'Proforma' : 'Standard'),
                    documentNumber: document.getElementById('invoice-number').value,
                    documentDate: document.getElementById('invoice-date').value,
                    dueDate: document.getElementById('due-date').value,
                    currency: document.getElementById('currency').value,
                    deliveryTime: document.getElementById('delivery-time').value,
                    clientName: document.getElementById('client-name').value,
                    clientEmail: document.getElementById('client-email').value,
                    clientPhone: document.getElementById('client-phone').value,
                    clientAddress: document.getElementById('client-address').value,
                    clientTIN: document.getElementById('client-tin').value,
                    clientVAT: document.getElementById('client-vat').value,
                    paymentTerms: document.getElementById('payment-terms').value,
                    bankDetails: document.getElementById('bank-details').value,
                    notes: document.getElementById('notes').value,
                    items: collectItems(),
                    subtotal: extractCurrencyValue(document.getElementById('subtotal').textContent),
                    discount: extractCurrencyValue(document.getElementById('discount-amount').textContent),
                    tax: extractCurrencyValue(document.getElementById('tax').textContent),
                    grandTotal: extractCurrencyValue(document.getElementById('grand-total').textContent)
                };
            }
            
            function collectItems() {
                const items = [];
                document.querySelectorAll('#invoice-items tr').forEach(row => {
                    items.push({
                        description: row.querySelector('.item-description').value,
                        quantity: parseFloat(row.querySelector('.item-quantity').value) || 0,
                        price: parseFloat(row.querySelector('.item-price').value) || 0,
                        total: extractCurrencyValue(row.querySelector('.item-total').textContent)
                    });
                });
                return items;
            }
            
            function extractCurrencyValue(formattedValue) {
                return parseFloat(formattedValue.replace(/[^0-9.-]+/g,"")) || 0;
            }
            
            function updateTotals() {
                let subtotal = 0;
                const rows = document.querySelectorAll('#invoice-items tr');
                
                rows.forEach(row => {
                    const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                    const price = parseFloat(row.querySelector('.item-price').value) || 0;
                    const total = quantity * price;
                    subtotal += total;
                    
                    const itemTotal = row.querySelector('.item-total');
                    if (itemTotal) {
                        itemTotal.textContent = formatCurrency(total, 'TSh');
                    }
                });
                
                // Apply discount
                const discountType = document.getElementById('discount-type').value;
                const discountValue = parseFloat(document.getElementById('discount-value').value) || 0;
                let discount = 0;
                
                if (discountType === 'percentage' && discountValue > 0) {
                    discount = subtotal * (discountValue / 100);
                } else if (discountType === 'fixed' && discountValue > 0) {
                    discount = discountValue;
                }
                
                const discountedSubtotal = subtotal - discount;
                const vat = discountedSubtotal * 0.18;
                const grandTotal = discountedSubtotal + vat;
                
                document.getElementById('subtotal').textContent = formatCurrency(subtotal, 'TSh');
                document.getElementById('discount-amount').textContent = formatCurrency(discount, 'TSh');
                document.getElementById('tax').textContent = formatCurrency(vat, 'TSh');
                document.getElementById('grand-total').textContent = formatCurrency(grandTotal, 'TSh');
                
                // Update amount in words
                document.getElementById('amount-words').textContent = docGenerator.numberToWords(Math.round(grandTotal));
                
                // Show/hide discount row
                const discountRow = document.getElementById('discount-row');
                if (discount > 0) {
                    discountRow.style.display = 'flex';
                } else {
                    discountRow.style.display = 'none';
                }
            }
            
            function formatCurrency(amount, currency) {
                const symbol = currency === 'TSh' ? 'TSh ' : 
                              currency === 'USD' ? '$' :
                              currency === 'EUR' ? '€' : '£';
                const formatted = parseFloat(amount).toFixed(2)
                    .replace(/\d(?=(\d{3})+\.)/g, '$&,');
                return symbol + formatted;
            }
            
            function setupEventListeners() {
                // Item input listeners
                document.querySelectorAll('.item-quantity, .item-price').forEach(input => {
                    input.addEventListener('input', updateTotals);
                });
                
                // Delete item buttons
                document.addEventListener('click', function(e) {
                    if (e.target.closest('.delete-item')) {
                        e.target.closest('tr').remove();
                        updateTotals();
                    }
                });
                
                // Add item button
                document.getElementById('add-item-btn').addEventListener('click', function() {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td><input type="text" class="item-description" placeholder="Service description" value="New service item"></td>
                        <td><input type="number" class="item-quantity" min="0" step="0.01" value="1.00"></td>
                        <td>
                            <div style="display: flex; align-items: center;">
                                <span class="currency-symbol" style="margin-right: 5px;">TSh</span>
                                <input type="number" class="item-price" min="0" step="0.01" value="0.00" style="flex: 1;">
                            </div>
                        </td>
                        <td class="item-total text-right">TSh 0.00</td>
                        <td class="text-center"><button class="delete-item"><i class="fas fa-trash"></i></button></td>
                    `;
                    
                    document.getElementById('invoice-items').appendChild(newRow);
                    
                    newRow.querySelector('.item-quantity').addEventListener('input', updateTotals);
                    newRow.querySelector('.item-price').addEventListener('input', updateTotals);
                    
                    updateTotals();
                });
                
                // Discount handling
                document.getElementById('discount-type').addEventListener('change', function() {
                    const discountValueContainer = document.getElementById('discount-value-container');
                    const discountRow = document.getElementById('discount-row');
                    
                    if (this.value === 'none') {
                        discountValueContainer.style.display = 'none';
                        discountRow.style.display = 'none';
                    } else {
                        discountValueContainer.style.display = 'block';
                        discountRow.style.display = 'flex';
                        document.getElementById('discount-label').textContent = 
                            this.value === 'percentage' ? 'Discount (%):' : 'Discount:';
                    }
                    updateTotals();
                });
                
                document.getElementById('discount-value').addEventListener('input', updateTotals);
                
                // Payment terms custom field
                document.getElementById('payment-terms').addEventListener('change', function() {
                    const customContainer = document.getElementById('custom-terms-container');
                    customContainer.style.display = this.value === 'Custom' ? 'block' : 'none';
                });
                
                // Generate invoice number
                document.getElementById('generate-number-btn').addEventListener('click', function() {
                    const isProforma = document.getElementById('btn-proforma').classList.contains('active');
                    const isStandard = document.getElementById('btn-standard').classList.contains('active');
                    const isQuotation = document.getElementById('btn-quotation').classList.contains('quotation-active');
                    
                    let prefix = 'PROFORMA';
                    if (isStandard) prefix = 'INV';
                    if (isQuotation) prefix = 'QUOTE';
                    
                    const year = new Date().getFullYear();
                    const month = (new Date().getMonth() + 1).toString().padStart(2, '0');
                    const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                    
                    document.getElementById('invoice-number').value = `${prefix}/GL/${month}/${year}/${randomNum}`;
                });
                
                // Clear form
                document.getElementById('clear-btn').addEventListener('click', function() {
                    if (confirm('Are you sure you want to clear the form? All entered data will be lost.')) {
                        invoiceForm.reset();
                        document.getElementById('invoice-items').innerHTML = `
                            <tr>
                                <td><input type="text" class="item-description" placeholder="Service description" value="Service item"></td>
                                <td><input type="number" class="item-quantity" min="0" step="0.01" value="1.00"></td>
                                <td>
                                    <div style="display: flex; align-items: center;">
                                        <span class="currency-symbol" style="margin-right: 5px;">TSh</span>
                                        <input type="number" class="item-price" min="0" step="0.01" value="0.00" style="flex: 1;">
                                    </div>
                                </td>
                                <td class="item-total text-right">TSh 0.00</td>
                                <td class="text-center"><button class="delete-item"><i class="fas fa-trash"></i></button></td>
                            </tr>
                        `;
                        
                        document.getElementById('invoice-date').valueAsDate = new Date();
                        const dueDate = new Date();
                        dueDate.setDate(dueDate.getDate() + 30);
                        document.getElementById('due-date').valueAsDate = dueDate;
                        
                        updateTotals();
                    }
                });
                
                // Load sample data
                document.getElementById('load-sample-btn').addEventListener('click', function() {
                    document.getElementById('invoice-number').value = 'PROFORMAGL/06/2025/001';
                    document.getElementById('client-name').value = 'GREENLIGHT PLANNET TANZANIA LTD';
                    document.getElementById('client-email').value = 'accounts@greenlight.co.tz';
                    document.getElementById('client-phone').value = '+255 765 432 100';
                    document.getElementById('client-address').value = 'ARUSHA, TANZANIA';
                    document.getElementById('client-tin').value = '109-628-980';
                    
                    alert('Sample data loaded!');
                });
            }
        });
    </script>
</body>
</html>
