<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KINGU ELECTRICAL COMPANY LIMITED - Invoice System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF Library for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --kingu-green: #116a41;        /* Primary green from "Kingu" text */
            --kingu-red: #e63946;          /* Red from "Electrical" text */
            --kingu-yellow-start: #ffae42; /* Light bulb gradient start */
            --kingu-yellow-end: #ffea00;   /* Light bulb gradient end */
            --kingu-dark: #0a4d2a;         /* Darker green for headers */
            --kingu-light: #e8f5e9;        /* Light green background */
            --kingu-accent: #ff6b35;       /* Orange for highlights */
            --kingu-success: #2a9d8f;      /* Green for success */
            --kingu-white: #ffffff;        /* White background */
        }

        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: linear-gradient(135deg, var(--kingu-green) 0%, var(--kingu-dark) 100%);
            color: white;
            padding: 25px 20px;
            box-shadow: 2px 0 15px rgba(17, 106, 65, 0.3);
        }

        .logo-container {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--kingu-yellow-start) 0%, var(--kingu-yellow-end) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }

        .logo:before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            background: white;
            border-radius: 50%;
            z-index: 1;
        }

        .logo i {
            font-size: 28px;
            color: var(--kingu-red);
            z-index: 2;
            position: relative;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .company-name-green {
            font-size: 20px;
            font-weight: 800;
            color: white;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .company-name-red {
            font-size: 16px;
            font-weight: 700;
            color: var(--kingu-red);
            margin-top: -2px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .company-full-name {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 2px;
            font-weight: 500;
        }

        .company-tagline {
            font-size: 11px;
            opacity: 0.9;
            margin-top: 5px;
            color: rgba(255, 255, 255, 0.9);
            font-style: italic;
            line-height: 1.3;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 5px;
        }

        .nav-menu {
            list-style: none;
            margin-top: 30px;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            color: white;
            text-decoration: none;
            padding: 12px 15px;
            border-radius: 8px;
            transition: all 0.3s;
            border-left: 3px solid transparent;
            cursor: pointer;
        }

        .nav-link i {
            margin-right: 12px;
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.15);
            border-left: 3px solid var(--kingu-red);
        }

        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-left: 3px solid var(--kingu-red);
            font-weight: 600;
        }

        /* Company Info in Sidebar */
        .company-info-sidebar {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 13px;
        }

        .company-info-sidebar p {
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
        }

        .company-info-sidebar i {
            margin-right: 10px;
            margin-top: 3px;
            color: var(--kingu-yellow-end);
            min-width: 16px;
        }

        .contact-badge {
            display: inline-block;
            background-color: var(--kingu-red);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            font-weight: bold;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background-color: var(--kingu-white);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--kingu-light);
        }

        .header h1 {
            color: var(--kingu-green);
            font-size: 28px;
            position: relative;
            padding-left: 15px;
        }

        .header h1:before {
            content: '';
            position: absolute;
            left: 0;
            top: 5px;
            bottom: 5px;
            width: 4px;
            background: linear-gradient(to bottom, var(--kingu-green), var(--kingu-red));
            border-radius: 2px;
        }

        /* Invoice Type Selector */
        .invoice-type-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(17, 106, 65, 0.1);
            border-left: 4px solid var(--kingu-green);
        }

        .type-btn {
            padding: 10px 25px;
            border: 2px solid var(--kingu-green);
            background: white;
            color: var(--kingu-green);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .type-btn.active {
            background: var(--kingu-green);
            color: white;
        }

        .type-btn:hover:not(.active) {
            background-color: var(--kingu-light);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background-color: var(--kingu-green);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--kingu-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(17, 106, 65, 0.2);
        }

        .btn-success {
            background-color: var(--kingu-success);
            color: white;
        }

        .btn-success:hover {
            background-color: #21867a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(42, 157, 143, 0.2);
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
            transform: translateY(-2px);
        }

        .btn-accent {
            background-color: var(--kingu-red);
            color: white;
        }

        .btn-accent:hover {
            background-color: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(230, 57, 70, 0.2);
        }

        .btn-whatsapp {
            background-color: #25D366;
            color: white;
        }

        .btn-whatsapp:hover {
            background-color: #128C7E;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.2);
        }

        .btn-pdf {
            background-color: #d32f2f;
            color: white;
        }

        .btn-pdf:hover {
            background-color: #b71c1c;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(211, 47, 47, 0.2);
        }

        .btn i {
            margin-right: 8px;
        }

        /* Invoice Form Container */
        .invoice-form-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(17, 106, 65, 0.1);
            padding: 30px;
            margin-bottom: 30px;
            border-top: 4px solid var(--kingu-green);
        }

        .form-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 18px;
            color: var(--kingu-green);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--kingu-light);
            display: flex;
            align-items: center;
        }

        .section-title i {
            margin-right: 10px;
            color: var(--kingu-red);
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -15px;
        }

        .form-group {
            flex: 1;
            min-width: 250px;
            padding: 0 15px;
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--kingu-dark);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--kingu-green);
            box-shadow: 0 0 0 3px rgba(17, 106, 65, 0.1);
        }

        /* Proforma Specific Fields */
        .proforma-fields {
            background-color: var(--kingu-light);
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid var(--kingu-red);
        }

        /* Invoice Items Table */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .items-table thead {
            background-color: var(--kingu-green);
        }

        .items-table th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: white;
            border-bottom: 2px solid var(--kingu-dark);
        }

        .items-table td {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        .items-table tr:hover {
            background-color: #f9fafb;
        }

        .items-table input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        .delete-item {
            background-color: var(--kingu-red);
            color: white;
            border: none;
            border-radius: 4px;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .delete-item:hover {
            background-color: #c62828;
            transform: scale(1.05);
        }

        .add-item-btn {
            margin-top: 15px;
            background-color: var(--kingu-light);
            color: var(--kingu-green);
            border: 2px dashed var(--kingu-green);
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            transition: all 0.3s;
        }

        .add-item-btn:hover {
            background-color: var(--kingu-green);
            color: white;
            border-color: var(--kingu-green);
        }

        .add-item-btn i {
            margin-right: 8px;
        }

        /* Totals Section */
        .totals-section {
            background: linear-gradient(135deg, #f8fafc 0%, var(--kingu-light) 100%);
            padding: 25px;
            border-radius: 8px;
            margin-top: 30px;
            border-left: 4px solid var(--kingu-green);
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(17, 106, 65, 0.1);
        }

        .total-label {
            font-weight: 600;
            color: var(--kingu-dark);
        }

        .total-value {
            font-weight: 700;
            color: var(--kingu-green);
        }

        .grand-total {
            font-size: 20px;
            border-top: 2px solid var(--kingu-green);
            margin-top: 10px;
            padding-top: 15px;
            color: var(--kingu-dark);
        }

        /* Invoice Preview */
        .invoice-preview-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(17, 106, 65, 0.1);
            padding: 40px;
            margin-top: 30px;
            display: none;
            border-top: 4px solid var(--kingu-green);
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--kingu-light);
        }

        .invoice-company-logo {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            max-width: 300px;
        }

        .company-logo-text {
            font-family: 'Georgia', serif;
        }

        .kingu-logo {
            font-size: 48px;
            font-weight: 900;
            color: var(--kingu-green);
            line-height: 0.9;
            margin-bottom: 5px;
        }

        .electrical-logo {
            font-size: 36px;
            font-weight: 700;
            color: var(--kingu-red);
            line-height: 0.9;
            margin-bottom: 8px;
            margin-left: 15px;
        }

        .company-logo {
            font-size: 20px;
            font-weight: 700;
            color: var(--kingu-dark);
            margin-bottom: 10px;
            border-top: 2px solid var(--kingu-light);
            padding-top: 10px;
            margin-top: 5px;
        }

        .tagline-logo {
            font-size: 14px;
            color: #666;
            font-style: italic;
            line-height: 1.4;
            margin-bottom: 15px;
        }

        .contact-info-logo {
            font-size: 13px;
            color: #555;
            line-height: 1.5;
        }

        .contact-info-logo .phone-numbers {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 5px 0;
        }

        .contact-info-logo .phone-numbers span {
            background-color: var(--kingu-light);
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid rgba(17, 106, 65, 0.2);
        }

        .contact-info-logo .email {
            color: var(--kingu-green);
            font-weight: 600;
        }

        .contact-info-logo .address {
            font-size: 12px;
            color: #777;
            margin-top: 5px;
        }

        .invoice-title {
            font-size: 32px;
            color: var(--kingu-green);
            text-align: right;
            font-weight: 700;
        }

        .invoice-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            gap: 30px;
        }

        .company-info, .client-info {
            flex: 1;
        }

        .info-title {
            font-weight: 700;
            color: var(--kingu-green);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--kingu-light);
            font-size: 16px;
        }

        .company-details p, .client-details p {
            margin-bottom: 8px;
            color: #555;
        }

        .invoice-info {
            flex: 0.8;
        }

        .invoice-info-box {
            background-color: var(--kingu-light);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid var(--kingu-green);
        }

        .invoice-info-box p {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .invoice-info-box strong {
            color: var(--kingu-dark);
        }

        .invoice-items-preview {
            width: 100%;
            border-collapse: collapse;
            margin: 30px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .invoice-items-preview thead {
            background-color: var(--kingu-green);
        }

        .invoice-items-preview th {
            padding: 18px;
            text-align: left;
            font-weight: 700;
            color: white;
            border-bottom: 3px solid var(--kingu-dark);
        }

        .invoice-items-preview td {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .invoice-items-preview tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }

        .invoice-totals {
            width: 350px;
            margin-left: auto;
            margin-top: 30px;
            background: var(--kingu-light);
            padding: 25px;
            border-radius: 8px;
            border-left: 4px solid var(--kingu-green);
        }

        .terms-section {
            background-color: #f8fafc;
            padding: 25px;
            border-radius: 8px;
            margin-top: 40px;
            border-left: 4px solid var(--kingu-red);
        }

        .terms-title {
            color: var(--kingu-green);
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .terms-title i {
            margin-right: 10px;
            color: var(--kingu-red);
        }

        .terms-content p {
            margin-bottom: 10px;
            color: #555;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }

        /* Contact Badges */
        .contact-badges {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .contact-badge-small {
            display: inline-flex;
            align-items: center;
            background-color: var(--kingu-light);
            color: var(--kingu-green);
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 600;
            border: 1px solid rgba(17, 106, 65, 0.2);
        }

        .contact-badge-small i {
            margin-right: 5px;
            font-size: 14px;
        }

        .whatsapp-badge {
            background-color: rgba(37, 211, 102, 0.1);
            color: #128C7E;
            border-color: rgba(37, 211, 102, 0.3);
        }

        .email-badge {
            background-color: rgba(66, 133, 244, 0.1);
            color: #4285f4;
            border-color: rgba(66, 133, 244, 0.3);
        }

        /* Footer Styles */
        .invoice-footer {
            margin-top: 60px;
            padding-top: 30px;
            border-top: 2px solid var(--kingu-light);
            text-align: center;
        }

        .footer-logo {
            margin-bottom: 20px;
        }

        .kingu-symbol {
            font-size: 48px;
            font-weight: bold;
            color: var(--kingu-green);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .kingu-symbol .in-symbol {
            color: var(--kingu-red);
            font-size: 36px;
        }

        .kingu-symbol .yen-symbol {
            color: var(--kingu-yellow-end);
            font-size: 40px;
        }

        .kingu-symbol .four-symbol {
            color: var(--kingu-green);
            font-size: 44px;
            background: linear-gradient(135deg, var(--kingu-yellow-start) 0%, var(--kingu-yellow-end) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }

        .footer-company-name {
            font-size: 28px;
            font-weight: 800;
            color: var(--kingu-green);
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .footer-electrical {
            font-size: 24px;
            font-weight: 700;
            color: var(--kingu-red);
            margin-bottom: 10px;
        }

        .footer-tagline {
            font-size: 16px;
            color: #666;
            font-style: italic;
            margin-bottom: 30px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .footer-contact {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed #ddd;
        }

        .footer-contact-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #555;
        }

        .footer-contact-item i {
            color: var(--kingu-green);
        }

        .authorized-signature {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .signature-line {
            width: 300px;
            height: 1px;
            background-color: #333;
            margin: 40px auto 10px;
        }

        .signature-text {
            font-size: 14px;
            color: #666;
            text-align: center;
        }

        /* Utility Classes */
        .hidden {
            display: none;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .currency-select {
            width: 120px;
            margin-right: 10px;
            border: 1px solid var(--kingu-green);
        }

        .stamp {
            position: absolute;
            right: 40px;
            bottom: 40px;
            padding: 15px 30px;
            background-color: var(--kingu-light);
            border: 2px dashed var(--kingu-green);
            border-radius: 8px;
            text-align: center;
            font-weight: 700;
            color: var(--kingu-green);
            transform: rotate(5deg);
        }

        .color-scheme {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .color-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .green { background-color: var(--kingu-green); }
        .red { background-color: var(--kingu-red); }
        .yellow-start { background-color: var(--kingu-yellow-start); }
        .yellow-end { background-color: var(--kingu-yellow-end); }

        /* Invoice History & Proforma Invoices Styles */
        .history-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(17, 106, 65, 0.1);
            padding: 30px;
            margin-top: 20px;
            border-top: 4px solid var(--kingu-green);
            display: none;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .history-table th {
            background-color: var(--kingu-green);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .history-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        .history-table tr:hover {
            background-color: #f9fafb;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-paid {
            background-color: rgba(46, 204, 113, 0.2);
            color: #27ae60;
        }

        .status-pending {
            background-color: rgba(241, 196, 15, 0.2);
            color: #f39c12;
        }

        .status-overdue {
            background-color: rgba(231, 76, 60, 0.2);
            color: #c0392b;
        }

        .status-quotation {
            background-color: rgba(52, 152, 219, 0.2);
            color: #2980b9;
        }

        .action-btn-small {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-right: 5px;
        }

        .action-btn-small:hover {
            transform: translateY(-1px);
        }

        /* Quotation Specific Styles */
        .quotation-stamp {
            position: absolute;
            right: 40px;
            top: 40px;
            padding: 15px 30px;
            background-color: rgba(52, 152, 219, 0.1);
            border: 2px dashed #2980b9;
            border-radius: 8px;
            text-align: center;
            font-weight: 700;
            color: #2980b9;
            transform: rotate(5deg);
        }

        @media print {
            .sidebar, .header, .invoice-form-container, .action-buttons, .invoice-type-selector {
                display: none !important;
            }
            
            .invoice-preview-container {
                display: block !important;
                box-shadow: none;
                padding: 20px;
                margin: 0;
            }
            
            body {
                background-color: white;
                font-size: 12px;
            }
            
            .stamp, .quotation-stamp {
                display: block !important;
            }
            
            .invoice-footer {
                page-break-inside: avoid;
            }
        }

        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .invoice-details {
                flex-direction: column;
                gap: 20px;
            }
            
            .invoice-totals {
                width: 100%;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .action-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .footer-contact {
                flex-direction: column;
                gap: 15px;
            }
            
            .kingu-symbol {
                font-size: 36px;
            }
            
            .footer-company-name {
                font-size: 22px;
            }
            
            .footer-electrical {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo-container">
                <div class="logo">
                    <i class="fas fa-bolt"></i>
                </div>
                <div class="logo-text">
                    <div class="company-name-green">KINGU</div>
                    <div class="company-name-red">ELECTRICAL</div>
                    <div class="company-full-name">COMPANY LIMITED</div>
                    <div class="company-tagline">Quality Electrical Services with Professional Experience</div>
                </div>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" id="nav-create">
                        <i class="fas fa-file-invoice-dollar"></i> Create Invoice
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="nav-proforma">
                        <i class="fas fa-file-contract"></i> Proforma Invoices
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="nav-history">
                        <i class="fas fa-history"></i> Invoice History
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="nav-clients">
                        <i class="fas fa-users"></i> Clients
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="nav-reports">
                        <i class="fas fa-chart-bar"></i> Reports
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="nav-settings">
                        <i class="fas fa-cog"></i> Settings
                    </a>
                </li>
            </ul>
            
            <div class="company-info-sidebar">
                <p><i class="fas fa-map-marker-alt"></i> <span>Plot 123, Industrial Area<br>Dar es Salaam, Tanzania</span></p>
                <p><i class="fas fa-phone"></i> +255 682 843 552 <span class="contact-badge">CALL</span></p>
                <p><i class="fab fa-whatsapp"></i> +255 682 843 552 <span class="contact-badge">WHATSAPP</span></p>
                <p><i class="fas fa-envelope"></i> Kinguelectricaltz@gmail.com</p>
                <p><i class="fas fa-globe"></i> www.kinguelectrical.com</p>
                <p><i class="fas fa-university"></i> STANBIC BANK<br>912 000 275 9274</p>
                
                <div class="contact-badges">
                    <span class="contact-badge-small">
                        <i class="fas fa-phone"></i> Call Us
                    </span>
                    <span class="contact-badge-small whatsapp-badge">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </span>
                    <span class="contact-badge-small email-badge">
                        <i class="fas fa-envelope"></i> Email
                    </span>
                </div>
                
                <div class="color-scheme">
                    <div class="color-box green" title="Kingu Green: #116a41"></div>
                    <div class="color-box red" title="Electrical Red: #e63946"></div>
                    <div class="color-box yellow-start" title="Light Bulb Start: #ffae42"></div>
                    <div class="color-box yellow-end" title="Light Bulb End: #ffea00"></div>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <div class="header">
                <h1 id="page-title">Create Proforma Invoice</h1>
                <div>
                    <button class="btn btn-whatsapp" id="whatsapp-btn" style="margin-right: 10px;">
                        <i class="fab fa-whatsapp"></i> Share Invoice
                    </button>
                    <button class="btn btn-pdf" id="pdf-btn" style="display: none; margin-right: 10px;">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                    <button class="btn btn-accent" id="load-sample-btn">
                        <i class="fas fa-file-import"></i> Load Sample
                    </button>
                    <button class="btn btn-secondary" id="print-btn" style="display: none;">
                        <i class="fas fa-print"></i> Print Invoice
                    </button>
                </div>
            </div>
            
            <div class="invoice-type-selector">
                <button class="type-btn active" id="btn-proforma">Proforma Invoice</button>
                <button class="type-btn" id="btn-standard">Standard Invoice</button>
                <button class="type-btn" id="btn-quotation">Quotation</button>
            </div>
            
            <!-- Invoice Form -->
            <div id="invoice-form" class="invoice-form-container">
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-info-circle"></i> Invoice Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="invoice-number">Invoice Number</label>
                            <input type="text" id="invoice-number" class="form-control" value="PROFORMA/GL/06/2025/001">
                        </div>
                        <div class="form-group">
                            <label for="invoice-date">Invoice Date</label>
                            <input type="date" id="invoice-date" class="form-control" value="">
                        </div>
                        <div class="form-group">
                            <label for="validity-days">Validity Period (Days)</label>
                            <input type="number" id="validity-days" class="form-control" value="30" min="1">
                        </div>
                    </div>
                    
                    <div class="proforma-fields">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="currency">Currency</label>
                                <select id="currency" class="form-control currency-select">
                                    <option value="TSh">Tanzanian Shilling (TSh)</option>
                                    <option value="USD">US Dollar ($)</option>
                                    <option value="EUR">Euro (€)</option>
                                    <option value="GBP">British Pound (£)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="delivery-time">Delivery Time (Days after PO)</label>
                                <input type="number" id="delivery-time" class="form-control" value="7" min="1">
                            </div>
                            <div class="form-group">
                                <label for="payment-terms">Payment Terms</label>
                                <select id="payment-terms" class="form-control">
                                    <option value="100% after delivery">100% after delivery</option>
                                    <option value="50% advance, 50% after delivery">50% advance, 50% after delivery</option>
                                    <option value="30 days net">30 days net</option>
                                    <option value="Custom">Custom</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-user-tie"></i> Client Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="client-name">Client Name</label>
                            <input type="text" id="client-name" class="form-control" placeholder="Enter client name" value="GREENLIGHT PLANNET TANZANIA LTD">
                        </div>
                        <div class="form-group">
                            <label for="client-email">Client Email</label>
                            <input type="email" id="client-email" class="form-control" placeholder="Enter client email" value="accounts@greenlight.co.tz">
                        </div>
                        <div class="form-group">
                            <label for="client-phone">Client Phone</label>
                            <input type="text" id="client-phone" class="form-control" placeholder="Enter client phone" value="+255 765 432 100">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="client-address">Client Address</label>
                            <textarea id="client-address" class="form-control" rows="2" placeholder="Enter client address">ARUSHA, TANZANIA</textarea>
                        </div>
                        <div class="form-group">
                            <label for="client-tin">TIN Number</label>
                            <input type="text" id="client-tin" class="form-control" placeholder="Enter TIN number" value="109-628-980">
                        </div>
                        <div class="form-group">
                            <label for="client-vat">VAT Number (if applicable)</label>
                            <input type="text" id="client-vat" class="form-control" placeholder="Enter VAT number">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-list-alt"></i> Invoice Items</h3>
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>DESCRIPTION</th>
                                <th style="width: 100px;">UNITS</th>
                                <th style="width: 150px;">UNIT PRICE</th>
                                <th style="width: 150px;">AMOUNT</th>
                                <th style="width: 80px;">ACTION</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-items">
                            <tr>
                                <td><input type="text" class="item-description" placeholder="Service description" value="Engine service and Preventive maintenance"></td>
                                <td><input type="number" class="item-quantity" min="0" step="0.01" value="1.00"></td>
                                <td>
                                    <div style="display: flex; align-items: center;">
                                        <span class="currency-symbol" style="margin-right: 5px;">TSh</span>
                                        <input type="number" class="item-price" min="0" step="0.01" value="350000.00" style="flex: 1;">
                                    </div>
                                </td>
                                <td class="item-total text-right">TSh 350,000.00</td>
                                <td class="text-center"><button class="delete-item"><i class="fas fa-trash"></i></button></td>
                            </tr>
                            <tr>
                                <td><input type="text" class="item-description" placeholder="Service description" value="PLC check and configuration"></td>
                                <td><input type="number" class="item-quantity" min="0" step="0.01" value="1.00"></td>
                                <td>
                                    <div style="display: flex; align-items: center;">
                                        <span class="currency-symbol" style="margin-right: 5px;">TSh</span>
                                        <input type="number" class="item-price" min="0" step="0.01" value="250000.00" style="flex: 1;">
                                    </div>
                                </td>
                                <td class="item-total text-right">TSh 250,000.00</td>
                                <td class="text-center"><button class="delete-item"><i class="fas fa-trash"></i></button></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <button class="add-item-btn" id="add-item-btn">
                        <i class="fas fa-plus-circle"></i> Add Item
                    </button>
                </div>
                
                <div class="totals-section">
                    <div class="total-row">
                        <span class="total-label">Subtotal:</span>
                        <span class="total-value" id="subtotal">TSh 600,000.00</span>
                    </div>
                    <div class="total-row">
                        <span class="total-label">VAT (18%):</span>
                        <span class="total-value" id="tax">TSh 108,000.00</span>
                    </div>
                    <div class="total-row grand-total">
                        <span class="total-label">GRAND TOTAL:</span>
                        <span class="total-value" id="grand-total">TSh 708,000.00</span>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-file-signature"></i> Terms & Conditions</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bank-details">Bank Details</label>
                            <textarea id="bank-details" class="form-control" rows="3">BANK: STANBIC BANK TANZANIA LIMITED
ACCOUNT NAME: KINGU ELECTRICAL COMPANY LIMITED
ACCOUNT NUMBER: 912 000 275 9274
SWIFT CODE: SBICTZTX</textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="notes">Additional Notes / Special Instructions</label>
                            <textarea id="notes" class="form-control" rows="4" placeholder="Add any additional notes here...">1. This Proforma shall remain valid for 30 days only.
2. Prices are inclusive of VAT where applicable.
3. Delivery subject to stock availability.
4. All disputes subject to Dar es Salaam jurisdiction.</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="clear-btn">
                        <i class="fas fa-redo"></i> Clear Form
                    </button>
                    <button class="btn btn-success" id="preview-btn">
                        <i class="fas fa-eye"></i> Preview Invoice
                    </button>
                    <button class="btn btn-primary" id="save-btn">
                        <i class="fas fa-save"></i> Save Proforma
                    </button>
                </div>
            </div>
            
            <!-- Invoice Preview -->
            <div id="invoice-preview" class="invoice-preview-container">
                <div class="stamp" style="display: none;">PROFORMA INVOICE</div>
                <div class="quotation-stamp" style="display: none;">QUOTATION</div>
                
                <div class="invoice-header">
                    <div class="invoice-company-logo">
                        <div class="company-logo-text">
                            <div class="kingu-logo">Kingu</div>
                            <div class="electrical-logo">Electrical</div>
                            <div class="company-logo">Company Ltd</div>
                            <div class="tagline-logo">Quality Electrical Services with Professional Experience</div>
                            <div class="contact-info-logo">
                                <div class="phone-numbers">
                                    <span>+255 677 01 47 40</span>
                                    <span>+255 763 95 79 08</span>
                                    <span>+255 682 84 35 52</span>
                                </div>
                                <div class="email">kinguelectricaltz@gmail.com</div>
                                <div class="address">P.O. Box 62313, Dar Es Salaam Tanzania.</div>
                            </div>
                        </div>
                    </div>
                    <div class="invoice-title" id="preview-invoice-type">PROFORMA INVOICE</div>
                </div>
                
                <div class="invoice-details">
                    <div class="client-info">
                        <div class="info-title">TO:</div>
                        <div class="client-details">
                            <p id="preview-client-name"><strong>GREENLIGHT PLANNET TANZANIA LTD</strong></p>
                            <p id="preview-client-address">ARUSHA, TANZANIA</p>
                            <p id="preview-client-tin">TIN Number: 109-628-980</p>
                            <p id="preview-client-vat"></p>
                            <p id="preview-client-phone">Phone: +255 765 432 100</p>
                            <p id="preview-client-email">Email: accounts@greenlight.co.tz</p>
                        </div>
                    </div>
                    
                    <div class="invoice-info">
                        <div class="info-title" id="preview-details-title">INVOICE DETAILS:</div>
                        <div class="invoice-info-box">
                            <p><strong id="preview-doc-number">Invoice #:</strong> <span id="preview-invoice-number">PROFORMA/GL/06/2025/001</span></p>
                            <p><strong>Date:</strong> <span id="preview-invoice-date">June 15, 2025</span></p>
                            <p><strong>Validity:</strong> <span id="preview-validity">30 days</span></p>
                            <p><strong>Delivery:</strong> <span id="preview-delivery-time">7 days after PO</span></p>
                            <p><strong>Payment Terms:</strong> <span id="preview-payment-terms">100% after delivery</span></p>
                        </div>
                    </div>
                </div>
                
                <div style="margin: 30px 0; padding: 20px; background-color: var(--kingu-light); border-radius: 8px; border-left: 4px solid var(--kingu-green);">
                    <h3 style="color: var(--kingu-green); margin-bottom: 15px;" id="preview-subject">Subject: Quotation for Electrical Services</h3>
                    <p id="preview-quotation-text" style="color: #555; line-height: 1.6;">
                        Dear Sir/Madam,<br><br>
                        Thank you for your inquiry. We are pleased to submit our quotation for the requested electrical services. 
                        All prices are inclusive of VAT where applicable and are valid for <span id="preview-validity-text">30 days</span>.
                    </p>
                </div>
                
                <table class="invoice-items-preview">
                    <thead>
                        <tr>
                            <th>DESCRIPTION</th>
                            <th>UNITS</th>
                            <th>UNIT PRICE</th>
                            <th>AMOUNT</th>
                        </tr>
                    </thead>
                    <tbody id="preview-items">
                        <!-- Items will be added here dynamically -->
                    </tbody>
                </table>
                
                <div class="invoice-totals">
                    <div class="total-row">
                        <span class="total-label">Subtotal:</span>
                        <span class="total-value" id="preview-subtotal">TSh 600,000.00</span>
                    </div>
                    <div class="total-row">
                        <span class="total-label">VAT (18%):</span>
                        <span class="total-value" id="preview-tax">TSh 108,000.00</span>
                    </div>
                    <div class="total-row grand-total">
                        <span class="total-label">TOTAL QUOTATION:</span>
                        <span class="total-value" id="preview-grand-total">TSh 708,000.00</span>
                    </div>
                </div>
                
                <div class="terms-section">
                    <div class="terms-title"><i class="fas fa-file-contract"></i> TERMS & CONDITIONS</div>
                    <div class="terms-content">
                        <p><strong>Bank Details:</strong> <span id="preview-bank-details">STANBIC BANK TANZANIA LIMITED, ACCOUNT: 912 000 275 9274</span></p>
                        <p id="preview-notes">This quotation shall remain valid for 30 days only. Prices are inclusive of VAT where applicable. Delivery subject to stock availability.</p>
                        <div class="contact-badges" style="margin-top: 15px;">
                            <span class="contact-badge-small">
                                <i class="fas fa-phone"></i> +255 682 843 552
                            </span>
                            <span class="contact-badge-small whatsapp-badge">
                                <i class="fab fa-whatsapp"></i> +255 682 843 552
                            </span>
                            <span class="contact-badge-small email-badge">
                                <i class="fas fa-envelope"></i> Kinguelectricaltz@gmail.com
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Footer with Kingu Electrical Logo -->
                <div class="invoice-footer">
                    <div class="authorized-signature">
                        <div class="signature-line"></div>
                        <div class="signature-text">Authorized Signature & Company Stamp</div>
                        <div style="margin-top: 30px; font-size: 14px; color: #666; text-align: center;">
                            <p>Thank you for considering our quotation. We look forward to the opportunity to serve you.</p>
                            <p style="margin-top: 10px;"><em>This is a computer-generated quotation. No signature is required.</em></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Proforma Invoices Section -->
            <div id="proforma-invoices" class="history-container">
                <h2 style="color: var(--kingu-green); margin-bottom: 20px; display: flex; align-items: center;">
                    <i class="fas fa-file-contract" style="margin-right: 10px;"></i> Proforma Invoices
                </h2>
                <div id="proforma-list">
                    <p>Loading proforma invoices...</p>
                </div>
            </div>
            
            <!-- Invoice History Section -->
            <div id="invoice-history" class="history-container">
                <h2 style="color: var(--kingu-green); margin-bottom: 20px; display: flex; align-items: center;">
                    <i class="fas fa-history" style="margin-right: 10px;"></i> Invoice History
                </h2>
                <div id="history-list">
                    <p>Loading invoice history...</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        
        // Company details
        const COMPANY_NAME = "KINGU ELECTRICAL COMPANY LIMITED";
        const COMPANY_EMAIL = "kinguelectricaltz@gmail.com";
        const COMPANY_PHONE = "+255 682 84 35 52";
        const COMPANY_TAGLINE = "Quality Electrical Services with Professional Experience";
        const COMPANY_ADDRESS = "P.O. Box 62313, Dar Es Salaam Tanzania.";
        
        // DOM Elements
        let invoiceForm, invoicePreview, pageTitle, printBtn, pdfBtn, whatsappBtn;
        let invoiceItems, previewItems;
        let proformaInvoicesContainer, invoiceHistoryContainer, proformaList, historyList;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Get DOM elements
            invoiceForm = document.getElementById('invoice-form');
            invoicePreview = document.getElementById('invoice-preview');
            pageTitle = document.getElementById('page-title');
            printBtn = document.getElementById('print-btn');
            pdfBtn = document.getElementById('pdf-btn');
            whatsappBtn = document.getElementById('whatsapp-btn');
            invoiceItems = document.getElementById('invoice-items');
            previewItems = document.getElementById('preview-items');
            
            // History sections
            proformaInvoicesContainer = document.getElementById('proforma-invoices');
            invoiceHistoryContainer = document.getElementById('invoice-history');
            proformaList = document.getElementById('proforma-list');
            historyList = document.getElementById('history-list');
            
            // Set default dates
            const today = new Date();
            document.getElementById('invoice-date').valueAsDate = today;
            
            // Initialize totals
            updateTotals();
            
            // Event Listeners
            setupEventListeners();
            
            // Setup navigation
            setupNavigation();
            
            // Load saved invoices
            loadSavedInvoices();
        });
        
        // Setup all event listeners
        function setupEventListeners() {
            // Item input listeners
            document.querySelectorAll('.item-quantity, .item-price').forEach(input => {
                input.addEventListener('input', updateTotals);
            });
            
            // Form input listeners for preview updates
            const formInputs = [
                'invoice-number', 'invoice-date', 'validity-days',
                'client-name', 'client-address', 'client-tin', 'client-vat',
                'client-phone', 'client-email', 'payment-terms',
                'bank-details', 'delivery-time', 'notes', 'currency'
            ];
            
            formInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updatePreview);
                }
            });
            
            // Currency change listener
            document.getElementById('currency').addEventListener('change', function() {
                updateCurrencySymbol();
                updateTotals();
                updatePreview();
            });
            
            // Invoice type buttons
            document.getElementById('btn-proforma').addEventListener('click', () => setInvoiceType('proforma'));
            document.getElementById('btn-standard').addEventListener('click', () => setInvoiceType('standard'));
            document.getElementById('btn-quotation').addEventListener('click', () => setInvoiceType('quotation'));
            
            // Action buttons
            document.getElementById('add-item-btn').addEventListener('click', addNewItem);
            document.getElementById('clear-btn').addEventListener('click', clearForm);
            document.getElementById('preview-btn').addEventListener('click', generateInvoice);
            document.getElementById('save-btn').addEventListener('click', saveInvoice);
            document.getElementById('load-sample-btn').addEventListener('click', loadSampleProforma);
            printBtn.addEventListener('click', printInvoice);
            pdfBtn.addEventListener('click', exportToPDF);
            whatsappBtn.addEventListener('click', sendWhatsApp);
            
            // Delete item buttons (delegated event)
            document.addEventListener('click', function(e) {
                if (e.target.closest('.delete-item')) {
                    deleteItem(e.target.closest('.delete-item'));
                }
            });
            
            // Initialize currency symbol
            updateCurrencySymbol();
        }
        
        // Set invoice type
        function setInvoiceType(type) {
            const buttons = ['btn-proforma', 'btn-standard', 'btn-quotation'];
            buttons.forEach(btn => document.getElementById(btn).classList.remove('active'));
            
            const proformaFields = document.querySelector('.proforma-fields');
            const previewTitle = document.getElementById('preview-invoice-type');
            const saveBtn = document.getElementById('save-btn');
            const pageTitle = document.getElementById('page-title');
            
            let invoicePrefix = '';
            let displayTitle = '';
            let previewType = '';
            let saveBtnText = '';
            
            switch(type) {
                case 'proforma':
                    document.getElementById('btn-proforma').classList.add('active');
                    proformaFields.style.display = 'block';
                    invoicePrefix = 'PROFORMA';
                    displayTitle = 'Create Proforma Invoice';
                    previewType = 'PROFORMA INVOICE';
                    saveBtnText = 'Save Proforma';
                    break;
                case 'standard':
                    document.getElementById('btn-standard').classList.add('active');
                    proformaFields.style.display = 'none';
                    invoicePrefix = 'INV';
                    displayTitle = 'Create Standard Invoice';
                    previewType = 'TAX INVOICE';
                    saveBtnText = 'Save Invoice';
                    break;
                case 'quotation':
                    document.getElementById('btn-quotation').classList.add('active');
                    proformaFields.style.display = 'block';
                    invoicePrefix = 'QUOTE';
                    displayTitle = 'Create Quotation';
                    previewType = 'QUOTATION';
                    saveBtnText = 'Save Quotation';
                    break;
            }
            
            pageTitle.textContent = displayTitle;
            previewTitle.textContent = previewType;
            saveBtn.innerHTML = `<i class="fas fa-save"></i> ${saveBtnText}`;
            
            // Update invoice number
            const year = new Date().getFullYear();
            const month = (new Date().getMonth() + 1).toString().padStart(2, '0');
            const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            document.getElementById('invoice-number').value = `${invoicePrefix}/GL/${month}/${year}/${randomNum}`;
            
            // Update preview if visible
            if (invoicePreview.style.display === 'block') {
                updatePreview();
            }
        }
        
        // Update currency symbol in item rows
        function updateCurrencySymbol() {
            const currency = document.getElementById('currency').value;
            const symbol = currency === 'TSh' ? 'TSh' : 
                          currency === 'USD' ? '$' :
                          currency === 'EUR' ? '€' : '£';
            
            document.querySelectorAll('.currency-symbol').forEach(symbolElement => {
                symbolElement.textContent = symbol;
            });
        }
        
        // Format date
        function formatDate(dateString) {
            if (!dateString) return '';
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('en-US', options);
        }
        
        // Format date for table display
        function formatDateShort(dateString) {
            if (!dateString) return '';
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('en-US', options);
        }
        
        // Format currency with thousand separators
        function formatCurrency(amount, currency) {
            const symbol = currency === 'TSh' ? 'TSh ' : 
                          currency === 'USD' ? '$' :
                          currency === 'EUR' ? '€' : '£';
            
            const formattedAmount = parseFloat(amount).toFixed(2)
                .replace(/\d(?=(\d{3})+\.)/g, '$&,');
            
            return symbol + (currency === 'TSh' ? '' : ' ') + formattedAmount;
        }
        
        // Extract numeric value from formatted currency
        function extractCurrencyValue(formattedValue) {
            return parseFloat(formattedValue.replace(/[^0-9.-]+/g,"")) || 0;
        }
        
        // Calculate and update totals
        function updateTotals() {
            let subtotal = 0;
            const currency = document.getElementById('currency').value;
            const rows = document.querySelectorAll('#invoice-items tr');
            
            rows.forEach(row => {
                const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const total = quantity * price;
                
                row.querySelector('.item-total').textContent = formatCurrency(total, currency);
                subtotal += total;
            });
            
            // VAT/Tax calculation (Tanzania VAT is 18%)
            const vatRate = 0.18;
            const vat = subtotal * vatRate;
            const grandTotal = subtotal + vat;
            
            document.getElementById('subtotal').textContent = formatCurrency(subtotal, currency);
            document.getElementById('tax').textContent = formatCurrency(vat, currency);
            document.getElementById('grand-total').textContent = formatCurrency(grandTotal, currency);
            
            // Update preview if visible
            if (invoicePreview.style.display === 'block') {
                updatePreview();
            }
        }
        
        // Add new item row
        function addNewItem() {
            const currency = document.getElementById('currency').value;
            const symbol = currency === 'TSh' ? 'TSh' : 
                          currency === 'USD' ? '$' :
                          currency === 'EUR' ? '€' : '£';
            
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" class="item-description" placeholder="Service description" value="New service item"></td>
                <td><input type="number" class="item-quantity" min="0" step="0.01" value="1.00"></td>
                <td>
                    <div style="display: flex; align-items: center;">
                        <span class="currency-symbol" style="margin-right: 5px;">${symbol}</span>
                        <input type="number" class="item-price" min="0" step="0.01" value="0.00" style="flex: 1;">
                    </div>
                </td>
                <td class="item-total text-right">${formatCurrency(0, currency)}</td>
                <td class="text-center"><button class="delete-item"><i class="fas fa-trash"></i></button></td>
            `;
            
            invoiceItems.appendChild(newRow);
            
            // Add event listeners
            newRow.querySelector('.item-quantity').addEventListener('input', updateTotals);
            newRow.querySelector('.item-price').addEventListener('input', updateTotals);
            
            updateTotals();
        }
        
        // Delete item row
        function deleteItem(button) {
            const row = button.closest('tr');
            row.remove();
            updateTotals();
        }
        
        // Generate invoice preview
        function generateInvoice() {
            updatePreview();
            
            invoiceForm.style.display = 'none';
            invoicePreview.style.display = 'block';
            printBtn.style.display = 'inline-flex';
            pdfBtn.style.display = 'inline-flex';
            whatsappBtn.style.display = 'inline-flex';
            
            // Hide history sections
            proformaInvoicesContainer.style.display = 'none';
            invoiceHistoryContainer.style.display = 'none';
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        }
        
        // Update preview with form data
        function updatePreview() {
            const isQuotation = document.getElementById('btn-quotation').classList.contains('active');
            const currency = document.getElementById('currency').value;
            
            // Update stamps visibility
            document.querySelector('.stamp').style.display = isQuotation ? 'none' : 'block';
            document.querySelector('.quotation-stamp').style.display = isQuotation ? 'block' : 'none';
            
            // Update titles for quotation
            if (isQuotation) {
                document.getElementById('preview-details-title').textContent = 'QUOTATION DETAILS:';
                document.getElementById('preview-doc-number').textContent = 'Quotation #:';
                document.getElementById('preview-subject').textContent = 'Subject: Quotation for Electrical Services';
                document.getElementById('preview-quotation-text').innerHTML = `
                    Dear Sir/Madam,<br><br>
                    Thank you for your inquiry. We are pleased to submit our quotation for the requested electrical services. 
                    All prices are inclusive of VAT where applicable and are valid for <span id="preview-validity-text">${document.getElementById('validity-days').value || '30'} days</span>.
                `;
                document.querySelector('.grand-total .total-label').textContent = 'TOTAL QUOTATION:';
            } else {
                document.getElementById('preview-details-title').textContent = 'INVOICE DETAILS:';
                document.getElementById('preview-doc-number').textContent = document.getElementById('btn-proforma').classList.contains('active') ? 'Proforma #:' : 'Invoice #:';
                document.getElementById('preview-subject').textContent = document.getElementById('btn-proforma').classList.contains('active') ? 'Subject: Proforma Invoice for Electrical Services' : 'Subject: Invoice for Electrical Services';
                document.getElementById('preview-quotation-text').innerHTML = `
                    ${document.getElementById('btn-proforma').classList.contains('active') ? 'PROFORMA INVOICE' : 'TAX INVOICE'}<br><br>
                    This ${document.getElementById('btn-proforma').classList.contains('active') ? 'proforma invoice' : 'invoice'} is prepared for the services rendered. 
                    All prices are inclusive of VAT where applicable.
                `;
                document.querySelector('.grand-total .total-label').textContent = 'GRAND TOTAL:';
            }
            
            // Update client info
            document.getElementById('preview-client-name').innerHTML = `<strong>${document.getElementById('client-name').value || 'Client Name'}</strong>`;
            document.getElementById('preview-client-address').textContent = document.getElementById('client-address').value || 'Client Address';
            document.getElementById('preview-client-tin').textContent = document.getElementById('client-tin').value ? `TIN Number: ${document.getElementById('client-tin').value}` : '';
            document.getElementById('preview-client-vat').textContent = document.getElementById('client-vat').value ? `VAT: ${document.getElementById('client-vat').value}` : '';
            document.getElementById('preview-client-phone').textContent = document.getElementById('client-phone').value ? `Phone: ${document.getElementById('client-phone').value}` : '';
            document.getElementById('preview-client-email').textContent = document.getElementById('client-email').value ? `Email: ${document.getElementById('client-email').value}` : '';
            
            // Update invoice details
            document.getElementById('preview-invoice-number').textContent = document.getElementById('invoice-number').value;
            document.getElementById('preview-invoice-date').textContent = formatDate(document.getElementById('invoice-date').value);
            
            const validityDays = document.getElementById('validity-days').value || '30';
            document.getElementById('preview-validity').textContent = `${validityDays} days`;
            document.getElementById('preview-validity-text').textContent = `${validityDays} days`;
            
            const deliveryTime = document.getElementById('delivery-time').value || '7';
            document.getElementById('preview-delivery-time').textContent = `${deliveryTime} days after PO`;
            
            document.getElementById('preview-payment-terms').textContent = document.getElementById('payment-terms').value || '';
            
            // Update invoice items
            previewItems.innerHTML = '';
            
            const rows = document.querySelectorAll('#invoice-items tr');
            rows.forEach(row => {
                const description = row.querySelector('.item-description').value || 'Service item';
                const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const total = quantity * price;
                
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${description}</td>
                    <td>${quantity.toFixed(2)}</td>
                    <td>${formatCurrency(price, currency)}</td>
                    <td>${formatCurrency(total, currency)}</td>
                `;
                
                previewItems.appendChild(newRow);
            });
            
            // Update totals
            const subtotal = extractCurrencyValue(document.getElementById('subtotal').textContent);
            const tax = extractCurrencyValue(document.getElementById('tax').textContent);
            const grandTotal = extractCurrencyValue(document.getElementById('grand-total').textContent);
            
            document.getElementById('preview-subtotal').textContent = formatCurrency(subtotal, currency);
            document.getElementById('preview-tax').textContent = formatCurrency(tax, currency);
            document.getElementById('preview-grand-total').textContent = formatCurrency(grandTotal, currency);
            
            // Update terms
            document.getElementById('preview-bank-details').textContent = document.getElementById('bank-details').value || '';
            document.getElementById('preview-notes').textContent = document.getElementById('notes').value || '';
        }
        
        // Save invoice
        function saveInvoice() {
            const isProforma = document.getElementById('btn-proforma').classList.contains('active');
            const isStandard = document.getElementById('btn-standard').classList.contains('active');
            const isQuotation = document.getElementById('btn-quotation').classList.contains('active');
            
            const invoiceType = isProforma ? 'Proforma' : isStandard ? 'Standard' : 'Quotation';
            const currency = document.getElementById('currency').value;
            
            const invoiceData = {
                id: Date.now(), // Unique ID for each invoice
                companyName: "Kingu Electrical Company Ltd",
                email: COMPANY_EMAIL,
                tagline: COMPANY_TAGLINE,
                phoneNumbers: ["+255 677 01 47 40", "+255 763 95 79 08", "+255 682 84 35 52"],
                address: COMPANY_ADDRESS,
                type: invoiceType,
                invoiceNumber: document.getElementById('invoice-number').value,
                invoiceDate: document.getElementById('invoice-date').value,
                validityDays: document.getElementById('validity-days').value,
                currency: currency,
                deliveryTime: document.getElementById('delivery-time').value,
                clientName: document.getElementById('client-name').value,
                clientEmail: document.getElementById('client-email').value,
                clientPhone: document.getElementById('client-phone').value,
                clientAddress: document.getElementById('client-address').value,
                clientTIN: document.getElementById('client-tin').value,
                clientVAT: document.getElementById('client-vat').value,
                paymentTerms: document.getElementById('payment-terms').value,
                bankDetails: document.getElementById('bank-details').value,
                notes: document.getElementById('notes').value,
                items: [],
                subtotal: extractCurrencyValue(document.getElementById('subtotal').textContent),
                tax: extractCurrencyValue(document.getElementById('tax').textContent),
                grandTotal: extractCurrencyValue(document.getElementById('grand-total').textContent),
                savedDate: new Date().toISOString(),
                status: isQuotation ? 'Quotation' : (isProforma ? 'Pending' : 'Unpaid')
            };
            
            // Collect items
            const rows = document.querySelectorAll('#invoice-items tr');
            rows.forEach(row => {
                const item = {
                    description: row.querySelector('.item-description').value,
                    quantity: parseFloat(row.querySelector('.item-quantity').value) || 0,
                    price: parseFloat(row.querySelector('.item-price').value) || 0,
                    total: extractCurrencyValue(row.querySelector('.item-total').textContent)
                };
                invoiceData.items.push(item);
            });
            
            // Save to localStorage (simulating saving to a folder)
            let invoices = JSON.parse(localStorage.getItem('kinguInvoices')) || [];
            invoices.push(invoiceData);
            localStorage.setItem('kinguInvoices', JSON.stringify(invoices));
            
            // Generate and save PDF automatically
            generateAndSavePDF(invoiceData);
            
            alert(`${invoiceType} ${isQuotation ? '' : 'Invoice '}${invoiceData.invoiceNumber} saved successfully!\nPDF has been generated and saved.`);
            
            // Update the history views
            loadSavedInvoices();
            
            // Show the invoice preview
            generateInvoice();
        }
        
        // Generate and save PDF
        function generateAndSavePDF(invoiceData) {
            // Show loading message
            const originalText = pdfBtn.innerHTML;
            pdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
            
            // Get invoice preview element
            const invoiceElement = document.getElementById('invoice-preview');
            
            // Temporarily update preview with the saved data
            const originalDisplay = invoicePreview.style.display;
            invoicePreview.style.display = 'block';
            
            // Update preview with invoice data
            document.getElementById('preview-invoice-type').textContent = invoiceData.type.toUpperCase();
            document.getElementById('preview-client-name').innerHTML = `<strong>${invoiceData.clientName}</strong>`;
            document.getElementById('preview-client-address').textContent = invoiceData.clientAddress;
            document.getElementById('preview-client-tin').textContent = invoiceData.clientTIN ? `TIN Number: ${invoiceData.clientTIN}` : '';
            document.getElementById('preview-client-phone').textContent = `Phone: ${invoiceData.clientPhone}`;
            document.getElementById('preview-client-email').textContent = `Email: ${invoiceData.clientEmail}`;
            document.getElementById('preview-invoice-number').textContent = invoiceData.invoiceNumber;
            document.getElementById('preview-invoice-date').textContent = formatDate(invoiceData.invoiceDate);
            document.getElementById('preview-validity').textContent = `${invoiceData.validityDays} days`;
            document.getElementById('preview-delivery-time').textContent = `${invoiceData.deliveryTime} days after PO`;
            document.getElementById('preview-payment-terms').textContent = invoiceData.paymentTerms;
            
            // Set quotation-specific content
            const isQuotation = invoiceData.type === 'Quotation';
            document.querySelector('.stamp').style.display = isQuotation ? 'none' : 'block';
            document.querySelector('.quotation-stamp').style.display = isQuotation ? 'block' : 'none';
            
            if (isQuotation) {
                document.getElementById('preview-details-title').textContent = 'QUOTATION DETAILS:';
                document.getElementById('preview-doc-number').textContent = 'Quotation #:';
                document.getElementById('preview-subject').textContent = 'Subject: Quotation for Electrical Services';
                document.getElementById('preview-quotation-text').innerHTML = `
                    Dear Sir/Madam,<br><br>
                    Thank you for your inquiry. We are pleased to submit our quotation for the requested electrical services. 
                    All prices are inclusive of VAT where applicable and are valid for <span id="preview-validity-text">${invoiceData.validityDays} days</span>.
                `;
                document.querySelector('.grand-total .total-label').textContent = 'TOTAL QUOTATION:';
            } else {
                document.getElementById('preview-details-title').textContent = 'INVOICE DETAILS:';
                document.getElementById('preview-doc-number').textContent = invoiceData.type === 'Proforma' ? 'Proforma #:' : 'Invoice #:';
                document.getElementById('preview-subject').textContent = `Subject: ${invoiceData.type} for Electrical Services`;
                document.getElementById('preview-quotation-text').innerHTML = `
                    ${invoiceData.type.toUpperCase()}<br><br>
                    This ${invoiceData.type.toLowerCase()} is prepared for the services rendered. 
                    All prices are inclusive of VAT where applicable.
                `;
                document.querySelector('.grand-total .total-label').textContent = 'GRAND TOTAL:';
            }
            
            // Update items
            previewItems.innerHTML = '';
            invoiceData.items.forEach(item => {
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${item.description}</td>
                    <td>${parseFloat(item.quantity).toFixed(2)}</td>
                    <td>${formatCurrency(item.price, invoiceData.currency)}</td>
                    <td>${formatCurrency(item.total, invoiceData.currency)}</td>
                `;
                previewItems.appendChild(newRow);
            });
            
            // Update totals
            document.getElementById('preview-subtotal').textContent = formatCurrency(invoiceData.subtotal, invoiceData.currency);
            document.getElementById('preview-tax').textContent = formatCurrency(invoiceData.tax, invoiceData.currency);
            document.getElementById('preview-grand-total').textContent = formatCurrency(invoiceData.grandTotal, invoiceData.currency);
            
            // Update terms
            document.getElementById('preview-bank-details').textContent = invoiceData.bankDetails;
            document.getElementById('preview-notes').textContent = invoiceData.notes;
            
            // Use html2canvas to capture the invoice
            html2canvas(invoiceElement, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                // Calculate image dimensions to fit A4
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
                const imgX = (pdfWidth - imgWidth * ratio) / 2;
                const imgY = 10;
                
                // Add image to PDF
                pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
                
                // Generate filename
                const fileName = `Kingu_${invoiceData.type}_${invoiceData.invoiceNumber}_${invoiceData.clientName.replace(/\s+/g, '_')}.pdf`;
                
                // Save PDF (in a real app, this would save to a server folder)
                // For now, we'll save the PDF data in localStorage for demonstration
                const pdfData = pdf.output('datauristring');
                invoiceData.pdfData = pdfData;
                
                // Update localStorage with PDF data
                let invoices = JSON.parse(localStorage.getItem('kinguInvoices')) || [];
                const index = invoices.findIndex(inv => inv.id === invoiceData.id);
                if (index !== -1) {
                    invoices[index] = invoiceData;
                    localStorage.setItem('kinguInvoices', JSON.stringify(invoices));
                }
                
                // Offer download to user
                pdf.save(fileName);
                
                // Restore original display
                invoicePreview.style.display = originalDisplay;
                
                // Restore button text
                pdfBtn.innerHTML = originalText;
                
            }).catch(error => {
                console.error('Error generating PDF:', error);
                pdfBtn.innerHTML = originalText;
                invoicePreview.style.display = originalDisplay;
                alert('Error generating PDF. Please try again.');
            });
        }
        
        // Export to PDF (manual export)
        function exportToPDF() {
            const invoiceData = {
                invoiceNumber: document.getElementById('invoice-number').value,
                clientName: document.getElementById('client-name').value,
                type: document.getElementById('btn-proforma').classList.contains('active') ? 'Proforma' : 
                      document.getElementById('btn-standard').classList.contains('active') ? 'Standard' : 'Quotation',
                currency: document.getElementById('currency').value
            };
            
            generateAndSavePDF(invoiceData);
        }
        
        // Load saved invoices and display in history
        function loadSavedInvoices() {
            const invoices = JSON.parse(localStorage.getItem('kinguInvoices')) || [];
            
            if (invoices.length === 0) {
                proformaList.innerHTML = '<p>No proforma invoices found. Create your first invoice!</p>';
                historyList.innerHTML = '<p>No invoice history found. Create your first invoice!</p>';
                return;
            }
            
            // Filter proforma invoices
            const proformaInvoices = invoices.filter(inv => inv.type === 'Proforma');
            // All invoices for history
            const allInvoices = [...invoices].reverse(); // Show newest first
            
            // Display proforma invoices
            if (proformaInvoices.length > 0) {
                let proformaHTML = `
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Client</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                proformaInvoices.forEach(invoice => {
                    proformaHTML += `
                        <tr>
                            <td>${invoice.invoiceNumber}</td>
                            <td>${invoice.clientName}</td>
                            <td>${formatDateShort(invoice.invoiceDate)}</td>
                            <td>${formatCurrency(invoice.grandTotal, invoice.currency)}</td>
                            <td><span class="status-badge status-pending">${invoice.status}</span></td>
                            <td>
                                <button class="action-btn-small" style="background-color: var(--kingu-green); color: white;" onclick="viewInvoice(${invoice.id})">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="action-btn-small" style="background-color: #d32f2f; color: white;" onclick="downloadPDF(${invoice.id})">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                                <button class="action-btn-small" style="background-color: #6b7280; color: white;" onclick="deleteInvoice(${invoice.id})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                proformaHTML += '</tbody></table>';
                proformaList.innerHTML = proformaHTML;
            } else {
                proformaList.innerHTML = '<p>No proforma invoices found. Create your first proforma invoice!</p>';
            }
            
            // Display all invoices in history
            let historyHTML = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Invoice #</th>
                            <th>Client</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            allInvoices.forEach(invoice => {
                const statusClass = invoice.status === 'Paid' ? 'status-paid' : 
                                  invoice.status === 'Overdue' ? 'status-overdue' : 
                                  invoice.status === 'Quotation' ? 'status-quotation' : 'status-pending';
                
                historyHTML += `
                    <tr>
                        <td>${invoice.type}</td>
                        <td>${invoice.invoiceNumber}</td>
                        <td>${invoice.clientName}</td>
                        <td>${formatDateShort(invoice.invoiceDate)}</td>
                        <td>${formatCurrency(invoice.grandTotal, invoice.currency)}</td>
                        <td><span class="status-badge ${statusClass}">${invoice.status}</span></td>
                        <td>
                            <button class="action-btn-small" style="background-color: var(--kingu-green); color: white;" onclick="viewInvoice(${invoice.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="action-btn-small" style="background-color: #d32f2f; color: white;" onclick="downloadPDF(${invoice.id})">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            <button class="action-btn-small" style="background-color: #6b7280; color: white;" onclick="deleteInvoice(${invoice.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            historyHTML += '</tbody></table>';
            historyList.innerHTML = historyHTML;
        }
        
        // View saved invoice
        function viewInvoice(invoiceId) {
            const invoices = JSON.parse(localStorage.getItem('kinguInvoices')) || [];
            const invoice = invoices.find(inv => inv.id === invoiceId);
            
            if (invoice) {
                // Set invoice type
                setInvoiceType(invoice.type.toLowerCase());
                
                // Fill form with invoice data
                document.getElementById('invoice-number').value = invoice.invoiceNumber;
                document.getElementById('invoice-date').value = invoice.invoiceDate;
                document.getElementById('validity-days').value = invoice.validityDays;
                document.getElementById('currency').value = invoice.currency;
                document.getElementById('delivery-time').value = invoice.deliveryTime;
                document.getElementById('client-name').value = invoice.clientName;
                document.getElementById('client-email').value = invoice.clientEmail;
                document.getElementById('client-phone').value = invoice.clientPhone;
                document.getElementById('client-address').value = invoice.clientAddress;
                document.getElementById('client-tin').value = invoice.clientTIN;
                document.getElementById('client-vat').value = invoice.clientVAT || '';
                document.getElementById('payment-terms').value = invoice.paymentTerms;
                document.getElementById('bank-details').value = invoice.bankDetails;
                document.getElementById('notes').value = invoice.notes;
                
                // Set items
                invoiceItems.innerHTML = '';
                invoice.items.forEach(item => {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td><input type="text" class="item-description" value="${item.description}"></td>
                        <td><input type="number" class="item-quantity" min="0" step="0.01" value="${item.quantity}"></td>
                        <td>
                            <div style="display: flex; align-items: center;">
                                <span class="currency-symbol" style="margin-right: 5px;">${invoice.currency === 'TSh' ? 'TSh' : invoice.currency === 'USD' ? '$' : invoice.currency === 'EUR' ? '€' : '£'}</span>
                                <input type="number" class="item-price" min="0" step="0.01" value="${item.price}" style="flex: 1;">
                            </div>
                        </td>
                        <td class="item-total text-right">${formatCurrency(item.total, invoice.currency)}</td>
                        <td class="text-center"><button class="delete-item"><i class="fas fa-trash"></i></button></td>
                    `;
                    invoiceItems.appendChild(newRow);
                    
                    // Add event listeners
                    newRow.querySelector('.item-quantity').addEventListener('input', updateTotals);
                    newRow.querySelector('.item-price').addEventListener('input', updateTotals);
                });
                
                updateCurrencySymbol();
                updateTotals();
                
                // Show create invoice page
                invoiceForm.style.display = 'block';
                invoicePreview.style.display = 'none';
                proformaInvoicesContainer.style.display = 'none';
                invoiceHistoryContainer.style.display = 'none';
                
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                document.getElementById('nav-create').classList.add('active');
                
                alert(`Loaded ${invoice.type.toLowerCase()} ${invoice.invoiceNumber}. You can edit and save as a new document.`);
            }
        }
        
        // Download PDF
        function downloadPDF(invoiceId) {
            const invoices = JSON.parse(localStorage.getItem('kinguInvoices')) || [];
            const invoice = invoices.find(inv => inv.id === invoiceId);
            
            if (invoice && invoice.pdfData) {
                // Create a download link for the PDF
                const link = document.createElement('a');
                link.href = invoice.pdfData;
                link.download = `Kingu_${invoice.type}_${invoice.invoiceNumber}_${invoice.clientName.replace(/\s+/g, '_')}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert('PDF not found for this document. Please regenerate it from the preview.');
            }
        }
        
        // Delete invoice
        function deleteInvoice(invoiceId) {
            if (confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
                let invoices = JSON.parse(localStorage.getItem('kinguInvoices')) || [];
                invoices = invoices.filter(inv => inv.id !== invoiceId);
                localStorage.setItem('kinguInvoices', JSON.stringify(invoices));
                loadSavedInvoices();
                alert('Document deleted successfully.');
            }
        }
        
        // Clear form
        function clearForm() {
            if (confirm('Are you sure you want to clear the form? All entered data will be lost.')) {
                document.getElementById('invoice-form').reset();
                
                const currency = document.getElementById('currency').value;
                const symbol = currency === 'TSh' ? 'TSh' : 
                              currency === 'USD' ? '$' :
                              currency === 'EUR' ? '€' : '£';
                
                invoiceItems.innerHTML = `
                    <tr>
                        <td><input type="text" class="item-description" placeholder="Service description" value="Service item"></td>
                        <td><input type="number" class="item-quantity" min="0" step="0.01" value="1.00"></td>
                        <td>
                            <div style="display: flex; align-items: center;">
                                <span class="currency-symbol" style="margin-right: 5px;">${symbol}</span>
                                <input type="number" class="item-price" min="0" step="0.01" value="0.00" style="flex: 1;">
                            </div>
                        </td>
                        <td class="item-total text-right">${formatCurrency(0, currency)}</td>
                        <td class="text-center"><button class="delete-item"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
                
                const today = new Date();
                document.getElementById('invoice-date').valueAsDate = today;
                
                const isProforma = document.getElementById('btn-proforma').classList.contains('active');
                const isStandard = document.getElementById('btn-standard').classList.contains('active');
                const isQuotation = document.getElementById('btn-quotation').classList.contains('active');
                
                const year = new Date().getFullYear();
                const month = (new Date().getMonth() + 1).toString().padStart(2, '0');
                const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                
                let prefix = 'PROFORMA';
                if (isStandard) prefix = 'INV';
                if (isQuotation) prefix = 'QUOTE';
                
                document.getElementById('invoice-number').value = `${prefix}/GL/${month}/${year}/${randomNum}`;
                
                updateTotals();
                
                invoiceForm.style.display = 'block';
                invoicePreview.style.display = 'none';
                printBtn.style.display = 'none';
                pdfBtn.style.display = 'none';
                whatsappBtn.style.display = 'inline-flex';
                
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                document.getElementById('nav-create').classList.add('active');
            }
        }
        
        // Load sample proforma data
        function loadSampleProforma() {
            const isQuotation = document.getElementById('btn-quotation').classList.contains('active');
            
            if (isQuotation) {
                // Load sample quotation data
                const sampleItems = [
                    { description: "Electrical Installation for Office Building", quantity: "1.00", price: "5000000.00" },
                    { description: "Lighting System Installation", quantity: "1.00", price: "2500000.00" },
                    { description: "Power Distribution Board", quantity: "2.00", price: "750000.00" },
                    { description: "Wiring and Cabling", quantity: "500.00", price: "5000.00" },
                    { description: "Circuit Breakers and Switches", quantity: "50.00", price: "25000.00" },
                    { description: "Labor and Installation", quantity: "15.00", price: "100000.00" }
                ];
                
                invoiceItems.innerHTML = '';
                
                sampleItems.forEach(item => {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td><input type="text" class="item-description" value="${item.description}"></td>
                        <td><input type="number" class="item-quantity" min="0" step="0.01" value="${item.quantity}"></td>
                        <td>
                            <div style="display: flex; align-items: center;">
                                <span class="currency-symbol" style="margin-right: 5px;">TSh</span>
                                <input type="number" class="item-price" min="0" step="0.01" value="${item.price}" style="flex: 1;">
                            </div>
                        </td>
                        <td class="item-total text-right">TSh 0.00</td>
                        <td class="text-center"><button class="delete-item"><i class="fas fa-trash"></i></button></td>
                    `;
                    
                    invoiceItems.appendChild(newRow);
                    
                    newRow.querySelector('.item-quantity').addEventListener('input', updateTotals);
                    newRow.querySelector('.item-price').addEventListener('input', updateTotals);
                });
                
                document.getElementById('currency').value = 'TSh';
                updateCurrencySymbol();
                
                // Set sample client info for quotation
                document.getElementById('client-name').value = 'TANZANIA COMMERCIAL BANK';
                document.getElementById('client-address').value = 'DAR ES SALAAM, TANZANIA';
                document.getElementById('client-tin').value = '200-456-789';
                document.getElementById('client-phone').value = '+255 222 123 456';
                document.getElementById('client-email').value = 'procurement@tcb.co.tz';
                document.getElementById('payment-terms').value = '30% advance, 70% after completion';
                document.getElementById('bank-details').value = 'STANBIC BANK 912 000 275 9274 (KINGU ELECTRICAL COMPANY LIMITED)';
                document.getElementById('notes').value = 'This quotation is valid for 45 days.\nDelivery time: 30 days after order confirmation.\nPrices include VAT and all taxes.\nWarranty: 12 months on all installations.';
                document.getElementById('validity-days').value = '45';
                document.getElementById('delivery-time').value = '30';
                
                updateTotals();
                
                alert('Sample quotation loaded for TANZANIA COMMERCIAL BANK project.');
            } else {
                // Load sample proforma data
                const sampleItems = [
                    { description: "Engine service and Preventive maintenance", quantity: "1.00", price: "350000.00" },
                    { description: "PLC check and configuration", quantity: "1.00", price: "250000.00" },
                    { description: "AC Alternator cleanup and ATS", quantity: "1.00", price: "170000.00" },
                    { description: "Air filter", quantity: "1.00", price: "25000.00" },
                    { description: "fanbelt", quantity: "1.00", price: "8500.00" },
                    { description: "Coolant", quantity: "5.00", price: "15000.00" },
                    { description: "Engine oil", quantity: "9.00", price: "14000.00" }
                ];
                
                invoiceItems.innerHTML = '';
                
                sampleItems.forEach(item => {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td><input type="text" class="item-description" value="${item.description}"></td>
                        <td><input type="number" class="item-quantity" min="0" step="0.01" value="${item.quantity}"></td>
                        <td>
                            <div style="display: flex; align-items: center;">
                                <span class="currency-symbol" style="margin-right: 5px;">TSh</span>
                                <input type="number" class="item-price" min="0" step="0.01" value="${item.price}" style="flex: 1;">
                            </div>
                        </td>
                        <td class="item-total text-right">TSh 0.00</td>
                        <td class="text-center"><button class="delete-item"><i class="fas fa-trash"></i></button></td>
                    `;
                    
                    invoiceItems.appendChild(newRow);
                    
                    newRow.querySelector('.item-quantity').addEventListener('input', updateTotals);
                    newRow.querySelector('.item-price').addEventListener('input', updateTotals);
                });
                
                document.getElementById('currency').value = 'TSh';
                updateCurrencySymbol();
                
                // Set sample client info
                document.getElementById('client-name').value = 'GREENLIGHT PLANNET TANZANIA LTD';
                document.getElementById('client-address').value = 'ARUSHA, TANZANIA';
                document.getElementById('client-tin').value = '109-628-980';
                document.getElementById('client-phone').value = '+255 765 432 100';
                document.getElementById('client-email').value = 'accounts@greenlight.co.tz';
                document.getElementById('payment-terms').value = '100% after delivery';
                document.getElementById('bank-details').value = 'STANBIC BANK 912 000 275 9274 (KINGU ELECTRICAL COMPANY LIMITED)';
                document.getElementById('notes').value = 'This Proforma shall remain valid for 30 days only.\nDelivery time: 7 days after PO issue.';
                
                updateTotals();
                
                alert('Sample proforma invoice loaded from DG SERVICE GREENLIGHT June 2025.pdf');
            }
        }
        
        // Print invoice
        function printInvoice() {
            const isQuotation = document.getElementById('btn-quotation').classList.contains('active');
            
            // Show appropriate stamp before printing
            if (isQuotation) {
                document.querySelector('.quotation-stamp').style.display = 'block';
            } else {
                document.querySelector('.stamp').style.display = 'block';
            }
            
            setTimeout(() => {
                window.print();
                // Hide stamp after printing
                setTimeout(() => {
                    document.querySelector('.stamp').style.display = 'none';
                    document.querySelector('.quotation-stamp').style.display = 'none';
                }, 100);
            }, 100);
        }
        
        // Send invoice via WhatsApp
        function sendWhatsApp() {
            const invoiceNumber = document.getElementById('invoice-number').value;
            const clientName = document.getElementById('client-name').value || 'Client';
            const grandTotal = document.getElementById('grand-total').textContent;
            const isQuotation = document.getElementById('btn-quotation').classList.contains('active');
            const docType = isQuotation ? 'quotation' : 'proforma invoice';
            
            const message = `Hello, here is your ${docType} ${invoiceNumber} from KINGU ELECTRICAL COMPANY LIMITED for ${clientName}. Total amount: ${grandTotal}. Please review and confirm.`;
            
            // Encode the message for WhatsApp URL
            const encodedMessage = encodeURIComponent(message);
            const phoneNumber = '255682843552';
            
            // Open WhatsApp with pre-filled message
            window.open(`https://wa.me/${phoneNumber}?text=${encodedMessage}`, '_blank');
            
            // Show confirmation
            alert(`Opening WhatsApp to share ${docType} details. Please send to your client.`);
        }
        
        // Setup navigation
        function setupNavigation() {
            document.getElementById('nav-create').addEventListener('click', function(e) {
                e.preventDefault();
                invoiceForm.style.display = 'block';
                invoicePreview.style.display = 'none';
                proformaInvoicesContainer.style.display = 'none';
                invoiceHistoryContainer.style.display = 'none';
                printBtn.style.display = 'none';
                pdfBtn.style.display = 'none';
                whatsappBtn.style.display = 'inline-flex';
                
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                this.classList.add('active');
            });
            
            document.getElementById('nav-proforma').addEventListener('click', function(e) {
                e.preventDefault();
                invoiceForm.style.display = 'none';
                invoicePreview.style.display = 'none';
                proformaInvoicesContainer.style.display = 'block';
                invoiceHistoryContainer.style.display = 'none';
                printBtn.style.display = 'none';
                pdfBtn.style.display = 'none';
                whatsappBtn.style.display = 'none';
                
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                this.classList.add('active');
                
                // Load proforma invoices
                loadSavedInvoices();
            });
            
            document.getElementById('nav-history').addEventListener('click', function(e) {
                e.preventDefault();
                invoiceForm.style.display = 'none';
                invoicePreview.style.display = 'none';
                proformaInvoicesContainer.style.display = 'none';
                invoiceHistoryContainer.style.display = 'block';
                printBtn.style.display = 'none';
                pdfBtn.style.display = 'none';
                whatsappBtn.style.display = 'none';
                
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                this.classList.add('active');
                
                // Load invoice history
                loadSavedInvoices();
            });
            
            document.getElementById('nav-clients').addEventListener('click', function(e) {
                e.preventDefault();
                alert('Client management - Add, edit, and manage client information');
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                this.classList.add('active');
            });
            
            document.getElementById('nav-reports').addEventListener('click', function(e) {
                e.preventDefault();
                alert('Reports - Generate sales reports, tax reports, and analytics');
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                this.classList.add('active');
            });
            
            document.getElementById('nav-settings').addEventListener('click', function(e) {
                e.preventDefault();
                alert('Settings - Configure company details, tax rates, invoice templates');
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                this.classList.add('active');
            });
        }
    </script>
</body>
</html>