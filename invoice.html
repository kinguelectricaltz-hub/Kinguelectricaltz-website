<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KINGU ELECTRICAL COMPANY LIMITED - Invoice System</title>
    
    <!-- PWA Configuration -->
    <meta name="theme-color" content="#116a41">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kingu Invoices">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%23116a41%22>⚡</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%23116a41%22>⚡</text></svg>">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF Library for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Chart.js for Reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --kingu-green: #116a41;
            --kingu-red: #e63946;
            --kingu-yellow-start: #ffae42;
            --kingu-yellow-end: #ffea00;
            --kingu-dark: #0a4d2a;
            --kingu-light: #e8f5e9;
            --kingu-accent: #ff6b35;
            --kingu-success: #2a9d8f;
            --kingu-white: #ffffff;
            --kingu-blue: #2980b9;
            
            /* PWA safe areas */
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
            --safe-area-inset-left: env(safe-area-inset-left);
            --safe-area-inset-right: env(safe-area-inset-right);
        }

        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
            padding-top: var(--safe-area-inset-top);
            padding-bottom: var(--safe-area-inset-bottom);
        }

        .container {
            display: flex;
            min-height: 100vh;
            min-height: -webkit-fill-available; /* Mobile Safari fix */
        }

        /* PWA Notification Bar */
        .pwa-notification {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--kingu-green) 0%, var(--kingu-dark) 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        .pwa-notification-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .pwa-notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
        }

        /* Offline Indicator */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #e63946;
            color: white;
            padding: 10px;
            text-align: center;
            z-index: 9999;
            display: none;
            font-size: 14px;
            font-weight: 600;
            animation: slideDown 0.3s ease-out;
        }

        .offline-indicator i {
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        /* Sync Notification */
        .sync-notification {
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: #2980b9;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 9998;
            display: none;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            animation: slideDown 0.3s ease-out;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: linear-gradient(135deg, var(--kingu-green) 0%, var(--kingu-dark) 100%);
            color: white;
            padding: 25px 20px;
            box-shadow: 2px 0 15px rgba(17, 106, 65, 0.3);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }

        .logo-container {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--kingu-yellow-start) 0%, var(--kingu-yellow-end) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }

        .logo:before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            background: white;
            border-radius: 50%;
            z-index: 1;
        }

        .logo i {
            font-size: 28px;
            color: var(--kingu-red);
            z-index: 2;
            position: relative;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .company-header {
            line-height: 1.2;
            margin-bottom: 3px;
        }

        .company-header .kingu {
            font-size: 20px;
            font-weight: 800;
            color: white;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            display: block;
        }

        .company-header .electrical {
            font-size: 16px;
            font-weight: 700;
            color: var(--kingu-red);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            display: block;
            margin-top: -2px;
        }

        .company-full-name {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 2px;
            font-weight: 500;
            line-height: 1;
        }

        .company-tagline {
            font-size: 11px;
            opacity: 0.9;
            margin-top: 8px;
            color: rgba(255, 255, 255, 0.9);
            font-style: italic;
            line-height: 1.3;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 5px;
        }

        .nav-menu {
            list-style: none;
            margin-top: 30px;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            color: white;
            text-decoration: none;
            padding: 12px 15px;
            border-radius: 8px;
            transition: all 0.3s;
            border-left: 3px solid transparent;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
        }

        .nav-link i {
            margin-right: 12px;
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.15);
            border-left: 3px solid var(--kingu-red);
        }

        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-left: 3px solid var(--kingu-red);
            font-weight: 600;
        }

        /* Company Info in Sidebar */
        .company-info-sidebar {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 13px;
        }

        .company-info-sidebar p {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            line-height: 1.4;
        }

        .company-info-sidebar i {
            margin-right: 10px;
            margin-top: 3px;
            color: var(--kingu-yellow-end);
            min-width: 16px;
        }

        .contact-badge {
            display: inline-block;
            background-color: var(--kingu-red);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            font-weight: bold;
        }

        /* Contact Badges */
        .contact-badges {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .contact-badge-small {
            display: inline-flex;
            align-items: center;
            background-color: var(--kingu-light);
            color: var(--kingu-green);
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 600;
            border: 1px solid rgba(17, 106, 65, 0.2);
        }

        .contact-badge-small i {
            margin-right: 5px;
            font-size: 14px;
        }

        .whatsapp-badge {
            background-color: rgba(37, 211, 102, 0.1);
            color: #128C7E;
            border-color: rgba(37, 211, 102, 0.3);
        }

        .email-badge {
            background-color: rgba(66, 133, 244, 0.1);
            color: #4285f4;
            border-color: rgba(66, 133, 244, 0.3);
        }

        /* PWA Status Indicators */
        .pwa-status {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .pwa-status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            align-items: center;
        }

        .pwa-status-item:last-child {
            margin-bottom: 0;
        }

        .pwa-status-label {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pwa-status-value {
            font-weight: 600;
        }

        .online { color: #4CAF50; }
        .offline { color: #e63946; }
        .installed { color: #4CAF50; }
        .browser { color: #ff6b35; }

        .color-scheme {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .color-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .green { background-color: var(--kingu-green); }
        .red { background-color: var(--kingu-red); }
        .yellow-start { background-color: var(--kingu-yellow-start); }
        .yellow-end { background-color: var(--kingu-yellow-end); }
        .blue { background-color: var(--kingu-blue); }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background-color: var(--kingu-white);
            margin-left: 260px;
            width: calc(100% - 260px);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--kingu-light);
        }

        .header h1 {
            color: var(--kingu-green);
            font-size: 28px;
            position: relative;
            padding-left: 15px;
        }

        .header h1:before {
            content: '';
            position: absolute;
            left: 0;
            top: 5px;
            bottom: 5px;
            width: 4px;
            background: linear-gradient(to bottom, var(--kingu-green), var(--kingu-red));
            border-radius: 2px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 44px; /* PWA: Better touch target */
            min-width: 44px;
        }

        .btn-primary {
            background-color: var(--kingu-green);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--kingu-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(17, 106, 65, 0.2);
        }

        .btn-success {
            background-color: var(--kingu-success);
            color: white;
        }

        .btn-success:hover {
            background-color: #21867a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(42, 157, 143, 0.2);
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
            transform: translateY(-2px);
        }

        .btn-accent {
            background-color: var(--kingu-red);
            color: white;
        }

        .btn-accent:hover {
            background-color: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(230, 57, 70, 0.2);
        }

        .btn-whatsapp {
            background-color: #25D366;
            color: white;
        }

        .btn-whatsapp:hover {
            background-color: #128C7E;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.2);
        }

        .btn-pdf {
            background-color: #d32f2f;
            color: white;
        }

        .btn-pdf:hover {
            background-color: #b71c1c;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(211, 47, 47, 0.2);
        }

        .btn i {
            margin-right: 8px;
        }

        /* PWA Offline Save Button */
        .btn-offline {
            background-color: var(--kingu-yellow-start);
            color: #333;
        }

        .btn-offline:hover {
            background-color: #ff9c42;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 174, 66, 0.2);
        }

        /* Invoice Type Selector */
        .invoice-type-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(17, 106, 65, 0.1);
            border-left: 4px solid var(--kingu-green);
        }

        .type-btn {
            padding: 10px 25px;
            border: 2px solid var(--kingu-green);
            background: white;
            color: var(--kingu-green);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            min-height: 44px; /* PWA: Better touch target */
        }

        .type-btn.active {
            background: var(--kingu-green);
            color: white;
        }

        .type-btn.quotation-active {
            background: var(--kingu-blue);
            color: white;
            border-color: var(--kingu-blue);
        }

        .type-btn:hover:not(.active):not(.quotation-active) {
            background-color: var(--kingu-light);
        }

        /* Invoice Form Container */
        .invoice-form-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(17, 106, 65, 0.1);
            padding: 30px;
            margin-bottom: 30px;
            border-top: 4px solid var(--kingu-green);
            max-width: 100%;
            overflow-x: hidden;
        }

        .quotation-form-container {
            border-top: 4px solid var(--kingu-blue);
        }

        .form-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 18px;
            color: var(--kingu-green);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--kingu-light);
            display: flex;
            align-items: center;
        }

        .quotation-section-title {
            color: var(--kingu-blue);
        }

        .section-title i {
            margin-right: 10px;
            color: var(--kingu-red);
        }

        .quotation-section-title i {
            color: var(--kingu-blue);
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -15px;
        }

        .form-group {
            flex: 1;
            min-width: 250px;
            padding: 0 15px;
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--kingu-dark);
            font-size: 14px;
        }

        .quotation-form-group label {
            color: var(--kingu-blue);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.3s;
            font-size: 16px; /* PWA: Prevent iOS zoom */
        }

        .form-control:focus {
            outline: none;
            border-color: var(--kingu-green);
            box-shadow: 0 0 0 3px rgba(17, 106, 65, 0.1);
        }

        .quotation-control:focus {
            border-color: var(--kingu-blue);
            box-shadow: 0 0 0 3px rgba(41, 128, 185, 0.1);
        }

        /* Invoice Items Table */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .items-table thead {
            background-color: var(--kingu-green);
        }

        .quotation-items-table thead {
            background-color: var(--kingu-blue);
        }

        .items-table th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: white;
            border-bottom: 2px solid var(--kingu-dark);
        }

        .quotation-items-table th {
            border-bottom: 2px solid #1a5276;
        }

        .items-table td {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        .items-table tr:hover {
            background-color: #f9fafb;
        }

        .items-table input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
            font-size: 16px; /* PWA: Prevent iOS zoom */
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        .delete-item {
            background-color: var(--kingu-red);
            color: white;
            border: none;
            border-radius: 4px;
            width: 44px; /* PWA: Better touch target */
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .delete-item:hover {
            background-color: #c62828;
            transform: scale(1.05);
        }

        .add-item-btn {
            margin-top: 15px;
            background-color: var(--kingu-light);
            color: var(--kingu-green);
            border: 2px dashed var(--kingu-green);
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            transition: all 0.3s;
            min-height: 44px; /* PWA: Better touch target */
        }

        .quotation-add-item-btn {
            background-color: rgba(41, 128, 185, 0.1);
            color: var(--kingu-blue);
            border: 2px dashed var(--kingu-blue);
        }

        .add-item-btn:hover {
            background-color: var(--kingu-green);
            color: white;
            border-color: var(--kingu-green);
        }

        .quotation-add-item-btn:hover {
            background-color: var(--kingu-blue);
            color: white;
            border-color: var(--kingu-blue);
        }

        .add-item-btn i {
            margin-right: 8px;
        }

        /* VAT Section Styles */
        .vat-section {
            background: rgba(17, 106, 65, 0.05);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 3px solid var(--kingu-green);
        }

        .vat-toggle {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .tax-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .tax-option {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            background: white;
            min-height: 80px; /* PWA: Better touch target */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tax-option:hover {
            border-color: var(--kingu-green);
            background: rgba(17, 106, 65, 0.05);
        }

        .tax-option.active {
            border-color: var(--kingu-green);
            background: var(--kingu-green);
            color: white;
        }

        .tax-option input[type="radio"] {
            display: none;
        }

        /* Totals Section */
        .totals-section {
            background: linear-gradient(135deg, #f8fafc 0%, var(--kingu-light) 100%);
            padding: 25px;
            border-radius: 8px;
            margin-top: 30px;
            border-left: 4px solid var(--kingu-green);
        }

        .quotation-totals-section {
            background: linear-gradient(135deg, #f8fafc 0%, rgba(41, 128, 185, 0.1) 100%);
            border-left: 4px solid var(--kingu-blue);
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(17, 106, 65, 0.1);
        }

        .quotation-total-row {
            border-bottom: 1px solid rgba(41, 128, 185, 0.2);
        }

        .total-label {
            font-weight: 600;
            color: var(--kingu-dark);
        }

        .quotation-total-label {
            color: var(--kingu-blue);
        }

        .total-value {
            font-weight: 700;
            color: var(--kingu-green);
        }

        .quotation-total-value {
            color: var(--kingu-blue);
        }

        .grand-total {
            font-size: 20px;
            border-top: 2px solid var(--kingu-green);
            margin-top: 10px;
            padding-top: 15px;
            color: var(--kingu-dark);
        }

        .quotation-grand-total {
            border-top: 2px solid var(--kingu-blue);
            color: var(--kingu-blue);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        /* History Containers */
        .history-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(17, 106, 65, 0.1);
            padding: 30px;
            margin-top: 20px;
            border-top: 4px solid var(--kingu-green);
            display: none;
        }

        /* Table Styles for History */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th {
            background-color: var(--kingu-green);
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table tr:hover {
            background-color: #f9fafb;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }

        .status-paid {
            background-color: rgba(46, 204, 113, 0.2);
            color: #27ae60;
        }

        .status-pending {
            background-color: rgba(241, 196, 15, 0.2);
            color: #f39c12;
        }

        .status-overdue {
            background-color: rgba(231, 76, 60, 0.2);
            color: #c0392b;
        }

        .status-quotation {
            background-color: rgba(41, 128, 185, 0.2);
            color: var(--kingu-blue);
        }

        .action-btn-small {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-right: 5px;
            min-height: 36px; /* PWA: Better touch target */
            min-width: 36px;
        }

        .action-btn-small:hover {
            transform: translateY(-1px);
        }

        /* Chart Container */
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        /* A4 Preview Container */
        .a4-preview-container {
            display: none;
            width: 210mm;
            min-height: 297mm;
            margin: 20px auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
            padding: 20mm;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.3;
        }

        /* PWA-specific enhancements */
        @media (display-mode: standalone) {
            body {
                padding-top: 20px; /* Adjust for standalone app */
            }
            
            .sidebar {
                height: calc(100vh - 20px);
            }
            
            .main-content {
                padding-top: 40px; /* Extra padding for status bar */
            }
        }

        /* Print and Animation Styles */
        @media print {
            @page {
                size: A4;
                margin: 0;
            }
            
            body, html {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                width: 210mm !important;
                height: 297mm !important;
            }
            
            body * {
                visibility: hidden;
            }
            
            .print-content,
            .print-content * {
                visibility: visible !important;
            }
            
            .print-content {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 210mm !important;
                min-height: 297mm !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                background-color: white !important;
                border: none !important;
                border-radius: 0 !important;
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
            }
            
            .sidebar, 
            .header, 
            .invoice-form-container, 
            .action-buttons, 
            .invoice-type-selector,
            .nav-menu,
            .btn,
            button,
            .history-container,
            .main-content > *:not(.print-content),
            .no-print,
            .a4-preview-container,
            .pwa-notification,
            .offline-indicator,
            .sync-notification {
                display: none !important;
                visibility: hidden !important;
            }
            
            .container {
                display: block !important;
                width: 100% !important;
                height: 100% !important;
            }
            
            .main-content {
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
                height: 100% !important;
            }
        }

        @media screen and (max-width: 1024px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
                max-height: 70vh;
                overflow-y: auto;
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 15px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .action-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .a4-preview-container {
                width: 100%;
                padding: 10mm;
                zoom: 0.8;
            }
            
            .tax-options {
                grid-template-columns: 1fr;
            }
            
            /* Better touch targets for mobile */
            .btn, .nav-link, .action-btn-small {
                min-height: 48px;
                min-width: 48px;
            }
            
            .items-table input {
                font-size: 16px; /* Prevent iOS zoom on focus */
            }
        }

        /* A4 specific styles for screen preview */
        @media screen and (min-width: 800px) {
            .a4-preview-container {
                width: 210mm;
                min-height: 297mm;
                padding: 20mm;
                margin: 20px auto;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
                position: relative;
            }
        }

        /* Animation Styles */
        @keyframes highlight {
            0% {
                background-color: rgba(17, 106, 65, 0.1);
                box-shadow: 0 0 0 0 rgba(17, 106, 65, 0.7);
            }
            70% {
                background-color: rgba(17, 106, 65, 0.3);
                box-shadow: 0 0 0 10px rgba(17, 106, 65, 0);
            }
            100% {
                background-color: transparent;
                box-shadow: 0 0 0 0 rgba(17, 106, 65, 0);
            }
        }
        
        .data-table tr.highlighted {
            animation: highlight 2s ease-in-out;
        }
        
        /* Enhanced status badge styles */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-badge.paid {
            background-color: rgba(46, 204, 113, 0.2);
            color: #27ae60;
        }
        
        .status-badge.pending {
            background-color: rgba(241, 196, 15, 0.2);
            color: #f39c12;
        }
        
        .status-badge.overdue {
            background-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        /* Enhanced action button styles */
        .action-btn-small {
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .action-btn-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* PWA Loading Screen */
        .pwa-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--kingu-green) 0%, var(--kingu-dark) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: opacity 0.5s;
        }

        .pwa-loading-logo {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--kingu-yellow-start) 0%, var(--kingu-yellow-end) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            animation: pulse 2s infinite;
        }

        .pwa-loading-logo:before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            background: white;
            border-radius: 50%;
            z-index: 1;
        }

        .pwa-loading-logo i {
            font-size: 48px;
            color: var(--kingu-red);
            z-index: 2;
            position: relative;
        }

        .pwa-loading-text {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin-top: 20px;
        }

        .pwa-loading-progress {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
        }

        .pwa-loading-progress-bar {
            height: 100%;
            background: white;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <!-- PWA Loading Screen -->
    <div id="pwaLoading" class="pwa-loading">
        <div class="pwa-loading-logo">
            <i class="fas fa-bolt"></i>
        </div>
        <div class="pwa-loading-text" id="loadingText">Loading Kingu Invoice System...</div>
        <div class="pwa-loading-progress">
            <div class="pwa-loading-progress-bar" id="loadingProgress"></div>
        </div>
    </div>

    <!-- PWA Notification Bar -->
    <div id="pwaNotification" class="pwa-notification" style="display: none;">
        <div class="pwa-notification-content">
            <i class="fas fa-mobile-alt"></i>
            <span id="pwaNotificationText">Install Kingu Invoice App for better experience</span>
        </div>
        <div>
            <button class="btn btn-success" onclick="installApp()" style="margin-right: 10px; padding: 8px 16px; font-size: 14px;">
                <i class="fas fa-download"></i> Install
            </button>
            <button class="pwa-notification-close" onclick="dismissPwaNotification()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator">
        <i class="fas fa-wifi-slash"></i>
        You are currently offline. Changes will be saved locally and synced when you're back online.
    </div>

    <!-- Sync Notification -->
    <div class="sync-notification" id="syncNotification">
        <i class="fas fa-sync-alt fa-spin"></i>
        <span id="syncNotificationText">Syncing offline documents...</span>
    </div>

    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo-container">
                <div class="logo">
                    <i class="fas fa-bolt"></i>
                </div>
                <div class="logo-text">
                    <div class="company-header">
                        <span class="kingu">Kingu</span>
                        <span class="electrical">Electrical</span>
                    </div>
                    <div class="company-full-name">Company Limited</div>
                    <div class="company-tagline">Quality Electrical Services with Professional Experience</div>
                </div>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <button class="nav-link active" id="nav-create">
                        <i class="fas fa-file-invoice-dollar"></i> Create Invoice
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="nav-proforma">
                        <i class="fas fa-file-contract"></i> Proforma Invoices
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="nav-history">
                        <i class="fas fa-history"></i> Document History
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="nav-clients">
                        <i class="fas fa-users"></i> Client Database
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="nav-reports">
                        <i class="fas fa-chart-bar"></i> Reports & Analytics
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="nav-settings">
                        <i class="fas fa-cog"></i> System Settings
                    </button>
                </li>
            </ul>
            
            <div class="company-info-sidebar">
                <p><i class="fas fa-map-marker-alt"></i> <span>P.O. Box 62313<br>Dar Es Salaam Tanzania</span></p>
                <p><i class="fas fa-hashtag"></i> TIN: 157-024-493</p>
                <p><i class="fas fa-phone"></i> +255 677 01 47 40</p>
                <p><i class="fas fa-phone"></i> +255 763 95 79 08</p>
                <p><i class="fas fa-phone"></i> +255 682 84 35 52</p>
                <p><i class="fab fa-whatsapp"></i> +255 682 84 35 52 <span class="contact-badge">WHATSAPP</span></p>
                <p><i class="fas fa-envelope"></i> kinguelectricaltz@gmail.com</p>
                <p><i class="fas fa-university"></i> STANBIC BANK<br>912 000 275 9274</p>
                
                <div class="contact-badges">
                    <span class="contact-badge-small">
                        <i class="fas fa-phone"></i> Call Us
                    </span>
                    <span class="contact-badge-small whatsapp-badge">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </span>
                    <span class="contact-badge-small email-badge">
                        <i class="fas fa-envelope"></i> Email
                    </span>
                </div>
                
                <!-- PWA Status -->
                <div class="pwa-status">
                    <div class="pwa-status-item">
                        <div class="pwa-status-label">
                            <i class="fas fa-wifi"></i>
                            <span>Status:</span>
                        </div>
                        <div class="pwa-status-value" id="connectionStatus">Online</div>
                    </div>
                    <div class="pwa-status-item">
                        <div class="pwa-status-label">
                            <i class="fas fa-mobile-alt"></i>
                            <span>App Mode:</span>
                        </div>
                        <div class="pwa-status-value" id="appMode">Browser</div>
                    </div>
                    <div class="pwa-status-item">
                        <div class="pwa-status-label">
                            <i class="fas fa-save"></i>
                            <span>Offline Docs:</span>
                        </div>
                        <div class="pwa-status-value" id="offlineDocCount">0</div>
                    </div>
                    <div class="pwa-status-item">
                        <div class="pwa-status-label">
                            <i class="fas fa-database"></i>
                            <span>Storage:</span>
                        </div>
                        <div class="pwa-status-value" id="storageStatus">Checking...</div>
                    </div>
                </div>
                
                <div class="color-scheme">
                    <div class="color-box green" title="Kingu Green: #116a41"></div>
                    <div class="color-box red" title="Electrical Red: #e63946"></div>
                    <div class="color-box yellow-start" title="Light Bulb Start: #ffae42"></div>
                    <div class="color-box yellow-end" title="Light Bulb End: #ffea00"></div>
                    <div class="color-box blue" title="Quotation Blue: #2980b9"></div>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Header for Create Invoice -->
            <div class="header" id="main-header">
                <h1 id="page-title">Create Proforma Invoice</h1>
                <div>
                    <!-- PWA Status Badge -->
                    <span id="pwaHeaderStatus" style="margin-right: 10px; padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: 600; background: var(--kingu-light); color: var(--kingu-green); display: none;">
                        <i class="fas fa-check-circle"></i> Online
                    </span>
                    
                    <button class="btn btn-offline" id="offline-save-btn" style="margin-right: 10px; display: none;">
                        <i class="fas fa-save"></i> Save Offline
                    </button>
                    <button class="btn btn-whatsapp" id="whatsapp-btn" style="margin-right: 10px;">
                        <i class="fab fa-whatsapp"></i> Share Document
                    </button>
                    <button class="btn btn-pdf" id="pdf-btn" style="display: none; margin-right: 10px;">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                    <button class="btn btn-accent" id="load-sample-btn">
                        <i class="fas fa-file-import"></i> Load Sample
                    </button>
                    <button class="btn btn-secondary" id="print-btn" style="display: none;">
                        <i class="fas fa-print"></i> Print Document
                    </button>
                    <button class="btn btn-success" id="new-document-btn" style="margin-right: 10px;">
                        <i class="fas fa-plus"></i> New Document
                    </button>
                </div>
            </div>
            
            <!-- Invoice Type Selector (only for create invoice) -->
            <div class="invoice-type-selector" id="type-selector">
                <button class="type-btn active" id="btn-proforma">Proforma Invoice</button>
                <button class="type-btn" id="btn-standard">Standard Invoice</button>
                <button class="type-btn" id="btn-quotation">Quotation</button>
            </div>
            
            <!-- Invoice Form -->
            <div id="invoice-form" class="invoice-form-container">
                <!-- Form content remains the same -->
                <div class="form-section">
                    <h3 class="section-title" id="details-title"><i class="fas fa-info-circle"></i> Invoice Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="invoice-number" id="doc-number-label">Invoice Number</label>
                            <div style="display: flex; align-items: center;">
                                <input type="text" id="invoice-number" class="form-control" value="PROFORMAGL/06/2025/001" style="flex: 1;">
                                <button class="btn" style="margin-left: 10px; padding: 10px 15px; background-color: var(--kingu-light);" id="generate-number-btn" title="Generate New Number">
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="invoice-date" id="doc-date-label">Invoice Date</label>
                            <input type="date" id="invoice-date" class="form-control" value="">
                        </div>
                        <div class="form-group">
                            <label for="due-date">Due Date</label>
                            <input type="date" id="due-date" class="form-control" value="">
                        </div>
                    </div>
                    
                    <div class="proforma-fields" id="extra-fields">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="currency">Currency</label>
                                <select id="currency" class="form-control currency-select">
                                    <option value="TSh">Tanzanian Shilling (TSh)</option>
                                    <option value="USD">US Dollar ($)</option>
                                    <option value="EUR">Euro (€)</option>
                                    <option value="GBP">British Pound (£)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="delivery-time">Delivery Time (Days after PO)</label>
                                <input type="number" id="delivery-time" class="form-control" value="7" min="1">
                            </div>
                            <div class="form-group">
                                <label for="payment-terms">Payment Terms</label>
                                <select id="payment-terms" class="form-control">
                                    <option value="100% after delivery">100% after delivery</option>
                                    <option value="50% advance, 50% after delivery">50% advance, 50% after delivery</option>
                                    <option value="30 days net">30 days net</option>
                                    <option value="Custom">Custom</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row" id="custom-terms-container" style="display: none;">
                            <div class="form-group">
                                <label for="custom-payment-terms">Custom Payment Terms</label>
                                <textarea id="custom-payment-terms" class="form-control" rows="2" placeholder="Enter custom payment terms"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-user-tie"></i> Client Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="client-name">Client Name</label>
                            <div style="display: flex;">
                                <input type="text" id="client-name" class="form-control" placeholder="Enter client name" value="GREENLIGHT PLANNET TANZANIA LTD">
                                <button class="btn" style="margin-left: 10px; padding: 10px 15px; background-color: var(--kingu-light);" id="client-search-btn" title="Search Client Database">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="client-email">Client Email</label>
                            <input type="email" id="client-email" class="form-control" placeholder="Enter client email" value="accounts@greenlight.co.tz">
                        </div>
                        <div class="form-group">
                            <label for="client-phone">Client Phone</label>
                            <input type="text" id="client-phone" class="form-control" placeholder="Enter client phone" value="+255 765 432 100">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="client-address">Client Address</label>
                            <textarea id="client-address" class="form-control" rows="2" placeholder="Enter client address">ARUSHA, TANZANIA</textarea>
                        </div>
                        <div class="form-group">
                            <label for="client-tin">TIN Number</label>
                            <input type="text" id="client-tin" class="form-control" placeholder="Enter TIN number" value="109-628-980">
                        </div>
                        <div class="form-group">
                            <label for="client-vat">VAT Number (if applicable)</label>
                            <input type="text" id="client-vat" class="form-control" placeholder="Enter VAT number">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="section-title" id="items-title"><i class="fas fa-list-alt"></i> Invoice Items</h3>
                    <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                        <button class="btn" style="background-color: var(--kingu-light); color: var(--kingu-green);" id="add-service-item">
                            <i class="fas fa-wrench"></i> Add Service
                        </button>
                        <button class="btn" style="background-color: var(--kingu-light); color: var(--kingu-green);" id="add-product-item">
                            <i class="fas fa-box"></i> Add Product
                        </button>
                        <button class="btn" style="background-color: var(--kingu-light); color: var(--kingu-green);" id="add-labor-item">
                            <i class="fas fa-user-hard-hat"></i> Add Labor
                        </button>
                    </div>
                    <table class="items-table" id="items-table">
                        <thead>
                            <tr>
                                <th>DESCRIPTION</th>
                                <th style="width: 100px;">UNITS</th>
                                <th style="width: 150px;">UNIT PRICE</th>
                                <th style="width: 150px;">AMOUNT</th>
                                <th style="width: 80px;">ACTION</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-items">
                            <tr>
                                <td><input type="text" class="item-description" placeholder="Service description" value="Engine service and Preventive maintenance"></td>
                                <td><input type="number" class="item-quantity" min="0" step="0.01" value="1.00"></td>
                                <td>
                                    <div style="display: flex; align-items: center;">
                                        <span class="currency-symbol" style="margin-right: 5px;">TSh</span>
                                        <input type="number" class="item-price" min="0" step="0.01" value="350000.00" style="flex: 1;">
                                    </div>
                                </td>
                                <td class="item-total text-right">TSh 350,000.00</td>
                                <td class="text-center"><button class="delete-item"><i class="fas fa-trash"></i></button></td>
                            </tr>
                            <tr>
                                <td><input type="text" class="item-description" placeholder="Service description" value="PLC check and configuration"></td>
                                <td><input type="number" class="item-quantity" min="0" step="0.01" value="1.00"></td>
                                <td>
                                    <div style="display: flex; align-items: center;">
                                        <span class="currency-symbol" style="margin-right: 5px;">TSh</span>
                                        <input type="number" class="item-price" min="0" step="0.01" value="250000.00" style="flex: 1;">
                                    </div>
                                </td>
                                <td class="item-total text-right">TSh 250,000.00</td>
                                <td class="text-center"><button class="delete-item"><i class="fas fa-trash"></i></button></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <button class="add-item-btn" id="add-item-btn">
                        <i class="fas fa-plus-circle"></i> Add Custom Item
                    </button>
                    
                    <div style="margin-top: 20px; display: flex; gap: 15px; align-items: center;">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label for="discount-type">Discount</label>
                            <select id="discount-type" class="form-control">
                                <option value="none">No Discount</option>
                                <option value="percentage">Percentage %</option>
                                <option value="fixed">Fixed Amount</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1; margin-bottom: 0; display: none;" id="discount-value-container">
                            <label for="discount-value">Discount Value</label>
                            <input type="number" id="discount-value" class="form-control" min="0" step="0.01" value="0">
                        </div>
                    </div>
                </div>
                
                <!-- VAT/Tax Section -->
                <div class="vat-section">
                    <h4 style="color: var(--kingu-green); margin-bottom: 15px;">
                        <i class="fas fa-percentage"></i> VAT/Tax Options
                    </h4>
                    <div class="tax-options">
                        <label class="tax-option active" for="vat-none">
                            <input type="radio" id="vat-none" name="vat-option" value="none" checked>
                            <div>
                                <strong>No VAT/Tax</strong>
                                <div style="font-size: 12px; margin-top: 5px;">Apply no taxes</div>
                            </div>
                        </label>
                        <label class="tax-option" for="vat-standard">
                            <input type="radio" id="vat-standard" name="vat-option" value="standard">
                            <div>
                                <strong>Standard VAT</strong>
                                <div style="font-size: 12px; margin-top: 5px;">18% VAT Rate</div>
                            </div>
                        </label>
                        <label class="tax-option" for="vat-custom">
                            <input type="radio" id="vat-custom" name="vat-option" value="custom">
                            <div>
                                <strong>Custom Rate</strong>
                                <div style="font-size: 12px; margin-top: 5px;">Set your own rate</div>
                            </div>
                        </label>
                    </div>
                    
                    <div id="vat-custom-container" style="margin-top: 15px; display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="custom-vat-rate">Tax Rate (%)</label>
                                <input type="number" id="custom-vat-rate" class="form-control" min="0" max="100" step="0.1" value="18">
                            </div>
                            <div class="form-group">
                                <label for="vat-number-input">VAT/Tax Number (if applicable)</label>
                                <input type="text" id="vat-number-input" class="form-control" placeholder="Enter VAT/Tax number">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Totals Section -->
                <div class="totals-section" id="totals-section">
                    <div class="total-row">
                        <span class="total-label">Subtotal:</span>
                        <span class="total-value" id="subtotal">TSh 600,000.00</span>
                    </div>
                    <div class="total-row" id="discount-row" style="display: none;">
                        <span class="total-label" id="discount-label">Discount:</span>
                        <span class="total-value" id="discount-amount">TSh 0.00</span>
                    </div>
                    <div class="total-row" id="vat-row">
                        <span class="total-label">VAT (18%):</span>
                        <span class="total-value" id="tax">TSh 108,000.00</span>
                    </div>
                    <div class="total-row grand-total">
                        <span class="total-label" id="grand-total-label">GRAND TOTAL:</span>
                        <span class="total-value" id="grand-total">TSh 708,000.00</span>
                    </div>
                    <div class="total-row" style="margin-top: 10px; font-size: 14px; color: #666;">
                        <span class="total-label">Amount in Words:</span>
                        <span class="total-value" id="amount-words">Seven hundred eight thousand Tanzanian Shillings only</span>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-file-signature"></i> Terms & Conditions</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bank-details">Bank Details</label>
                            <textarea id="bank-details" class="form-control" rows="3">BANK: STANBIC BANK TANZANIA LIMITED
ACCOUNT NAME: KINGU ELECTRICAL COMPANY LIMITED
ACCOUNT NUMBER: 912 000 275 9274
SWIFT CODE: SBICTZTX</textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="notes">Additional Notes / Special Instructions</label>
                            <textarea id="notes" class="form-control" rows="4" placeholder="Add any additional notes here...">1. This Proforma shall remain valid for 30 days only.
2. Prices are inclusive of VAT where applicable.
3. Delivery subject to stock availability.
4. All disputes subject to Dar es Salaam jurisdiction.</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="clear-btn">
                        <i class="fas fa-redo"></i> Clear Form
                    </button>
                    <button class="btn btn-success" id="preview-btn">
                        <i class="fas fa-eye"></i> Preview Document
                    </button>
                    <button class="btn btn-primary" id="save-btn">
                        <i class="fas fa-save"></i> Save Proforma
                    </button>
                    <button class="btn" style="background-color: var(--kingu-accent); color: white;" id="send-email-btn">
                        <i class="fas fa-paper-plane"></i> Send via Email
                    </button>
                </div>
            </div>
            
            <!-- A4 Preview Container -->
            <div id="a4-preview" class="a4-preview-container">
                <div class="print-content" id="print-content">
                    <!-- Content will be inserted here by JavaScript -->
                </div>
            </div>
            
            <!-- Client Database Section -->
            <div id="client-database" class="history-container">
                <div class="header">
                    <h1><i class="fas fa-users"></i> Client Database</h1>
                    <div>
                        <button class="btn btn-primary" id="add-client-btn">
                            <i class="fas fa-user-plus"></i> Add New Client
                        </button>
                        <button class="btn btn-secondary" id="export-clients-btn">
                            <i class="fas fa-file-export"></i> Export Clients
                        </button>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="client-search">Search Clients</label>
                            <input type="text" id="client-search" class="form-control" placeholder="Search by name, email, or phone...">
                        </div>
                    </div>
                </div>
                
                <div id="client-list">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Client Name</th>
                                <th>Contact Info</th>
                                <th>TIN/VAT</th>
                                <th>Total Invoices</th>
                                <th>Total Value</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="client-table-body">
                            <!-- Client data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Proforma Invoices Section -->
            <div id="proforma-invoices" class="history-container">
                <div class="header">
                    <h1><i class="fas fa-file-contract"></i> Proforma Invoices</h1>
                    <div>
                        <button class="btn btn-primary" id="filter-proformas-btn">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                    </div>
                </div>
                
                <div id="proforma-list">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Client</th>
                                <th>Date</th>
                                <th>Due Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="proforma-table-body">
                            <!-- Proforma data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Invoice History Section -->
            <div id="invoice-history" class="history-container">
                <div class="header">
                    <h1><i class="fas fa-history"></i> Document History</h1>
                    <div>
                        <select id="history-filter" class="form-control" style="width: 200px; margin-right: 10px;">
                            <option value="all">All Documents</option>
                            <option value="proforma">Proforma Invoices</option>
                            <option value="invoice">Standard Invoices</option>
                            <option value="quotation">Quotations</option>
                            <option value="last30">Last 30 Days</option>
                        </select>
                        <button class="btn btn-secondary" id="export-history-btn">
                            <i class="fas fa-file-export"></i> Export
                        </button>
                    </div>
                </div>
                
                <div id="history-list">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Document #</th>
                                <th>Type</th>
                                <th>Client</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body">
                            <!-- History data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Reports Section -->
            <div id="reports-section" class="history-container">
                <div class="header">
                    <h1><i class="fas fa-chart-bar"></i> Reports & Analytics</h1>
                    <div>
                        <select id="report-period" class="form-control" style="width: 200px; margin-right: 10px;">
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                            <option value="custom">Custom Range</option>
                        </select>
                        <button class="btn btn-primary" id="generate-report-btn">
                            <i class="fas fa-chart-line"></i> Generate Report
                        </button>
                    </div>
                </div>
                
                <div id="reports-content">
                    <!-- Reports content will be loaded dynamically -->
                </div>
            </div>
            
            <!-- Settings Section -->
            <div id="settings-section" class="history-container">
                <div class="header">
                    <h1><i class="fas fa-cog"></i> System Settings</h1>
                    <div>
                        <button class="btn btn-primary" id="save-settings-btn">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </div>
                
                <div id="settings-content">
                    <div class="form-section">
                        <h3 class="section-title"><i class="fas fa-building"></i> Company Settings</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="company-name">Company Name</label>
                                <input type="text" id="company-name" class="form-control" value="KINGU ELECTRICAL COMPANY LIMITED">
                            </div>
                            <div class="form-group">
                                <label for="company-tin">TIN Number</label>
                                <input type="text" id="company-tin" class="form-control" value="157-024-493">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="company-address">Company Address</label>
                                <textarea id="company-address" class="form-control" rows="2">P.O. Box 62313, Dar Es Salaam Tanzania</textarea>
                            </div>
                            <div class="form-group">
                                <label for="company-phone">Phone Numbers</label>
                                <textarea id="company-phone" class="form-control" rows="2">+255 677 01 47 40
+255 763 95 79 08
+255 682 84 35 52</textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="company-email">Company Email</label>
                                <input type="email" id="company-email" class="form-control" value="kinguelectricaltz@gmail.com">
                            </div>
                            <div class="form-group">
                                <label for="company-website">Company Website</label>
                                <input type="text" id="company-website" class="form-control" value="kingueletrical.com">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3 class="section-title"><i class="fas fa-file-invoice"></i> Document Settings</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="default-currency">Default Currency</label>
                                <select id="default-currency" class="form-control">
                                    <option value="TSh">Tanzanian Shilling (TSh)</option>
                                    <option value="USD">US Dollar ($)</option>
                                    <option value="EUR">Euro (€)</option>
                                    <option value="GBP">British Pound (£)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="vat-rate">Default VAT Rate (%)</label>
                                <input type="number" id="vat-rate" class="form-control" value="18" min="0" max="100" step="0.1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="default-vat-type">Default VAT Type</label>
                                <select id="default-vat-type" class="form-control">
                                    <option value="none">No VAT/Tax</option>
                                    <option value="standard" selected>Standard VAT</option>
                                    <option value="custom">Custom Rate</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="enable-vat-number">Require VAT Number</label>
                                <select id="enable-vat-number" class="form-control">
                                    <option value="no">No</option>
                                    <option value="yes">Yes</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="invoice-prefix">Invoice Number Prefix</label>
                                <input type="text" id="invoice-prefix" class="form-control" value="PROFORMA/GL">
                            </div>
                            <div class="form-group">
                                <label for="default-payment-terms">Default Payment Terms</label>
                                <select id="default-payment-terms" class="form-control">
                                    <option value="100% after delivery">100% after delivery</option>
                                    <option value="50% advance, 50% after delivery">50% advance, 50% after delivery</option>
                                    <option value="30 days net">30 days net</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="default-delivery">Default Delivery Time (days)</label>
                                <input type="number" id="default-delivery" class="form-control" value="7" min="1">
                            </div>
                            <div class="form-group">
                                <label for="default-notes">Default Terms & Conditions</label>
                                <textarea id="default-notes" class="form-control" rows="3">1. This Proforma shall remain valid for 30 days only.
2. Prices are inclusive of VAT where applicable.
3. Delivery subject to stock availability.
4. All disputes subject to Dar es Salaam jurisdiction.</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3 class="section-title"><i class="fas fa-university"></i> Bank Settings</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="bank-name">Bank Name</label>
                                <input type="text" id="bank-name" class="form-control" value="STANBIC BANK TANZANIA LIMITED">
                            </div>
                            <div class="form-group">
                                <label for="account-name">Account Name</label>
                                <input type="text" id="account-name" class="form-control" value="KINGU ELECTRICAL COMPANY LIMITED">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="account-number">Account Number</label>
                                <input type="text" id="account-number" class="form-control" value="912 000 275 9274">
                            </div>
                            <div class="form-group">
                                <label for="swift-code">SWIFT Code</label>
                                <input type="text" id="swift-code" class="form-control" value="SBICTZTX">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- PWA Service Worker Registration -->
    <script>
        // PWA Configuration
        let deferredPrompt;
        let isOnline = navigator.onLine;
        let isInstalled = window.matchMedia('(display-mode: standalone)').matches;
        
        // Initialize PWA
        document.addEventListener('DOMContentLoaded', async function() {
            // Show loading screen
            showLoadingScreen();
            
            // Register Service Worker
            await registerServiceWorker();
            
            // Initialize PWA features
            initializePWA();
            
            // Update loading progress
            updateLoadingProgress(30);
            
            // Initialize main application
            initializeMainApplication();
            
            // Update loading progress
            updateLoadingProgress(60);
            
            // Check connection status
            updateConnectionStatus();
            
            // Update storage info
            checkStorageUsage();
            
            // Update offline document count
            updateOfflineDocCount();
            
            // Check for updates
            checkForUpdates();
            
            // Update loading progress and hide
            updateLoadingProgress(100);
            setTimeout(() => {
                hideLoadingScreen();
            }, 500);
        });
        
        // Service Worker Registration
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('sw.js', {
                        scope: '/'
                    });
                    
                    console.log('Service Worker registered:', registration);
                    
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateNotification();
                            }
                        });
                    });
                    
                } catch (error) {
                    console.error('Service Worker registration failed:', error);
                }
            }
        }
        
        // Initialize PWA features
        function initializePWA() {
            // Install prompt handling
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Show install notification after delay
                setTimeout(() => {
                    if (!isInstalled && !localStorage.getItem('installPromptDismissed')) {
                        showInstallNotification();
                    }
                }, 5000);
            });
            
            // Online/Offline detection
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
            
            // App installed detection
            window.addEventListener('appinstalled', () => {
                console.log('App installed');
                isInstalled = true;
                updateAppMode();
                showNotification('App installed successfully!', 'success');
            });
            
            // Periodic sync
            if ('serviceWorker' in navigator && 'SyncManager' in window) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.periodicSync.register('update-content', {
                        minInterval: 24 * 60 * 60 * 1000 // 1 day
                    }).catch(() => {
                        console.log('Periodic sync not supported');
                    });
                });
            }
            
            // Background sync for offline data
            if ('serviceWorker' in navigator && 'SyncManager' in window) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.sync.register('sync-offline-docs');
                });
            }
            
            // Push notifications permission
            if ('Notification' in window && Notification.permission === 'default') {
                requestNotificationPermission();
            }
        }
        
        // Update connection status
        function updateConnectionStatus() {
            isOnline = navigator.onLine;
            const connectionStatus = document.getElementById('connectionStatus');
            const offlineIndicator = document.getElementById('offlineIndicator');
            const offlineSaveBtn = document.getElementById('offline-save-btn');
            const pwaHeaderStatus = document.getElementById('pwaHeaderStatus');
            
            if (isOnline) {
                connectionStatus.textContent = 'Online';
                connectionStatus.className = 'pwa-status-value online';
                offlineIndicator.style.display = 'none';
                offlineSaveBtn.style.display = 'none';
                
                // Update header status
                if (pwaHeaderStatus) {
                    pwaHeaderStatus.innerHTML = '<i class="fas fa-check-circle"></i> Online';
                    pwaHeaderStatus.style.background = 'var(--kingu-light)';
                    pwaHeaderStatus.style.color = 'var(--kingu-green)';
                    pwaHeaderStatus.style.display = 'inline-block';
                }
                
                // Sync offline data
                syncOfflineData();
            } else {
                connectionStatus.textContent = 'Offline';
                connectionStatus.className = 'pwa-status-value offline';
                offlineIndicator.style.display = 'block';
                offlineSaveBtn.style.display = 'inline-flex';
                
                // Update header status
                if (pwaHeaderStatus) {
                    pwaHeaderStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Offline';
                    pwaHeaderStatus.style.background = 'var(--kingu-red)';
                    pwaHeaderStatus.style.color = 'white';
                    pwaHeaderStatus.style.display = 'inline-block';
                }
            }
        }
        
        // Update app mode
        function updateAppMode() {
            const appMode = document.getElementById('appMode');
            isInstalled = window.matchMedia('(display-mode: standalone)').matches;
            
            if (isInstalled) {
                appMode.textContent = 'Installed';
                appMode.className = 'pwa-status-value installed';
            } else {
                appMode.textContent = 'Browser';
                appMode.className = 'pwa-status-value browser';
            }
        }
        
        // Check storage usage
        function checkStorageUsage() {
            if (navigator.storage && navigator.storage.estimate) {
                navigator.storage.estimate().then(estimate => {
                    const usedMB = (estimate.usage / (1024 * 1024)).toFixed(2);
                    const quotaMB = (estimate.quota / (1024 * 1024)).toFixed(2);
                    const percentage = ((estimate.usage / estimate.quota) * 100).toFixed(1);
                    
                    const storageStatus = document.getElementById('storageStatus');
                    storageStatus.textContent = `${percentage}% used`;
                    storageStatus.title = `${usedMB} MB / ${quotaMB} MB`;
                    
                    // Color code based on usage
                    if (percentage > 90) {
                        storageStatus.style.color = '#e63946';
                    } else if (percentage > 70) {
                        storageStatus.style.color = '#ff6b35';
                    } else {
                        storageStatus.style.color = '#4CAF50';
                    }
                });
            }
        }
        
        // Update offline document count
        function updateOfflineDocCount() {
            const offlineDocs = JSON.parse(localStorage.getItem('offlineDocuments') || '[]');
            const offlineDocCount = document.getElementById('offlineDocCount');
            offlineDocCount.textContent = offlineDocs.length;
            
            if (offlineDocs.length > 0) {
                offlineDocCount.style.color = '#ff6b35';
                offlineDocCount.title = `${offlineDocs.length} documents waiting to sync`;
            } else {
                offlineDocCount.style.color = '#4CAF50';
            }
        }
        
        // Sync offline data
        function syncOfflineData() {
            const offlineDocs = JSON.parse(localStorage.getItem('offlineDocuments') || '[]');
            
            if (offlineDocs.length > 0 && isOnline) {
                const syncNotification = document.getElementById('syncNotification');
                const syncNotificationText = document.getElementById('syncNotificationText');
                
                syncNotificationText.textContent = `Syncing ${offlineDocs.length} offline document(s)...`;
                syncNotification.style.display = 'flex';
                
                // Simulate sync process
                setTimeout(() => {
                    offlineDocs.forEach(doc => {
                        let documents = JSON.parse(localStorage.getItem('kinguDocuments') || '[]');
                        documents.push(doc);
                        localStorage.setItem('kinguDocuments', JSON.stringify(documents));
                    });
                    
                    localStorage.removeItem('offlineDocuments');
                    
                    syncNotificationText.textContent = 'Sync complete!';
                    syncNotification.style.background = '#116a41';
                    
                    setTimeout(() => {
                        syncNotification.style.display = 'none';
                        syncNotification.style.background = '#2980b9';
                        updateOfflineDocCount();
                        showNotification(`${offlineDocs.length} document(s) synced successfully!`, 'success');
                    }, 2000);
                }, 2000);
            }
        }
        
        // Show install notification
        function showInstallNotification() {
            const pwaNotification = document.getElementById('pwaNotification');
            const pwaNotificationText = document.getElementById('pwaNotificationText');
            
            if (!isInstalled && deferredPrompt) {
                pwaNotificationText.textContent = 'Install Kingu Invoice App for better experience';
                pwaNotification.style.display = 'flex';
            }
        }
        
        // Show update notification
        function showUpdateNotification() {
            const pwaNotification = document.getElementById('pwaNotification');
            const pwaNotificationText = document.getElementById('pwaNotificationText');
            
            pwaNotificationText.textContent = 'New update available! Refresh to update.';
            pwaNotification.style.display = 'flex';
            
            // Change install button to refresh
            const installBtn = pwaNotification.querySelector('.btn-success');
            installBtn.innerHTML = '<i class="fas fa-redo"></i> Refresh';
            installBtn.onclick = () => location.reload();
        }
        
        // Install app
        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log('App installed');
                    showNotification('App installation started!', 'success');
                }
                
                deferredPrompt = null;
                dismissPwaNotification();
            }
        }
        
        // Dismiss PWA notification
        function dismissPwaNotification() {
            const pwaNotification = document.getElementById('pwaNotification');
            pwaNotification.style.display = 'none';
            localStorage.setItem('installPromptDismissed', 'true');
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ${type === 'success' ? '#116a41' : type === 'error' ? '#e63946' : '#2980b9'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                max-width: 300px;
                animation: slideIn 0.3s ease-out;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // Request notification permission
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('Notification permission granted');
                    }
                });
            }
        }
        
        // Check for updates
        function checkForUpdates() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.update();
                });
            }
        }
        
        // Show loading screen
        function showLoadingScreen() {
            const loadingScreen = document.getElementById('pwaLoading');
            loadingScreen.style.display = 'flex';
        }
        
        // Update loading progress
        function updateLoadingProgress(percent) {
            const progressBar = document.getElementById('loadingProgress');
            const loadingText = document.getElementById('loadingText');
            
            if (progressBar) {
                progressBar.style.width = percent + '%';
            }
            
            if (loadingText) {
                const messages = [
                    'Loading Kingu Invoice System...',
                    'Initializing PWA features...',
                    'Setting up offline storage...',
                    'Loading your documents...',
                    'Almost ready...'
                ];
                
                const messageIndex = Math.min(Math.floor(percent / 20), messages.length - 1);
                loadingText.textContent = messages[messageIndex];
            }
        }
        
        // Hide loading screen
        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('pwaLoading');
            loadingScreen.style.opacity = '0';
            
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 500);
        }
        
        // Initialize main application (your existing code)
        function initializeMainApplication() {
            // Your existing application initialization code goes here
            // I'll keep it brief to avoid duplication
            
            // Set current date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('invoice-date').value = today;
            
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            document.getElementById('due-date').value = dueDate.toISOString().split('T')[0];
            
            // Update app mode
            updateAppMode();
            
            // Enhanced save functionality with offline support
            const saveBtn = document.getElementById('save-btn');
            const offlineSaveBtn = document.getElementById('offline-save-btn');
            
            saveBtn.addEventListener('click', function() {
                const formData = collectFormData();
                const docId = Date.now();
                
                const documentData = {
                    ...formData,
                    id: docId,
                    savedDate: new Date().toISOString(),
                    status: 'pending',
                    documentType: formData.type,
                    createdBy: 'System User',
                    lastModified: new Date().toISOString(),
                    isOffline: !isOnline
                };
                
                if (isOnline) {
                    // Save normally
                    let documents = JSON.parse(localStorage.getItem('kinguDocuments') || '[]');
                    documents.push(documentData);
                    localStorage.setItem('kinguDocuments', JSON.stringify(documents));
                    
                    saveToSpecificCollection(formData.type, documentData);
                    showSaveSuccess(documentData, false);
                } else {
                    // Save to offline queue
                    let offlineDocuments = JSON.parse(localStorage.getItem('offlineDocuments') || '[]');
                    offlineDocuments.push(documentData);
                    localStorage.setItem('offlineDocuments', JSON.stringify(offlineDocuments));
                    
                    showSaveSuccess(documentData, true);
                    updateOfflineDocCount();
                }
            });
            
            offlineSaveBtn.addEventListener('click', function() {
                saveBtn.click();
            });
            
            // Update connection status initially
            updateConnectionStatus();
        }
        
        // Helper functions for form data collection (from your existing code)
        function collectFormData() {
            const type = getCurrentDocumentType();
            const items = [];
            
            document.querySelectorAll('#invoice-items tr').forEach(row => {
                const description = row.querySelector('.item-description')?.value || '';
                const quantity = parseFloat(row.querySelector('.item-quantity')?.value || 0);
                const price = parseFloat(row.querySelector('.item-price')?.value || 0);
                const total = quantity * price;
                
                if (description) {
                    items.push({
                        description,
                        quantity,
                        price,
                        total
                    });
                }
            });
            
            // ... rest of your collectFormData function
            return {
                type: type,
                documentNumber: document.getElementById('invoice-number').value,
                documentDate: document.getElementById('invoice-date').value,
                dueDate: document.getElementById('due-date').value,
                currency: document.getElementById('currency').value,
                deliveryTime: document.getElementById('delivery-time').value,
                paymentTerms: document.getElementById('payment-terms').value,
                customPaymentTerms: document.getElementById('custom-payment-terms')?.value || '',
                clientName: document.getElementById('client-name').value,
                clientEmail: document.getElementById('client-email').value,
                clientPhone: document.getElementById('client-phone').value,
                clientAddress: document.getElementById('client-address').value,
                clientTIN: document.getElementById('client-tin').value,
                clientVAT: document.getElementById('client-vat').value,
                items: items,
                subtotal: 0, // Calculate these
                discountType: document.getElementById('discount-type').value,
                discountValue: parseFloat(document.getElementById('discount-value')?.value || 0),
                discountAmount: 0,
                vatType: document.querySelector('input[name="vat-option"]:checked')?.value || 'none',
                vatRate: 0,
                vatAmount: 0,
                vatNumber: document.getElementById('vat-number-input')?.value || '',
                grandTotal: 0,
                bankDetails: document.getElementById('bank-details').value,
                notes: document.getElementById('notes').value
            };
        }
        
        function getCurrentDocumentType() {
            if (document.getElementById('btn-proforma').classList.contains('active')) {
                return 'Proforma';
            } else if (document.getElementById('btn-standard').classList.contains('active')) {
                return 'Standard';
            } else if (document.getElementById('btn-quotation').classList.contains('active')) {
                return 'Quotation';
            }
            return 'Proforma';
        }
        
        function saveToSpecificCollection(type, documentData) {
            // Your existing implementation
        }
        
        function showSaveSuccess(documentData, isOffline) {
            // Your existing implementation
            showNotification(
                `${documentData.type} ${isOffline ? 'saved offline' : 'saved successfully'}!`,
                isOffline ? 'info' : 'success'
            );
        }
        
        // Expose functions to global scope
        window.installApp = installApp;
        window.dismissPwaNotification = dismissPwaNotification;
        window.trySyncNow = syncOfflineData;
        
        // Add CSS animations for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>

    <!-- Main Application Script (your existing code) -->
    <script>
        // Main Application
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize all variables
            const invoiceForm = document.getElementById('invoice-form');
            const a4Preview = document.getElementById('a4-preview');
            const clientDatabase = document.getElementById('client-database');
            const proformaInvoices = document.getElementById('proforma-invoices');
            const invoiceHistory = document.getElementById('invoice-history');
            const reportsSection = document.getElementById('reports-section');
            const settingsSection = document.getElementById('settings-section');
            const typeSelector = document.getElementById('type-selector');
            const mainHeader = document.getElementById('main-header');
            
            // Navigation buttons
            const navCreate = document.getElementById('nav-create');
            const navProforma = document.getElementById('nav-proforma');
            const navHistory = document.getElementById('nav-history');
            const navClients = document.getElementById('nav-clients');
            const navReports = document.getElementById('nav-reports');
            const navSettings = document.getElementById('nav-settings');
            
            // Hide all sections initially except invoice form
            hideAllSections();
            invoiceForm.style.display = 'block';
            
            // Navigation event listeners
            navCreate.addEventListener('click', function() {
                setActiveNav(this);
                hideAllSections();
                invoiceForm.style.display = 'block';
                typeSelector.style.display = 'flex';
                mainHeader.style.display = 'flex';
                updatePageTitle('Create Proforma Invoice');
            });
            
            navProforma.addEventListener('click', function() {
                setActiveNav(this);
                hideAllSections();
                proformaInvoices.style.display = 'block';
                typeSelector.style.display = 'none';
                mainHeader.style.display = 'flex';
                updatePageTitle('Proforma Invoices');
                loadProformaInvoices();
            });
            
            navHistory.addEventListener('click', function() {
                setActiveNav(this);
                hideAllSections();
                invoiceHistory.style.display = 'block';
                typeSelector.style.display = 'none';
                mainHeader.style.display = 'flex';
                updatePageTitle('Document History');
                loadDocumentHistory();
            });
            
            navClients.addEventListener('click', function() {
                setActiveNav(this);
                hideAllSections();
                clientDatabase.style.display = 'block';
                typeSelector.style.display = 'none';
                mainHeader.style.display = 'flex';
                updatePageTitle('Client Database');
                loadClientDatabase();
            });
            
            navReports.addEventListener('click', function() {
                setActiveNav(this);
                hideAllSections();
                reportsSection.style.display = 'block';
                typeSelector.style.display = 'none';
                mainHeader.style.display = 'flex';
                updatePageTitle('Reports & Analytics');
                loadReports();
            });
            
            navSettings.addEventListener('click', function() {
                setActiveNav(this);
                hideAllSections();
                settingsSection.style.display = 'block';
                typeSelector.style.display = 'none';
                mainHeader.style.display = 'flex';
                updatePageTitle('System Settings');
                loadSettings();
            });
            
            // Helper functions
            function setActiveNav(activeElement) {
                document.querySelectorAll('.nav-link').forEach(nav => {
                    nav.classList.remove('active');
                });
                activeElement.classList.add('active');
            }
            
            function hideAllSections() {
                invoiceForm.style.display = 'none';
                a4Preview.style.display = 'none';
                clientDatabase.style.display = 'none';
                proformaInvoices.style.display = 'none';
                invoiceHistory.style.display = 'none';
                reportsSection.style.display = 'none';
                settingsSection.style.display = 'none';
                
                document.getElementById('print-btn').style.display = 'none';
                document.getElementById('pdf-btn').style.display = 'none';
            }
            
            function updatePageTitle(title) {
                document.getElementById('page-title').textContent = title;
            }
            
            // Initialize VAT options
            function initializeVatOptions() {
                // VAT option change listener
                document.querySelectorAll('input[name="vat-option"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        const vatCustomContainer = document.getElementById('vat-custom-container');
                        const vatRow = document.getElementById('vat-row');
                        const taxOptions = document.querySelectorAll('.tax-option');
                        
                        // Update active state for tax options
                        taxOptions.forEach(option => option.classList.remove('active'));
                        this.closest('.tax-option').classList.add('active');
                        
                        if (this.value === 'none') {
                            vatCustomContainer.style.display = 'none';
                            vatRow.style.display = 'none';
                        } else if (this.value === 'standard') {
                            vatCustomContainer.style.display = 'none';
                            vatRow.style.display = 'flex';
                            // Update VAT label
                            document.querySelector('#vat-row .total-label').textContent = 'VAT (18%):';
                        } else if (this.value === 'custom') {
                            vatCustomContainer.style.display = 'block';
                            vatRow.style.display = 'flex';
                            // Update VAT label with custom rate
                            const customRate = document.getElementById('custom-vat-rate').value || 0;
                            document.querySelector('#vat-row .total-label').textContent = `Tax (${customRate}%):`;
                        }
                        
                        updateTotals();
                    });
                });
                
                // Custom VAT rate change listener
                document.getElementById('custom-vat-rate').addEventListener('input', function() {
                    if (document.querySelector('input[name="vat-option"]:checked').value === 'custom') {
                        document.querySelector('#vat-row .total-label').textContent = `Tax (${this.value}%):`;
                        updateTotals();
                    }
                });
            }
            
            // Initialize invoice form
            function initializeInvoiceForm() {
                document.addEventListener('input', function(e) {
                    if (e.target.classList.contains('item-quantity') || 
                        e.target.classList.contains('item-price')) {
                        updateItemTotal(e.target.closest('tr'));
                        updateTotals();
                    }
                });
                
                document.getElementById('add-item-btn').addEventListener('click', function() {
                    addNewItem();
                });
                
                document.addEventListener('click', function(e) {
                    if (e.target.closest('.delete-item')) {
                        e.target.closest('tr').remove();
                        updateTotals();
                    }
                });
                
                document.getElementById('discount-type').addEventListener('change', function() {
                    const discountValueContainer = document.getElementById('discount-value-container');
                    const discountRow = document.getElementById('discount-row');
                    
                    if (this.value === 'none') {
                        discountValueContainer.style.display = 'none';
                        discountRow.style.display = 'none';
                    } else {
                        discountValueContainer.style.display = 'block';
                        discountRow.style.display = 'flex';
                        
                        if (this.value === 'percentage') {
                            document.getElementById('discount-label').textContent = 'Discount (%):';
                        } else {
                            document.getElementById('discount-label').textContent = 'Discount (Amount):';
                        }
                    }
                    updateTotals();
                });
                
                document.getElementById('discount-value').addEventListener('input', updateTotals);
                
                document.getElementById('payment-terms').addEventListener('change', function() {
                    const customTermsContainer = document.getElementById('custom-terms-container');
                    if (this.value === 'Custom') {
                        customTermsContainer.style.display = 'flex';
                    } else {
                        customTermsContainer.style.display = 'none';
                    }
                });
                
                // Set current date
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('invoice-date').value = today;
                
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 30);
                document.getElementById('due-date').value = dueDate.toISOString().split('T')[0];
            }
            
            // Update item total
            function updateItemTotal(row) {
                const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const total = quantity * price;
                const currency = document.getElementById('currency').value;
                const currencySymbol = getCurrencySymbol(currency);
                
                row.querySelector('.item-total').textContent = 
                    `${currencySymbol} ${total.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
            }
            
            // Update totals
            function updateTotals() {
                let subtotal = 0;
                
                document.querySelectorAll('#invoice-items tr').forEach(row => {
                    const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                    const price = parseFloat(row.querySelector('.item-price').value) || 0;
                    subtotal += quantity * price;
                });
                
                const discountType = document.getElementById('discount-type').value;
                const discountValue = parseFloat(document.getElementById('discount-value').value) || 0;
                let discountAmount = 0;
                
                if (discountType === 'percentage') {
                    discountAmount = (subtotal * discountValue) / 100;
                } else if (discountType === 'fixed') {
                    discountAmount = discountValue;
                }
                
                const taxable = subtotal - discountAmount;
                
                // VAT calculation
                const vatOption = document.querySelector('input[name="vat-option"]:checked');
                const vatType = vatOption ? vatOption.value : 'none';
                let vatRate = 0;
                let vatAmount = 0;
                let grandTotal = taxable;
                
                if (vatType !== 'none') {
                    if (vatType === 'standard') {
                        vatRate = 18;
                    } else if (vatType === 'custom') {
                        vatRate = parseFloat(document.getElementById('custom-vat-rate').value) || 0;
                    }
                    vatAmount = (taxable * vatRate) / 100;
                    grandTotal = taxable + vatAmount;
                    
                    // Update VAT row
                    const vatRow = document.getElementById('vat-row');
                    vatRow.style.display = 'flex';
                    const vatLabel = vatRow.querySelector('.total-label');
                    const vatTypeLabel = vatType === 'standard' ? 'VAT' : 'Tax';
                    vatLabel.textContent = `${vatTypeLabel} (${vatRate}%):`;
                    document.getElementById('tax').textContent = 
                        `${getCurrencySymbol(document.getElementById('currency').value)} ${vatAmount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
                } else {
                    document.getElementById('vat-row').style.display = 'none';
                }
                
                const currency = document.getElementById('currency').value;
                const currencySymbol = getCurrencySymbol(currency);
                
                document.getElementById('subtotal').textContent = 
                    `${currencySymbol} ${subtotal.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
                
                document.getElementById('discount-amount').textContent = 
                    `${currencySymbol} ${discountAmount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
                
                document.getElementById('grand-total').textContent = 
                    `${currencySymbol} ${grandTotal.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
                
                document.getElementById('amount-words').textContent = 
                    convertNumberToWords(grandTotal) + ' ' + currency + ' only';
            }
            
            // Add new item
            function addNewItem() {
                const itemsTable = document.getElementById('invoice-items');
                const currency = document.getElementById('currency').value;
                const currencySymbol = getCurrencySymbol(currency);
                
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td><input type="text" class="item-description" placeholder="Enter item description"></td>
                    <td><input type="number" class="item-quantity" min="0" step="0.01" value="1.00"></td>
                    <td>
                        <div style="display: flex; align-items: center;">
                            <span class="currency-symbol" style="margin-right: 5px;">${currencySymbol}</span>
                            <input type="number" class="item-price" min="0" step="0.01" value="0.00" style="flex: 1;">
                        </div>
                    </td>
                    <td class="item-total text-right">${currencySymbol} 0.00</td>
                    <td class="text-center"><button class="delete-item"><i class="fas fa-trash"></i></button></td>
                `;
                itemsTable.appendChild(newRow);
            }
            
            // Get currency symbol
            function getCurrencySymbol(currency) {
                switch(currency) {
                    case 'USD': return '$';
                    case 'EUR': return '€';
                    case 'GBP': return '£';
                    default: return 'TSh';
                }
            }
            
            // Convert number to words
            function convertNumberToWords(num) {
                const units = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
                const teens = ['ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen'];
                const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
                
                if (num === 0) return 'zero';
                
                let words = '';
                
                const thousands = Math.floor(num / 1000);
                if (thousands > 0) {
                    words += convertNumberToWords(thousands) + ' thousand ';
                    num %= 1000;
                }
                
                const hundreds = Math.floor(num / 100);
                if (hundreds > 0) {
                    words += units[hundreds] + ' hundred ';
                    num %= 100;
                }
                
                if (num > 0) {
                    if (words !== '') words += 'and ';
                    
                    if (num < 10) {
                        words += units[num];
                    } else if (num < 20) {
                        words += teens[num - 10];
                    } else {
                        words += tens[Math.floor(num / 10)];
                        if (num % 10 > 0) {
                            words += '-' + units[num % 10];
                        }
                    }
                }
                
                return words.trim();
            }
            
            // Initialize the application
            initializeInvoiceForm();
            initializeVatOptions();
            
            // Your existing functions for loadReports, loadDocumentHistory, etc.
            // These would be included here...
            
        });
    </script>
</body>
</html>
