<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KINGU ELECTRICAL COMPANY LIMITED - Invoice System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF Library for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --kingu-green: #116a41;        /* Primary green from "Kingu" text */
            --kingu-red: #e63946;          /* Red from "Electrical" text */
            --kingu-yellow-start: #ffae42; /* Light bulb gradient start */
            --kingu-yellow-end: #ffea00;   /* Light bulb gradient end */
            --kingu-dark: #0a4d2a;         /* Darker green for headers */
            --kingu-light: #e8f5e9;        /* Light green background */
            --kingu-accent: #ff6b35;       /* Orange for highlights */
            --kingu-success: #2a9d8f;      /* Green for success */
            --kingu-white: #ffffff;        /* White background */
            --kingu-blue: #2980b9;         /* Blue for quotations */
        }

        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: linear-gradient(135deg, var(--kingu-green) 0%, var(--kingu-dark) 100%);
            color: white;
            padding: 25px 20px;
            box-shadow: 2px 0 15px rgba(17, 106, 65, 0.3);
        }

        .logo-container {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--kingu-yellow-start) 0%, var(--kingu-yellow-end) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }

        .logo:before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            background: white;
            border-radius: 50%;
            z-index: 1;
        }

        .logo i {
            font-size: 28px;
            color: var(--kingu-red);
            z-index: 2;
            position: relative;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .company-header {
            line-height: 1.2;
            margin-bottom: 3px;
        }

        .company-header .kingu {
            font-size: 20px;
            font-weight: 800;
            color: white;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            display: block;
        }

        .company-header .electrical {
            font-size: 16px;
            font-weight: 700;
            color: var(--kingu-red);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            display: block;
            margin-top: -2px;
        }

        .company-full-name {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 2px;
            font-weight: 500;
            line-height: 1;
        }

        .company-tagline {
            font-size: 11px;
            opacity: 0.9;
            margin-top: 8px;
            color: rgba(255, 255, 255, 0.9);
            font-style: italic;
            line-height: 1.3;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 5px;
        }

        .nav-menu {
            list-style: none;
            margin-top: 30px;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            color: white;
            text-decoration: none;
            padding: 12px 15px;
            border-radius: 8px;
            transition: all 0.3s;
            border-left: 3px solid transparent;
            cursor: pointer;
        }

        .nav-link i {
            margin-right: 12px;
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.15);
            border-left: 3px solid var(--kingu-red);
        }

        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-left: 3px solid var(--kingu-red);
            font-weight: 600;
        }

        /* Company Info in Sidebar */
        .company-info-sidebar {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 13px;
        }

        .company-info-sidebar p {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            line-height: 1.4;
        }

        .company-info-sidebar i {
            margin-right: 10px;
            margin-top: 3px;
            color: var(--kingu-yellow-end);
            min-width: 16px;
        }

        .contact-badge {
            display: inline-block;
            background-color: var(--kingu-red);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            font-weight: bold;
        }

        /* Contact Badges */
        .contact-badges {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .contact-badge-small {
            display: inline-flex;
            align-items: center;
            background-color: var(--kingu-light);
            color: var(--kingu-green);
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 600;
            border: 1px solid rgba(17, 106, 65, 0.2);
        }

        .contact-badge-small i {
            margin-right: 5px;
            font-size: 14px;
        }

        .whatsapp-badge {
            background-color: rgba(37, 211, 102, 0.1);
            color: #128C7E;
            border-color: rgba(37, 211, 102, 0.3);
        }

        .email-badge {
            background-color: rgba(66, 133, 244, 0.1);
            color: #4285f4;
            border-color: rgba(66, 133, 244, 0.3);
        }

        .color-scheme {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .color-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .green { background-color: var(--kingu-green); }
        .red { background-color: var(--kingu-red); }
        .yellow-start { background-color: var(--kingu-yellow-start); }
        .yellow-end { background-color: var(--kingu-yellow-end); }
        .blue { background-color: var(--kingu-blue); }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background-color: var(--kingu-white);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--kingu-light);
        }

        .header h1 {
            color: var(--kingu-green);
            font-size: 28px;
            position: relative;
            padding-left: 15px;
        }

        .header h1:before {
            content: '';
            position: absolute;
            left: 0;
            top: 5px;
            bottom: 5px;
            width: 4px;
            background: linear-gradient(to bottom, var(--kingu-green), var(--kingu-red));
            border-radius: 2px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background-color: var(--kingu-green);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--kingu-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(17, 106, 65, 0.2);
        }

        .btn-success {
            background-color: var(--kingu-success);
            color: white;
        }

        .btn-success:hover {
            background-color: #21867a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(42, 157, 143, 0.2);
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
            transform: translateY(-2px);
        }

        .btn-accent {
            background-color: var(--kingu-red);
            color: white;
        }

        .btn-accent:hover {
            background-color: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(230, 57, 70, 0.2);
        }

        .btn-whatsapp {
            background-color: #25D366;
            color: white;
        }

        .btn-whatsapp:hover {
            background-color: #128C7E;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.2);
        }

        .btn-pdf {
            background-color: #d32f2f;
            color: white;
        }

        .btn-pdf:hover {
            background-color: #b71c1c;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(211, 47, 47, 0.2);
        }

        .btn i {
            margin-right: 8px;
        }

        /* Invoice Type Selector */
        .invoice-type-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(17, 106, 65, 0.1);
            border-left: 4px solid var(--kingu-green);
        }

        .type-btn {
            padding: 10px 25px;
            border: 2px solid var(--kingu-green);
            background: white;
            color: var(--kingu-green);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .type-btn.active {
            background: var(--kingu-green);
            color: white;
        }

        .type-btn.quotation-active {
            background: var(--kingu-blue);
            color: white;
            border-color: var(--kingu-blue);
        }

        .type-btn:hover:not(.active):not(.quotation-active) {
            background-color: var(--kingu-light);
        }

        /* Invoice Form Container */
        .invoice-form-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(17, 106, 65, 0.1);
            padding: 30px;
            margin-bottom: 30px;
            border-top: 4px solid var(--kingu-green);
            max-width: 100%;
            overflow-x: hidden;
        }

        .quotation-form-container {
            border-top: 4px solid var(--kingu-blue);
        }

        .form-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 18px;
            color: var(--kingu-green);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--kingu-light);
            display: flex;
            align-items: center;
        }

        .quotation-section-title {
            color: var(--kingu-blue);
        }

        .section-title i {
            margin-right: 10px;
            color: var(--kingu-red);
        }

        .quotation-section-title i {
            color: var(--kingu-blue);
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -15px;
        }

        .form-group {
            flex: 1;
            min-width: 250px;
            padding: 0 15px;
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--kingu-dark);
            font-size: 14px;
        }

        .quotation-form-group label {
            color: var(--kingu-blue);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--kingu-green);
            box-shadow: 0 0 0 3px rgba(17, 106, 65, 0.1);
        }

        .quotation-control:focus {
            border-color: var(--kingu-blue);
            box-shadow: 0 0 0 3px rgba(41, 128, 185, 0.1);
        }

        /* Proforma Specific Fields */
        .proforma-fields {
            background-color: var(--kingu-light);
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid var(--kingu-red);
        }

        .quotation-fields {
            background-color: rgba(41, 128, 185, 0.1);
            border-left: 4px solid var(--kingu-blue);
        }

        /* Invoice Items Table */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .items-table thead {
            background-color: var(--kingu-green);
        }

        .quotation-items-table thead {
            background-color: var(--kingu-blue);
        }

        .items-table th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: white;
            border-bottom: 2px solid var(--kingu-dark);
        }

        .quotation-items-table th {
            border-bottom: 2px solid #1a5276;
        }

        .items-table td {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        .items-table tr:hover {
            background-color: #f9fafb;
        }

        .items-table input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        .delete-item {
            background-color: var(--kingu-red);
            color: white;
            border: none;
            border-radius: 4px;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .delete-item:hover {
            background-color: #c62828;
            transform: scale(1.05);
        }

        .add-item-btn {
            margin-top: 15px;
            background-color: var(--kingu-light);
            color: var(--kingu-green);
            border: 2px dashed var(--kingu-green);
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            transition: all 0.3s;
        }

        .quotation-add-item-btn {
            background-color: rgba(41, 128, 185, 0.1);
            color: var(--kingu-blue);
            border: 2px dashed var(--kingu-blue);
        }

        .add-item-btn:hover {
            background-color: var(--kingu-green);
            color: white;
            border-color: var(--kingu-green);
        }

        .quotation-add-item-btn:hover {
            background-color: var(--kingu-blue);
            color: white;
            border-color: var(--kingu-blue);
        }

        .add-item-btn i {
            margin-right: 8px;
        }

        /* Totals Section */
        .totals-section {
            background: linear-gradient(135deg, #f8fafc 0%, var(--kingu-light) 100%);
            padding: 25px;
            border-radius: 8px;
            margin-top: 30px;
            border-left: 4px solid var(--kingu-green);
        }

        .quotation-totals-section {
            background: linear-gradient(135deg, #f8fafc 0%, rgba(41, 128, 185, 0.1) 100%);
            border-left: 4px solid var(--kingu-blue);
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(17, 106, 65, 0.1);
        }

        .quotation-total-row {
            border-bottom: 1px solid rgba(41, 128, 185, 0.2);
        }

        .total-label {
            font-weight: 600;
            color: var(--kingu-dark);
        }

        .quotation-total-label {
            color: var(--kingu-blue);
        }

        .total-value {
            font-weight: 700;
            color: var(--kingu-green);
        }

        .quotation-total-value {
            color: var(--kingu-blue);
        }

        .grand-total {
            font-size: 20px;
            border-top: 2px solid var(--kingu-green);
            margin-top: 10px;
            padding-top: 15px;
            color: var(--kingu-dark);
        }

        .quotation-grand-total {
            border-top: 2px solid var(--kingu-blue);
            color: var(--kingu-blue);
        }

        /* Invoice Preview - Optimized for A4 */
        .invoice-preview-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(17, 106, 65, 0.1);
            padding: 30px; /* Reduced padding for better A4 fit */
            margin-top: 30px;
            display: none;
            border-top: 4px solid var(--kingu-green);
            max-width: 800px; /* Limit width for A4 */
            margin-left: auto;
            margin-right: auto;
            font-size: 12px; /* Smaller font for better fit */
        }

        .quotation-preview-container {
            border-top: 4px solid var(--kingu-blue);
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px; /* Reduced */
            padding-bottom: 15px;
            border-bottom: 2px solid var(--kingu-light);
            flex-wrap: wrap;
        }

        .invoice-company-logo {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            max-width: 250px; /* Reduced for A4 */
            flex: 1;
            min-width: 200px;
        }

        .company-logo-text {
            font-family: 'Georgia', serif;
        }

        .kingu-logo {
            font-size: 36px; /* Reduced from 48px */
            font-weight: 900;
            color: var(--kingu-green);
            line-height: 0.9;
            margin-bottom: 3px;
            display: block;
        }

        .electrical-logo {
            font-size: 28px; /* Reduced from 36px */
            font-weight: 700;
            color: var(--kingu-red);
            line-height: 0.9;
            margin-bottom: 5px;
            display: block;
            margin-left: 0;
        }

        .company-logo {
            font-size: 16px; /* Reduced from 20px */
            font-weight: 700;
            color: var(--kingu-dark);
            margin-bottom: 8px;
            border-top: 2px solid var(--kingu-light);
            padding-top: 8px;
            margin-top: 3px;
        }

        .tagline-logo {
            font-size: 11px; /* Reduced from 14px */
            color: #666;
            font-style: italic;
            line-height: 1.3;
            margin-bottom: 10px;
        }

        .contact-info-logo {
            font-size: 11px; /* Reduced from 13px */
            color: #555;
            line-height: 1.4;
        }

        .contact-info-logo .phone-numbers {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin: 3px 0;
        }

        .contact-info-logo .phone-numbers span {
            background-color: var(--kingu-light);
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid rgba(17, 106, 65, 0.2);
            display: inline-block;
            width: fit-content;
            font-size: 10px;
        }

        .contact-info-logo .email {
            color: var(--kingu-green);
            font-weight: 600;
            margin: 3px 0;
            font-size: 11px;
        }

        .contact-info-logo .address {
            font-size: 10px; /* Reduced from 12px */
            color: #777;
            margin-top: 3px;
        }

        .company-tin {
            font-size: 10px; /* Reduced from 12px */
            color: #555;
            font-weight: 600;
            margin-top: 5px;
            padding: 2px 6px;
            background-color: var(--kingu-light);
            border-radius: 3px;
            display: inline-block;
            border: 1px solid rgba(17, 106, 65, 0.2);
        }

        .invoice-title {
            font-size: 24px; /* Reduced from 32px */
            color: var(--kingu-green);
            text-align: right;
            font-weight: 700;
            flex: 1;
            min-width: 200px;
            margin-top: 10px;
        }

        .quotation-title {
            color: var(--kingu-blue);
        }

        .invoice-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px; /* Reduced */
            gap: 20px;
            flex-wrap: wrap;
        }

        .company-info, .client-info {
            flex: 1;
            min-width: 200px;
        }

        .info-title {
            font-weight: 700;
            color: var(--kingu-green);
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--kingu-light);
            font-size: 14px; /* Reduced from 16px */
        }

        .quotation-info-title {
            color: var(--kingu-blue);
        }

        .company-details p, .client-details p {
            margin-bottom: 6px;
            color: #555;
            font-size: 12px;
        }

        .invoice-info {
            flex: 0.8;
            min-width: 200px;
        }

        .invoice-info-box {
            background-color: var(--kingu-light);
            padding: 15px;
            border-radius: 6px;
            border-left: 3px solid var(--kingu-green);
            font-size: 12px;
        }

        .quotation-info-box {
            background-color: rgba(41, 128, 185, 0.1);
            border-left: 3px solid var(--kingu-blue);
        }

        .invoice-info-box p {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .invoice-info-box strong {
            color: var(--kingu-dark);
        }

        .quotation-info-box strong {
            color: var(--kingu-blue);
        }

        .invoice-items-preview {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
            font-size: 11px;
        }

        .invoice-items-preview thead {
            background-color: var(--kingu-green);
        }

        .quotation-items-preview thead {
            background-color: var(--kingu-blue);
        }

        .invoice-items-preview th {
            padding: 12px 8px; /* Reduced padding */
            text-align: left;
            font-weight: 700;
            color: white;
            border-bottom: 2px solid var(--kingu-dark);
            font-size: 12px;
        }

        .quotation-items-preview th {
            border-bottom: 2px solid #1a5276;
        }

        .invoice-items-preview td {
            padding: 10px 8px; /* Reduced padding */
            border-bottom: 1px solid #e5e7eb;
            font-size: 11px;
        }

        .invoice-items-preview tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }

        .invoice-totals {
            width: 300px; /* Reduced from 350px */
            margin-left: auto;
            margin-top: 20px;
            background: var(--kingu-light);
            padding: 20px;
            border-radius: 6px;
            border-left: 3px solid var(--kingu-green);
            font-size: 12px;
        }

        .quotation-totals {
            background: rgba(41, 128, 185, 0.1);
            border-left: 3px solid var(--kingu-blue);
        }

        .terms-section {
            background-color: #f8fafc;
            padding: 20px;
            border-radius: 6px;
            margin-top: 30px;
            border-left: 3px solid var(--kingu-red);
            font-size: 11px;
        }

        .quotation-terms-section {
            border-left: 3px solid var(--kingu-blue);
        }

        .terms-title {
            color: var(--kingu-green);
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .quotation-terms-title {
            color: var(--kingu-blue);
        }

        .terms-title i {
            margin-right: 8px;
            color: var(--kingu-red);
            font-size: 14px;
        }

        .quotation-terms-title i {
            color: var(--kingu-blue);
        }

        .terms-content p {
            margin-bottom: 8px;
            color: #555;
            font-size: 11px;
            line-height: 1.4;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }

        /* Footer Styles */
        .invoice-footer {
            margin-top: 40px; /* Reduced */
            padding-top: 20px;
            border-top: 2px solid var(--kingu-light);
            text-align: center;
            font-size: 11px;
        }

        .authorized-signature {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .signature-line {
            width: 250px; /* Reduced from 300px */
            height: 1px;
            background-color: #333;
            margin: 30px auto 8px;
        }

        .signature-text {
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        /* Utility Classes */
        .hidden {
            display: none;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .currency-select {
            width: 120px;
            margin-right: 10px;
            border: 1px solid var(--kingu-green);
        }

        .quotation-currency-select {
            border: 1px solid var(--kingu-blue);
        }

        .stamp {
            position: absolute;
            right: 20px; /* Reduced from 40px */
            bottom: 20px; /* Reduced from 40px */
            padding: 10px 20px; /* Reduced */
            background-color: var(--kingu-light);
            border: 2px dashed var(--kingu-green);
            border-radius: 6px;
            text-align: center;
            font-weight: 700;
            color: var(--kingu-green);
            transform: rotate(5deg);
            font-size: 12px;
            max-width: 150px;
        }

        .quotation-stamp {
            position: absolute;
            right: 20px; /* Reduced from 40px */
            top: 20px; /* Reduced from 40px */
            padding: 10px 20px; /* Reduced */
            background-color: rgba(41, 128, 185, 0.1);
            border: 2px dashed var(--kingu-blue);
            border-radius: 6px;
            text-align: center;
            font-weight: 700;
            color: var(--kingu-blue);
            transform: rotate(5deg);
            font-size: 12px;
            max-width: 150px;
        }

        /* Invoice History & Proforma Invoices Styles */
        .history-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(17, 106, 65, 0.1);
            padding: 30px;
            margin-top: 20px;
            border-top: 4px solid var(--kingu-green);
            display: none;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .history-table th {
            background-color: var(--kingu-green);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .history-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        .history-table tr:hover {
            background-color: #f9fafb;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-paid {
            background-color: rgba(46, 204, 113, 0.2);
            color: #27ae60;
        }

        .status-pending {
            background-color: rgba(241, 196, 15, 0.2);
            color: #f39c12;
        }

        .status-overdue {
            background-color: rgba(231, 76, 60, 0.2);
            color: #c0392b;
        }

        .status-quotation {
            background-color: rgba(41, 128, 185, 0.2);
            color: var(--kingu-blue);
        }

        .action-btn-small {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-right: 5px;
        }

        .action-btn-small:hover {
            transform: translateY(-1px);
        }

        /* A4 Print Styles */
        @media print {
            @page {
                margin: 0.5cm; /* Minimal margins for A4 */
                size: A4 portrait;
            }
            
            body, html {
                margin: 0 !important;
                padding: 0 !important;
                width: 210mm; /* A4 width */
                height: 297mm; /* A4 height */
                background: white !important;
                font-size: 11px !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            body * {
                visibility: hidden;
                max-width: 100% !important;
            }
            
            .invoice-preview-container, 
            .invoice-preview-container * {
                visibility: visible !important;
            }
            
            .invoice-preview-container {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                max-width: 210mm !important;
                box-shadow: none !important;
                padding: 15mm !important; /* A4 safe area */
                margin: 0 !important;
                background-color: white !important;
                border: none !important;
                border-radius: 0 !important;
                font-size: 11px !important;
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
            }
            
            /* Further reduce sizes for print */
            .kingu-logo {
                font-size: 32px !important;
            }
            
            .electrical-logo {
                font-size: 24px !important;
            }
            
            .company-logo {
                font-size: 14px !important;
            }
            
            .invoice-title {
                font-size: 20px !important;
            }
            
            .invoice-items-preview {
                font-size: 10px !important;
            }
            
            .invoice-items-preview th,
            .invoice-items-preview td {
                padding: 8px 6px !important;
            }
            
            .invoice-totals {
                width: 250px !important;
                font-size: 11px !important;
            }
            
            .sidebar, 
            .header, 
            .invoice-form-container, 
            .action-buttons, 
            .invoice-type-selector,
            .nav-menu,
            .btn,
            button,
            .history-container,
            .main-content > *:not(.invoice-preview-container) {
                display: none !important;
                visibility: hidden !important;
            }
            
            .container {
                display: block !important;
                width: 100% !important;
                height: 100% !important;
            }
            
            .main-content {
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
                height: 100% !important;
            }
            
            .stamp, .quotation-stamp {
                display: block !important;
                visibility: visible !important;
                font-size: 10px !important;
                padding: 8px 15px !important;
                right: 15mm !important;
                bottom: 15mm !important;
            }
            
            .quotation-stamp {
                top: 15mm !important;
            }
            
            .invoice-footer {
                margin-top: 20px !important;
                font-size: 10px !important;
            }
            
            /* Prevent page breaks inside important elements */
            .invoice-header,
            .invoice-details,
            .invoice-items-preview,
            .invoice-totals,
            .terms-section {
                page-break-inside: avoid !important;
            }
            
            /* Force page break if content overflows */
            .invoice-preview-container {
                overflow: visible !important;
                height: auto !important;
            }
        }

        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .invoice-details {
                flex-direction: column;
                gap: 20px;
            }
            
            .invoice-totals {
                width: 100%;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .action-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .footer-contact {
                flex-direction: column;
                gap: 15px;
            }
            
            .kingu-symbol {
                font-size: 36px;
            }
            
            .footer-company-name {
                font-size: 22px;
            }
            
            .footer-electrical {
                font-size: 20px;
            }
        }

        /* A4 specific styles for screen preview */
        @media screen and (min-width: 800px) {
            .invoice-preview-container {
                width: 210mm;
                min-height: 297mm;
                padding: 20mm;
                margin: 20px auto;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
                position: relative;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo-container">
                <div class="logo">
                    <i class="fas fa-bolt"></i>
                </div>
                <div class="logo-text">
                    <div class="company-header">
                        <span class="kingu">Kingu</span>
                        <span class="electrical">Electrical</span>
                    </div>
                    <div class="company-full-name">Company Limited</div>
                    <div class="company-tagline">Quality Electrical Services with Professional Experience</div>
                </div>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" id="nav-create">
                        <i class="fas fa-file-invoice-dollar"></i> Create Invoice
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="nav-proforma">
                        <i class="fas fa-file-contract"></i> Proforma Invoices
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="nav-history">
                        <i class="fas fa-history"></i> Document History
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="nav-clients">
                        <i class="fas fa-users"></i> Client Database
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="nav-reports">
                        <i class="fas fa-chart-bar"></i> Reports & Analytics
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="nav-settings">
                        <i class="fas fa-cog"></i> System Settings
                    </a>
                </li>
            </ul>
            
            <div class="company-info-sidebar">
                <p><i class="fas fa-map-marker-alt"></i> <span>P.O. Box 62313<br>Dar Es Salaam Tanzania</span></p>
                <p><i class="fas fa-hashtag"></i> TIN: 157-024-493</p>
                <p><i class="fas fa-phone"></i> +255 677 01 47 40</p>
                <p><i class="fas fa-phone"></i> +255 763 95 79 08</p>
                <p><i class="fas fa-phone"></i> +255 682 84 35 52</p>
                <p><i class="fab fa-whatsapp"></i> +255 682 84 35 52 <span class="contact-badge">WHATSAPP</span></p>
                <p><i class="fas fa-envelope"></i> kinguelectricaltz@gmail.com</p>
                <p><i class="fas fa-university"></i> STANBIC BANK<br>912 000 275 9274</p>
                
                <div class="contact-badges">
                    <span class="contact-badge-small">
                        <i class="fas fa-phone"></i> Call Us
                    </span>
                    <span class="contact-badge-small whatsapp-badge">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </span>
                    <span class="contact-badge-small email-badge">
                        <i class="fas fa-envelope"></i> Email
                    </span>
                </div>
                
                <div class="color-scheme">
                    <div class="color-box green" title="Kingu Green: #116a41"></div>
                    <div class="color-box red" title="Electrical Red: #e63946"></div>
                    <div class="color-box yellow-start" title="Light Bulb Start: #ffae42"></div>
                    <div class="color-box yellow-end" title="Light Bulb End: #ffea00"></div>
                    <div class="color-box blue" title="Quotation Blue: #2980b9"></div>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <div class="header">
                <h1 id="page-title">Create Proforma Invoice</h1>
                <div>
                    <button class="btn btn-whatsapp" id="whatsapp-btn" style="margin-right: 10px;">
                        <i class="fab fa-whatsapp"></i> Share Document
                    </button>
                    <button class="btn btn-pdf" id="pdf-btn" style="display: none; margin-right: 10px;">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                    <button class="btn btn-accent" id="load-sample-btn">
                        <i class="fas fa-file-import"></i> Load Sample
                    </button>
                    <button class="btn btn-secondary" id="print-btn" style="display: none;">
                        <i class="fas fa-print"></i> Print Document
                    </button>
                    <button class="btn btn-success" id="new-document-btn" style="margin-right: 10px;">
                        <i class="fas fa-plus"></i> New Document
                    </button>
                </div>
            </div>
            
            <div class="invoice-type-selector">
                <button class="type-btn active" id="btn-proforma">Proforma Invoice</button>
                <button class="type-btn" id="btn-standard">Standard Invoice</button>
                <button class="type-btn" id="btn-quotation">Quotation</button>
            </div>
            
            <!-- Invoice Form -->
            <div id="invoice-form" class="invoice-form-container">
                <div class="form-section">
                    <h3 class="section-title" id="details-title"><i class="fas fa-info-circle"></i> Invoice Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="invoice-number" id="doc-number-label">Invoice Number</label>
                            <div style="display: flex; align-items: center;">
                                <input type="text" id="invoice-number" class="form-control" value="PROFORMA/GL/06/2025/001" style="flex: 1;">
                                <button class="btn" style="margin-left: 10px; padding: 10px 15px; background-color: var(--kingu-light);" id="generate-number-btn" title="Generate New Number">
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="invoice-date" id="doc-date-label">Invoice Date</label>
                            <input type="date" id="invoice-date" class="form-control" value="">
                        </div>
                        <div class="form-group">
                            <label for="due-date">Due Date</label>
                            <input type="date" id="due-date" class="form-control" value="">
                        </div>
                    </div>
                    
                    <div class="proforma-fields" id="extra-fields">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="currency">Currency</label>
                                <select id="currency" class="form-control currency-select">
                                    <option value="TSh">Tanzanian Shilling (TSh)</option>
                                    <option value="USD">US Dollar ($)</option>
                                    <option value="EUR">Euro (€)</option>
                                    <option value="GBP">British Pound (£)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="delivery-time">Delivery Time (Days after PO)</label>
                                <input type="number" id="delivery-time" class="form-control" value="7" min="1">
                            </div>
                            <div class="form-group">
                                <label for="payment-terms">Payment Terms</label>
                                <select id="payment-terms" class="form-control">
                                    <option value="100% after delivery">100% after delivery</option>
                                    <option value="50% advance, 50% after delivery">50% advance, 50% after delivery</option>
                                    <option value="30 days net">30 days net</option>
                                    <option value="Custom">Custom</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row" id="custom-terms-container" style="display: none;">
                            <div class="form-group">
                                <label for="custom-payment-terms">Custom Payment Terms</label>
                                <textarea id="custom-payment-terms" class="form-control" rows="2" placeholder="Enter custom payment terms"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-user-tie"></i> Client Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="client-name">Client Name</label>
                            <div style="display: flex;">
                                <input type="text" id="client-name" class="form-control" placeholder="Enter client name" value="GREENLIGHT PLANNET TANZANIA LTD">
                                <button class="btn" style="margin-left: 10px; padding: 10px 15px; background-color: var(--kingu-light);" id="client-search-btn" title="Search Client Database">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="client-email">Client Email</label>
                            <input type="email" id="client-email" class="form-control" placeholder="Enter client email" value="accounts@greenlight.co.tz">
                        </div>
                        <div class="form-group">
                            <label for="client-phone">Client Phone</label>
                            <input type="text" id="client-phone" class="form-control" placeholder="Enter client phone" value="+255 765 432 100">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="client-address">Client Address</label>
                            <textarea id="client-address" class="form-control" rows="2" placeholder="Enter client address">ARUSHA, TANZANIA</textarea>
                        </div>
                        <div class="form-group">
                            <label for="client-tin">TIN Number</label>
                            <input type="text" id="client-tin" class="form-control" placeholder="Enter TIN number" value="109-628-980">
                        </div>
                        <div class="form-group">
                            <label for="client-vat">VAT Number (if applicable)</label>
                            <input type="text" id="client-vat" class="form-control" placeholder="Enter VAT number">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="section-title" id="items-title"><i class="fas fa-list-alt"></i> Invoice Items</h3>
                    <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                        <button class="btn" style="background-color: var(--kingu-light); color: var(--kingu-green);" id="add-service-item">
                            <i class="fas fa-wrench"></i> Add Service
                        </button>
                        <button class="btn" style="background-color: var(--kingu-light); color: var(--kingu-green);" id="add-product-item">
                            <i class="fas fa-box"></i> Add Product
                        </button>
                        <button class="btn" style="background-color: var(--kingu-light); color: var(--kingu-green);" id="add-labor-item">
                            <i class="fas fa-user-hard-hat"></i> Add Labor
                        </button>
                    </div>
                    <table class="items-table" id="items-table">
                        <thead>
                            <tr>
                                <th>DESCRIPTION</th>
                                <th style="width: 100px;">UNITS</th>
                                <th style="width: 150px;">UNIT PRICE</th>
                                <th style="width: 150px;">AMOUNT</th>
                                <th style="width: 80px;">ACTION</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-items">
                            <tr>
                                <td><input type="text" class="item-description" placeholder="Service description" value="Engine service and Preventive maintenance"></td>
                                <td><input type="number" class="item-quantity" min="0" step="0.01" value="1.00"></td>
                                <td>
                                    <div style="display: flex; align-items: center;">
                                        <span class="currency-symbol" style="margin-right: 5px;">TSh</span>
                                        <input type="number" class="item-price" min="0" step="0.01" value="350000.00" style="flex: 1;">
                                    </div>
                                </td>
                                <td class="item-total text-right">TSh 350,000.00</td>
                                <td class="text-center"><button class="delete-item"><i class="fas fa-trash"></i></button></td>
                            </tr>
                            <tr>
                                <td><input type="text" class="item-description" placeholder="Service description" value="PLC check and configuration"></td>
                                <td><input type="number" class="item-quantity" min="0" step="0.01" value="1.00"></td>
                                <td>
                                    <div style="display: flex; align-items: center;">
                                        <span class="currency-symbol" style="margin-right: 5px;">TSh</span>
                                        <input type="number" class="item-price" min="0" step="0.01" value="250000.00" style="flex: 1;">
                                    </div>
                                </td>
                                <td class="item-total text-right">TSh 250,000.00</td>
                                <td class="text-center"><button class="delete-item"><i class="fas fa-trash"></i></button></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <button class="add-item-btn" id="add-item-btn">
                        <i class="fas fa-plus-circle"></i> Add Custom Item
                    </button>
                    
                    <div style="margin-top: 20px; display: flex; gap: 15px; align-items: center;">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label for="discount-type">Discount</label>
                            <select id="discount-type" class="form-control">
                                <option value="none">No Discount</option>
                                <option value="percentage">Percentage %</option>
                                <option value="fixed">Fixed Amount</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1; margin-bottom: 0; display: none;" id="discount-value-container">
                            <label for="discount-value">Discount Value</label>
                            <input type="number" id="discount-value" class="form-control" min="0" step="0.01" value="0">
                        </div>
                    </div>
                </div>
                
                <div class="totals-section" id="totals-section">
                    <div class="total-row">
                        <span class="total-label">Subtotal:</span>
                        <span class="total-value" id="subtotal">TSh 600,000.00</span>
                    </div>
                    <div class="total-row" id="discount-row" style="display: none;">
                        <span class="total-label" id="discount-label">Discount:</span>
                        <span class="total-value" id="discount-amount">TSh 0.00</span>
                    </div>
                    <div class="total-row">
                        <span class="total-label">VAT (18%):</span>
                        <span class="total-value" id="tax">TSh 108,000.00</span>
                    </div>
                    <div class="total-row grand-total">
                        <span class="total-label" id="grand-total-label">GRAND TOTAL:</span>
                        <span class="total-value" id="grand-total">TSh 708,000.00</span>
                    </div>
                    <div class="total-row" style="margin-top: 10px; font-size: 14px; color: #666;">
                        <span class="total-label">Amount in Words:</span>
                        <span class="total-value" id="amount-words">Seven hundred eight thousand Tanzanian Shillings only</span>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-file-signature"></i> Terms & Conditions</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bank-details">Bank Details</label>
                            <textarea id="bank-details" class="form-control" rows="3">BANK: STANBIC BANK TANZANIA LIMITED
ACCOUNT NAME: KINGU ELECTRICAL COMPANY LIMITED
ACCOUNT NUMBER: 912 000 275 9274
SWIFT CODE: SBICTZTX</textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="notes">Additional Notes / Special Instructions</label>
                            <textarea id="notes" class="form-control" rows="4" placeholder="Add any additional notes here...">1. This Proforma shall remain valid for 30 days only.
2. Prices are inclusive of VAT where applicable.
3. Delivery subject to stock availability.
4. All disputes subject to Dar es Salaam jurisdiction.</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="clear-btn">
                        <i class="fas fa-redo"></i> Clear Form
                    </button>
                    <button class="btn btn-success" id="preview-btn">
                        <i class="fas fa-eye"></i> Preview Document
                    </button>
                    <button class="btn btn-primary" id="save-btn">
                        <i class="fas fa-save"></i> Save Proforma
                    </button>
                    <button class="btn" style="background-color: var(--kingu-accent); color: white;" id="send-email-btn">
                        <i class="fas fa-paper-plane"></i> Send via Email
                    </button>
                </div>
            </div>
            
            <!-- Document Preview - Optimized for A4 -->
            <div id="invoice-preview" class="invoice-preview-container">
                <div class="stamp" style="display: none;">PROFORMA INVOICE</div>
                <div class="quotation-stamp" style="display: none;">QUOTATION</div>
                
                <div class="invoice-header">
                    <div class="invoice-company-logo">
                        <div class="company-logo-text">
                            <div class="kingu-logo">Kingu</div>
                            <div class="electrical-logo">Electrical</div>
                            <div class="company-logo">Company Limited</div>
                            <div class="company-tin">TIN: 157-024-493</div>
                            <div class="tagline-logo">Quality Electrical Services with Professional Experience</div>
                            <div class="contact-info-logo">
                                <div class="phone-numbers">
                                    <span>+255 677 01 47 40</span>
                                    <span>+255 763 95 79 08</span>
                                    <span>+255 682 84 35 52</span>
                                </div>
                                <div class="email">kinguelectricaltz@gmail.com</div>
                                <div class="address">P.O. Box 62313, Dar Es Salaam Tanzania.</div>
                            </div>
                        </div>
                    </div>
                    <div class="invoice-title" id="preview-doc-type">PROFORMA INVOICE</div>
                </div>
                
                <div class="invoice-details">
                    <div class="client-info">
                        <div class="info-title" id="client-title">TO:</div>
                        <div class="client-details">
                            <p id="preview-client-name"><strong>GREENLIGHT PLANNET TANZANIA LTD</strong></p>
                            <p id="preview-client-address">ARUSHA, TANZANIA</p>
                            <p id="preview-client-tin">TIN Number: 109-628-980</p>
                            <p id="preview-client-vat"></p>
                            <p id="preview-client-phone">Phone: +255 765 432 100</p>
                            <p id="preview-client-email">Email: accounts@greenlight.co.tz</p>
                        </div>
                    </div>
                    
                    <div class="company-info">
                        <div class="info-title" id="company-title">FROM:</div>
                        <div class="company-details">
                            <p><strong>KINGU ELECTRICAL COMPANY LIMITED</strong></p>
                            <p>TIN: 157-024-493</p>
                            <p>P.O. Box 62313, Dar Es Salaam Tanzania</p>
                            <p>Phone: +255 677 01 47 40</p>
                            <p>Email: kinguelectricaltz@gmail.com</p>
                        </div>
                    </div>
                    
                    <div class="invoice-info">
                        <div class="info-title" id="preview-details-title">INVOICE DETAILS:</div>
                        <div class="invoice-info-box" id="preview-info-box">
                            <p><strong id="preview-doc-number-label">Invoice #:</strong> <span id="preview-invoice-number">PROFORMA/GL/06/2025/001</span></p>
                            <p><strong id="preview-doc-date-label">Date:</strong> <span id="preview-invoice-date">June 15, 2025</span></p>
                            <p><strong>Due Date:</strong> <span id="preview-due-date">July 15, 2025</span></p>
                            <p><strong>Delivery:</strong> <span id="preview-delivery-time">7 days after PO</span></p>
                            <p><strong>Payment Terms:</strong> <span id="preview-payment-terms">100% after delivery</span></p>
                        </div>
                    </div>
                </div>
                
                <div style="margin: 20px 0; padding: 15px; background-color: var(--kingu-light); border-radius: 6px; border-left: 3px solid var(--kingu-green);" id="preview-intro-box">
                    <h3 style="color: var(--kingu-green); margin-bottom: 10px; font-size: 14px;" id="preview-subject">Subject: Proforma Invoice for Electrical Services</h3>
                    <p id="preview-quotation-text" style="color: #555; line-height: 1.5; font-size: 11px;">
                        PROFORMA INVOICE<br><br>
                        This proforma invoice is prepared for the services rendered. 
                        All prices are inclusive of VAT where applicable and are valid for 30 days.
                    </p>
                </div>
                
                <table class="invoice-items-preview" id="preview-items-table">
                    <thead>
                        <tr>
                            <th style="width: 50%;">DESCRIPTION</th>
                            <th style="width: 15%;">UNITS</th>
                            <th style="width: 15%;">UNIT PRICE</th>
                            <th style="width: 20%;">AMOUNT</th>
                        </tr>
                    </thead>
                    <tbody id="preview-items">
                        <!-- Items will be added here dynamically -->
                    </tbody>
                </table>
                
                <div class="invoice-totals" id="preview-totals">
                    <!-- Totals will be added here dynamically -->
                </div>
                
                <div class="terms-section" id="preview-terms-section">
                    <div class="terms-title" id="preview-terms-title"><i class="fas fa-file-contract"></i> TERMS & CONDITIONS</div>
                    <div class="terms-content">
                        <p><strong>Bank Details:</strong> <span id="preview-bank-details">BANK: STANBIC BANK TANZANIA LIMITED<br>ACCOUNT NAME: KINGU ELECTRICAL COMPANY LIMITED<br>ACCOUNT NUMBER: 912 000 275 9274<br>SWIFT CODE: SBICTZTX</span></p>
                        <p id="preview-notes">1. This Proforma shall remain valid for 30 days only.<br>2. Prices are inclusive of VAT where applicable.<br>3. Delivery subject to stock availability.<br>4. All disputes subject to Dar es Salaam jurisdiction.</p>
                        <div class="contact-badges" style="margin-top: 10px;">
                            <span class="contact-badge-small" style="font-size: 10px; padding: 3px 8px;">
                                <i class="fas fa-phone"></i> +255 677 014 740
                            </span>
                            <span class="contact-badge-small whatsapp-badge" style="font-size: 10px; padding: 3px 8px;">
                                <i class="fab fa-whatsapp"></i> +255 682 843 552
                            </span>
                            <span class="contact-badge-small email-badge" style="font-size: 10px; padding: 3px 8px;">
                                <i class="fas fa-envelope"></i> Kinguelectricaltz@gmail.com
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Footer with Kingu Electrical Logo -->
                <div class="invoice-footer">
                    <div class="authorized-signature">
                        <div class="signature-line"></div>
                        <div class="signature-text">Authorized Signature & Company Stamp</div>
                        <div style="margin-top: 20px; font-size: 11px; color: #666; text-align: center;">
                            <p id="preview-thank-you">Thank you for your business! We value our partnership and look forward to serving you.</p>
                            <p style="margin-top: 8px;"><em id="preview-footer-note">This is a computer-generated document. No signature is required.</em></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Client Database Section -->
            <div id="client-database" class="history-container">
                <h2 style="color: var(--kingu-green); margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;">
                    <span><i class="fas fa-users" style="margin-right: 10px;"></i> Client Database</span>
                    <button class="btn btn-primary" id="add-client-btn">
                        <i class="fas fa-user-plus"></i> Add New Client
                    </button>
                </h2>
                <div id="client-list">
                    <p>Loading client database...</p>
                </div>
            </div>
            
            <!-- Proforma Invoices Section -->
            <div id="proforma-invoices" class="history-container">
                <h2 style="color: var(--kingu-green); margin-bottom: 20px; display: flex; align-items: center;">
                    <i class="fas fa-file-contract" style="margin-right: 10px;"></i> Proforma Invoices
                </h2>
                <div id="proforma-list">
                    <p>Loading proforma invoices...</p>
                </div>
            </div>
            
            <!-- Invoice History Section -->
            <div id="invoice-history" class="history-container">
                <h2 style="color: var(--kingu-green); margin-bottom: 20px; display: flex; align-items: center;">
                    <i class="fas fa-history" style="margin-right: 10px;"></i> Document History
                </h2>
                <div id="history-list">
                    <p>Loading document history...</p>
                </div>
            </div>
            
            <!-- Reports Section -->
            <div id="reports-section" class="history-container">
                <h2 style="color: var(--kingu-green); margin-bottom: 20px; display: flex; align-items: center;">
                    <i class="fas fa-chart-bar" style="margin-right: 10px;"></i> Reports & Analytics
                </h2>
                <div id="reports-content">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h3 style="color: var(--kingu-green); margin-bottom: 15px;">Sales Overview</h3>
                            <p>Total Revenue: <strong>TSh 0.00</strong></p>
                            <p>Invoices This Month: <strong>0</strong></p>
                            <p>Pending Payments: <strong>TSh 0.00</strong></p>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h3 style="color: var(--kingu-green); margin-bottom: 15px;">Quick Actions</h3>
                            <button class="btn" style="width: 100%; margin-bottom: 10px; background-color: var(--kingu-light);">
                                <i class="fas fa-file-export"></i> Export Monthly Report
                            </button>
                            <button class="btn" style="width: 100%; margin-bottom: 10px; background-color: var(--kingu-light);">
                                <i class="fas fa-chart-pie"></i> View Sales Chart
                            </button>
                            <button class="btn" style="width: 100%; background-color: var(--kingu-light);">
                                <i class="fas fa-file-invoice"></i> Generate Tax Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Section -->
            <div id="settings-section" class="history-container">
                <h2 style="color: var(--kingu-green); margin-bottom: 20px; display: flex; align-items: center;">
                    <i class="fas fa-cog" style="margin-right: 10px;"></i> System Settings
                </h2>
                <div id="settings-content">
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="color: var(--kingu-green); margin-bottom: 15px;">Company Settings</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Default Currency</label>
                                <select class="form-control">
                                    <option selected>Tanzanian Shilling (TSh)</option>
                                    <option>US Dollar ($)</option>
                                    <option>Euro (€)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Default VAT Rate (%)</label>
                                <input type="number" class="form-control" value="18" min="0" max="100">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Invoice Number Prefix</label>
                                <input type="text" class="form-control" value="PROFORMA/GL">
                            </div>
                            <div class="form-group">
                                <label>Default Payment Terms</label>
                                <select class="form-control">
                                    <option selected>100% after delivery</option>
                                    <option>50% advance, 50% after delivery</option>
                                    <option>30 days net</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary" style="margin-top: 20px;">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        
        // Company details
        const COMPANY_NAME = "KINGU ELECTRICAL COMPANY LIMITED";
        const COMPANY_TIN = "157-024-493";
        const COMPANY_EMAIL = "kinguelectricaltz@gmail.com";
        const COMPANY_PHONE_1 = "+255 677 01 47 40";
        const COMPANY_PHONE_2 = "+255 763 95 79 08";
        const COMPANY_PHONE_3 = "+255 682 84 35 52";
        const COMPANY_WHATSAPP = "+255 682 84 35 52";
        const COMPANY_TAGLINE = "Quality Electrical Services with Professional Experience";
        const COMPANY_ADDRESS = "P.O. Box 62313, Dar Es Salaam Tanzania.";
        
        // DOM Elements
        let invoiceForm, invoicePreview, pageTitle, printBtn, pdfBtn, whatsappBtn;
        let invoiceItems, previewItems;
        
        // Safe DOM helper functions
        function safeSetTextContent(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
                return true;
            }
            console.warn(`Element with id '${elementId}' not found`);
            return false;
        }

        function safeSetHTML(elementId, html) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = html;
                return true;
            }
            console.warn(`Element with id '${elementId}' not found`);
            return false;
        }

        function safeGetElement(elementId) {
            const element = document.getElementById(elementId);
            if (!element) {
                console.warn(`Element with id '${elementId}' not found`);
            }
            return element;
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Get DOM elements
            invoiceForm = safeGetElement('invoice-form');
            invoicePreview = safeGetElement('invoice-preview');
            pageTitle = safeGetElement('page-title');
            printBtn = safeGetElement('print-btn');
            pdfBtn = safeGetElement('pdf-btn');
            whatsappBtn = safeGetElement('whatsapp-btn');
            invoiceItems = safeGetElement('invoice-items');
            previewItems = safeGetElement('preview-items');
            
            // Check if required elements exist
            if (!invoiceForm || !invoicePreview) {
                console.error('Required DOM elements not found. Please check the HTML structure.');
                return;
            }
            
            // Set default dates
            const today = new Date();
            const invoiceDate = safeGetElement('invoice-date');
            if (invoiceDate) invoiceDate.valueAsDate = today;
            
            // Set due date to 30 days from now
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            const dueDateInput = safeGetElement('due-date');
            if (dueDateInput) dueDateInput.valueAsDate = dueDate;
            
            // Initialize totals
            updateTotals();
            
            // Event Listeners
            setupEventListeners();
            
            // Setup navigation
            setupNavigation();
            
            // Load saved documents
            loadSavedDocuments();
            
            // Load client database
            loadClientDatabase();
        });
        
        // Setup all event listeners
        function setupEventListeners() {
            // Item input listeners
            document.querySelectorAll('.item-quantity, .item-price').forEach(input => {
                input.addEventListener('input', updateTotals);
            });
            
            // Form input listeners for preview updates
            const formInputs = [
                'invoice-number', 'invoice-date', 'due-date',
                'client-name', 'client-address', 'client-tin', 'client-vat',
                'client-phone', 'client-email', 'payment-terms',
                'bank-details', 'delivery-time', 'notes', 'currency',
                'discount-type', 'discount-value', 'custom-payment-terms'
            ];
            
            formInputs.forEach(id => {
                const element = safeGetElement(id);
                if (element) {
                    element.addEventListener('input', updatePreview);
                    if (element.tagName === 'SELECT') {
                        element.addEventListener('change', updatePreview);
                    }
                }
            });
            
            // Currency change listener
            const currencySelect = safeGetElement('currency');
            if (currencySelect) {
                currencySelect.addEventListener('change', function() {
                    updateCurrencySymbol();
                    updateTotals();
                    updatePreview();
                });
            }
            
            // Invoice type buttons
            const btnProforma = safeGetElement('btn-proforma');
            const btnStandard = safeGetElement('btn-standard');
            const btnQuotation = safeGetElement('btn-quotation');
            
            if (btnProforma) btnProforma.addEventListener('click', () => setInvoiceType('proforma'));
            if (btnStandard) btnStandard.addEventListener('click', () => setInvoiceType('standard'));
            if (btnQuotation) btnQuotation.addEventListener('click', () => setInvoiceType('quotation'));
            
            // Action buttons
            const addItemBtn = safeGetElement('add-item-btn');
            if (addItemBtn) addItemBtn.addEventListener('click', addNewItem);
            
            const clearBtn = safeGetElement('clear-btn');
            if (clearBtn) clearBtn.addEventListener('click', clearForm);
            
            const previewBtn = safeGetElement('preview-btn');
            if (previewBtn) previewBtn.addEventListener('click', generateDocument);
            
            const saveBtn = safeGetElement('save-btn');
            if (saveBtn) saveBtn.addEventListener('click', saveDocument);
            
            const loadSampleBtn = safeGetElement('load-sample-btn');
            if (loadSampleBtn) loadSampleBtn.addEventListener('click', loadSampleProforma);
            
            const newDocBtn = safeGetElement('new-document-btn');
            if (newDocBtn) newDocBtn.addEventListener('click', createNewDocument);
            
            if (printBtn) printBtn.addEventListener('click', printDocument);
            if (pdfBtn) pdfBtn.addEventListener('click', exportToPDF);
            if (whatsappBtn) whatsappBtn.addEventListener('click', sendWhatsApp);
            
            const generateNumBtn = safeGetElement('generate-number-btn');
            if (generateNumBtn) generateNumBtn.addEventListener('click', generateInvoiceNumber);
            
            const sendEmailBtn = safeGetElement('send-email-btn');
            if (sendEmailBtn) sendEmailBtn.addEventListener('click', sendEmail);
            
            // New feature buttons
            const addServiceBtn = safeGetElement('add-service-item');
            if (addServiceBtn) addServiceBtn.addEventListener('click', () => addPredefinedItem('service'));
            
            const addProductBtn = safeGetElement('add-product-item');
            if (addProductBtn) addProductBtn.addEventListener('click', () => addPredefinedItem('product'));
            
            const addLaborBtn = safeGetElement('add-labor-item');
            if (addLaborBtn) addLaborBtn.addEventListener('click', () => addPredefinedItem('labor'));
            
            const clientSearchBtn = safeGetElement('client-search-btn');
            if (clientSearchBtn) clientSearchBtn.addEventListener('click', searchClientDatabase);
            
            const addClientBtn = safeGetElement('add-client-btn');
            if (addClientBtn) addClientBtn.addEventListener('click', addNewClient);
            
            // Discount handling
            const discountType = safeGetElement('discount-type');
            if (discountType) {
                discountType.addEventListener('change', function() {
                    const discountValueContainer = safeGetElement('discount-value-container');
                    const discountRow = safeGetElement('discount-row');
                    if (this.value === 'none') {
                        if (discountValueContainer) discountValueContainer.style.display = 'none';
                        if (discountRow) discountRow.style.display = 'none';
                    } else {
                        if (discountValueContainer) discountValueContainer.style.display = 'block';
                        if (discountRow) discountRow.style.display = 'flex';
                        const discountLabel = safeGetElement('discount-label');
                        if (discountLabel) {
                            discountLabel.textContent = this.value === 'percentage' ? 'Discount (%):' : 'Discount:';
                        }
                    }
                    updateTotals();
                });
            }
            
            const discountValue = safeGetElement('discount-value');
            if (discountValue) discountValue.addEventListener('input', updateTotals);
            
            // Payment terms custom field
            const paymentTerms = safeGetElement('payment-terms');
            if (paymentTerms) {
                paymentTerms.addEventListener('change', function() {
                    const customContainer = safeGetElement('custom-terms-container');
                    if (customContainer) {
                        customContainer.style.display = this.value === 'Custom' ? 'block' : 'none';
                    }
                });
            }
            
            // Delete item buttons (delegated event)
            document.addEventListener('click', function(e) {
                if (e.target.closest('.delete-item')) {
                    deleteItem(e.target.closest('.delete-item'));
                }
            });
            
            // Initialize currency symbol
            updateCurrencySymbol();
        }
        
        // Generate new invoice number
        function generateInvoiceNumber() {
            const isProforma = document.getElementById('btn-proforma')?.classList.contains('active');
            const isStandard = document.getElementById('btn-standard')?.classList.contains('active');
            const isQuotation = document.getElementById('btn-quotation')?.classList.contains('quotation-active');
            
            let prefix = 'PROFORMA';
            if (isStandard) prefix = 'INV';
            if (isQuotation) prefix = 'QUOTE';
            
            const year = new Date().getFullYear();
            const month = (new Date().getMonth() + 1).toString().padStart(2, '0');
            const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            const invoiceNumberInput = safeGetElement('invoice-number');
            if (invoiceNumberInput) {
                invoiceNumberInput.value = `${prefix}/GL/${month}/${year}/${randomNum}`;
                updatePreview();
            }
        }
        
        // Create new document
        function createNewDocument() {
            clearForm();
            if (invoiceForm) invoiceForm.style.display = 'block';
            if (invoicePreview) invoicePreview.style.display = 'none';
            if (printBtn) printBtn.style.display = 'none';
            if (pdfBtn) pdfBtn.style.display = 'none';
            if (whatsappBtn) whatsappBtn.style.display = 'inline-flex';
            
            // Hide all other sections
            document.querySelectorAll('.history-container').forEach(container => {
                container.style.display = 'none';
            });
            
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            const navCreate = safeGetElement('nav-create');
            if (navCreate) navCreate.classList.add('active');
        }
        
        // Add predefined item
        function addPredefinedItem(type) {
            const currencySelect = safeGetElement('currency');
            const currency = currencySelect ? currencySelect.value : 'TSh';
            const symbol = currency === 'TSh' ? 'TSh' : 
                          currency === 'USD' ? '$' :
                          currency === 'EUR' ? '€' : '£';
            
            let description = '';
            let price = '0.00';
            
            switch(type) {
                case 'service':
                    description = 'Electrical Service';
                    price = '50000.00';
                    break;
                case 'product':
                    description = 'Electrical Product';
                    price = '25000.00';
                    break;
                case 'labor':
                    description = 'Labor Hours';
                    price = '15000.00';
                    break;
            }
            
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" class="item-description" value="${description}"></td>
                <td><input type="number" class="item-quantity" min="0" step="0.01" value="1.00"></td>
                <td>
                    <div style="display: flex; align-items: center;">
                        <span class="currency-symbol" style="margin-right: 5px;">${symbol}</span>
                        <input type="number" class="item-price" min="0" step="0.01" value="${price}" style="flex: 1;">
                    </div>
                </td>
                <td class="item-total text-right">${formatCurrency(0, currency)}</td>
                <td class="text-center"><button class="delete-item"><i class="fas fa-trash"></i></button></td>
            `;
            
            if (invoiceItems) invoiceItems.appendChild(newRow);
            
            // Add event listeners
            newRow.querySelector('.item-quantity').addEventListener('input', updateTotals);
            newRow.querySelector('.item-price').addEventListener('input', updateTotals);
            
            updateTotals();
        }
        
        // Search client database
        function searchClientDatabase() {
            const clients = JSON.parse(localStorage.getItem('kinguClients')) || [];
            if (clients.length === 0) {
                alert('No clients in database. Please add clients first.');
                return;
            }
            
            // Simple client selection dialog
            let clientOptions = '<div style="max-height: 300px; overflow-y: auto; margin: 10px 0;">';
            clients.forEach((client, index) => {
                clientOptions += `
                    <div style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer;" 
                         onclick="selectClient(${index})">
                        <strong>${client.name}</strong><br>
                        <small>${client.email || ''} | ${client.phone || ''}</small>
                    </div>
                `;
            });
            clientOptions += '</div>';
            
            // Remove existing modal if any
            const existingModal = document.getElementById('client-modal');
            if (existingModal) existingModal.remove();
            
            // Show client selection
            document.body.insertAdjacentHTML('beforeend', `
                <div id="client-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
                        <h3 style="color: var(--kingu-green); margin-bottom: 15px;">Select Client</h3>
                        ${clientOptions}
                        <button onclick="document.getElementById('client-modal').remove()" 
                                style="margin-top: 15px; padding: 8px 15px; background: #ddd; border: none; border-radius: 4px; cursor: pointer;">
                            Cancel
                        </button>
                    </div>
                </div>
            `);
        }
        
        // Select client from database
        window.selectClient = function(index) {
            const clients = JSON.parse(localStorage.getItem('kinguClients')) || [];
            const client = clients[index];
            
            if (client) {
                safeGetElement('client-name').value = client.name || '';
                safeGetElement('client-email').value = client.email || '';
                safeGetElement('client-phone').value = client.phone || '';
                safeGetElement('client-address').value = client.address || '';
                safeGetElement('client-tin').value = client.tin || '';
                safeGetElement('client-vat').value = client.vat || '';
                
                // Remove modal
                const modal = document.getElementById('client-modal');
                if (modal) modal.remove();
                
                updatePreview();
            }
        };
        
        // Add new client to database
        function addNewClient() {
            const name = prompt('Enter client name:');
            if (!name) return;
            
            const email = prompt('Enter client email (optional):');
            const phone = prompt('Enter client phone (optional):');
            const address = prompt('Enter client address (optional):');
            const tin = prompt('Enter TIN number (optional):');
            
            const clients = JSON.parse(localStorage.getItem('kinguClients')) || [];
            clients.push({
                id: Date.now(),
                name: name,
                email: email || '',
                phone: phone || '',
                address: address || '',
                tin: tin || '',
                vat: '',
                created: new Date().toISOString()
            });
            
            localStorage.setItem('kinguClients', JSON.stringify(clients));
            loadClientDatabase();
            alert('Client added successfully!');
        }
        
        // Load client database
        function loadClientDatabase() {
            const clients = JSON.parse(localStorage.getItem('kinguClients')) || [];
            const clientList = safeGetElement('client-list');
            
            if (clients.length === 0) {
                if (clientList) {
                    clientList.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-users" style="font-size: 48px; color: #ddd; margin-bottom: 15px;"></i>
                            <p>No clients in database</p>
                            <button class="btn btn-primary" onclick="addNewClient()" style="margin-top: 15px;">
                                <i class="fas fa-user-plus"></i> Add First Client
                            </button>
                        </div>
                    `;
                }
                return;
            }
            
            let clientHTML = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Client Name</th>
                            <th>Contact</th>
                            <th>TIN</th>
                            <th>Added</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            clients.forEach(client => {
                clientHTML += `
                    <tr>
                        <td><strong>${client.name}</strong></td>
                        <td>
                            <small>${client.email || 'No email'}<br>
                            ${client.phone || 'No phone'}</small>
                        </td>
                        <td>${client.tin || 'Not provided'}</td>
                        <td>${formatDateShort(client.created)}</td>
                        <td>
                            <button class="action-btn-small" style="background-color: var(--kingu-green); color: white;" onclick="selectClientFromList(${client.id})">
                                <i class="fas fa-check"></i> Use
                            </button>
                            <button class="action-btn-small" style="background-color: #6b7280; color: white;" onclick="editClient(${client.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn-small" style="background-color: #d32f2f; color: white;" onclick="deleteClient(${client.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            clientHTML += '</tbody></table>';
            if (clientList) clientList.innerHTML = clientHTML;
        }
        
        // Convert number to words (simplified version)
        function numberToWords(num) {
            const units = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
            const teens = ['ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen'];
            const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
            
            if (num === 0) return 'zero';
            
            function convertHundreds(n) {
                let result = '';
                if (n >= 100) {
                    result += units[Math.floor(n / 100)] + ' hundred ';
                    n %= 100;
                }
                if (n >= 20) {
                    result += tens[Math.floor(n / 10)] + ' ';
                    n %= 10;
                } else if (n >= 10) {
                    result += teens[n - 10] + ' ';
                    n = 0;
                }
                if (n > 0) {
                    result += units[n] + ' ';
                }
                return result.trim();
            }
            
            let words = '';
            const billion = Math.floor(num / 1000000000);
            const million = Math.floor((num % 1000000000) / 1000000);
            const thousand = Math.floor((num % 1000000) / 1000);
            const remainder = num % 1000;
            
            if (billion > 0) words += convertHundreds(billion) + ' billion ';
            if (million > 0) words += convertHundreds(million) + ' million ';
            if (thousand > 0) words += convertHundreds(thousand) + ' thousand ';
            if (remainder > 0) words += convertHundreds(remainder);
            
            return words.trim() + ' Tanzanian Shillings only';
        }
        
        // Calculate and update totals with discount
        function updateTotals() {
            let subtotal = 0;
            const currencySelect = safeGetElement('currency');
            const currency = currencySelect ? currencySelect.value : 'TSh';
            const rows = document.querySelectorAll('#invoice-items tr');
            
            rows.forEach(row => {
                const quantity = parseFloat(row.querySelector('.item-quantity')?.value) || 0;
                const price = parseFloat(row.querySelector('.item-price')?.value) || 0;
                const total = quantity * price;
                
                const itemTotal = row.querySelector('.item-total');
                if (itemTotal) itemTotal.textContent = formatCurrency(total, currency);
                subtotal += total;
            });
            
            // Apply discount
            const discountType = safeGetElement('discount-type');
            const discountTypeValue = discountType ? discountType.value : 'none';
            const discountValueInput = safeGetElement('discount-value');
            const discountValue = parseFloat(discountValueInput?.value) || 0;
            let discount = 0;
            
            if (discountTypeValue === 'percentage' && discountValue > 0) {
                discount = subtotal * (discountValue / 100);
            } else if (discountTypeValue === 'fixed' && discountValue > 0) {
                discount = discountValue;
            }
            
            // Apply discount to subtotal
            const discountedSubtotal = subtotal - discount;
            
            // VAT/Tax calculation (Tanzania VAT is 18%)
            const vatRate = 0.18;
            const vat = discountedSubtotal * vatRate;
            const grandTotal = discountedSubtotal + vat;
            
            safeSetTextContent('subtotal', formatCurrency(subtotal, currency));
            safeSetTextContent('discount-amount', formatCurrency(discount, currency));
            safeSetTextContent('tax', formatCurrency(vat, currency));
            safeSetTextContent('grand-total', formatCurrency(grandTotal, currency));
            
            // Update amount in words
            safeSetTextContent('amount-words', numberToWords(Math.round(grandTotal)));
            
            // Update preview if visible
            if (invoicePreview && invoicePreview.style.display === 'block') {
                updatePreview();
            }
        }
        
        // Format date
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '';
            
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }
        
        // Format date for table display
        function formatDateShort(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '';
            
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }
        
        // Format currency with thousand separators
        function formatCurrency(amount, currency) {
            const symbol = currency === 'TSh' ? 'TSh ' : 
                          currency === 'USD' ? '$' :
                          currency === 'EUR' ? '€' : '£';
            
            const formattedAmount = parseFloat(amount).toFixed(2)
                .replace(/\d(?=(\d{3})+\.)/g, '$&,');
            
            return symbol + (currency === 'TSh' ? '' : ' ') + formattedAmount;
        }
        
        // Extract numeric value from formatted currency
        function extractCurrencyValue(formattedValue) {
            return parseFloat(formattedValue.replace(/[^0-9.-]+/g,"")) || 0;
        }
        
        // Update currency symbol in item rows
        function updateCurrencySymbol() {
            const currencySelect = safeGetElement('currency');
            const currency = currencySelect ? currencySelect.value : 'TSh';
            const symbol = currency === 'TSh' ? 'TSh' : 
                          currency === 'USD' ? '$' :
                          currency === 'EUR' ? '€' : '£';
            
            document.querySelectorAll('.currency-symbol').forEach(symbolElement => {
                symbolElement.textContent = symbol;
            });
        }
        
        // Send email function (simulated)
        function sendEmail() {
            const clientEmail = safeGetElement('client-email')?.value;
            const documentNumber = safeGetElement('invoice-number')?.value;
            
            if (!clientEmail) {
                alert('Please enter client email address');
                return;
            }
            
            // Simulate email sending
            const emailBtn = safeGetElement('send-email-btn');
            if (emailBtn) {
                const originalText = emailBtn.innerHTML;
                emailBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                emailBtn.disabled = true;
                
                setTimeout(() => {
                    emailBtn.innerHTML = originalText;
                    emailBtn.disabled = false;
                    alert(`Invoice ${documentNumber} sent to ${clientEmail} successfully!`);
                }, 1500);
            }
        }
        
        // Set invoice type with additional functionality
        function setInvoiceType(type) {
            const buttons = ['btn-proforma', 'btn-standard', 'btn-quotation'];
            buttons.forEach(btn => {
                const button = safeGetElement(btn);
                if (button) {
                    button.classList.remove('active');
                    button.classList.remove('quotation-active');
                }
            });
            
            const previewTitle = safeGetElement('preview-doc-type');
            const saveBtn = safeGetElement('save-btn');
            const pageTitle = safeGetElement('page-title');
            
            // Update form styling based on type
            const invoiceForm = safeGetElement('invoice-form');
            if (invoiceForm) {
                if (type === 'quotation') {
                    invoiceForm.classList.add('quotation-form-container');
                    safeGetElement('btn-quotation')?.classList.add('quotation-active');
                } else {
                    invoiceForm.classList.remove('quotation-form-container');
                    safeGetElement('btn-proforma')?.classList.add('active');
                }
            }
            
            let invoicePrefix = '';
            let displayTitle = '';
            let previewType = '';
            let saveBtnText = '';
            
            switch(type) {
                case 'proforma':
                    safeGetElement('btn-proforma')?.classList.add('active');
                    const proformaFields = document.querySelector('.proforma-fields');
                    if (proformaFields) proformaFields.style.display = 'block';
                    invoicePrefix = 'PROFORMA';
                    displayTitle = 'Create Proforma Invoice';
                    previewType = 'PROFORMA INVOICE';
                    saveBtnText = 'Save Proforma';
                    break;
                case 'standard':
                    safeGetElement('btn-standard')?.classList.add('active');
                    const proformaFields2 = document.querySelector('.proforma-fields');
                    if (proformaFields2) proformaFields2.style.display = 'none';
                    invoicePrefix = 'INV';
                    displayTitle = 'Create Standard Invoice';
                    previewType = 'TAX INVOICE';
                    saveBtnText = 'Save Invoice';
                    break;
                case 'quotation':
                    safeGetElement('btn-quotation')?.classList.add('quotation-active');
                    const proformaFields3 = document.querySelector('.proforma-fields');
                    if (proformaFields3) proformaFields3.style.display = 'block';
                    invoicePrefix = 'QUOTE';
                    displayTitle = 'Create Quotation';
                    previewType = 'QUOTATION';
                    saveBtnText = 'Save Quotation';
                    break;
            }
            
            if (pageTitle) pageTitle.textContent = displayTitle;
            if (previewTitle) previewTitle.textContent = previewType;
            if (saveBtn) saveBtn.innerHTML = `<i class="fas fa-save"></i> ${saveBtnText}`;
            
            // Update labels in the form
            updateFormLabels(type);
            
            // Generate new invoice number when type changes
            generateInvoiceNumber();
            
            // Update preview if visible
            if (invoicePreview && invoicePreview.style.display === 'block') {
                updatePreview();
            }
        }
        
        // Update form labels based on document type
        function updateFormLabels(type) {
            const isQuotation = type === 'quotation';
            
            // Update document details section
            safeSetHTML('details-title', `<i class="fas fa-info-circle"></i> ${isQuotation ? 'Quotation' : 'Invoice'} Details`);
            safeSetTextContent('doc-number-label', isQuotation ? 'Quotation Number' : 'Invoice Number');
            safeSetTextContent('doc-date-label', isQuotation ? 'Quotation Date' : 'Invoice Date');
            
            // Update items section
            safeSetHTML('items-title', `<i class="fas fa-list-alt"></i> ${isQuotation ? 'Quotation' : 'Invoice'} Items`);
            
            // Update grand total label
            safeSetTextContent('grand-total-label', isQuotation ? 'TOTAL QUOTATION:' : 'GRAND TOTAL:');
            
            // Update buttons
            safeSetHTML('preview-btn', `<i class="fas fa-eye"></i> Preview ${isQuotation ? 'Quotation' : 'Document'}`);
            if (printBtn) printBtn.innerHTML = `<i class="fas fa-print"></i> Print ${isQuotation ? 'Quotation' : 'Document'}`;
            if (whatsappBtn) whatsappBtn.innerHTML = `<i class="fab fa-whatsapp"></i> Share ${isQuotation ? 'Quotation' : 'Document'}`;
        }
        
        // Update preview labels based on document type
        function updatePreviewLabels(isQuotation) {
            // Update document type in header
            const previewDocType = safeGetElement('preview-doc-type');
            if (previewDocType) {
                previewDocType.textContent = isQuotation ? 'QUOTATION' : (document.getElementById('btn-proforma')?.classList.contains('active') ? 'PROFORMA INVOICE' : 'TAX INVOICE');
                previewDocType.classList.toggle('quotation-title', isQuotation);
            }
            
            // Update client title
            safeSetTextContent('client-title', isQuotation ? 'TO:' : 'BILL TO:');
            const clientTitle = safeGetElement('client-title');
            if (clientTitle) clientTitle.classList.toggle('quotation-info-title', isQuotation);
            
            // Update company title
            safeSetTextContent('company-title', 'FROM:');
            const companyTitle = safeGetElement('company-title');
            if (companyTitle) companyTitle.classList.toggle('quotation-info-title', isQuotation);
            
            // Update details title
            safeSetTextContent('preview-details-title', isQuotation ? 'QUOTATION DETAILS:' : 'INVOICE DETAILS:');
            const detailsTitle = safeGetElement('preview-details-title');
            if (detailsTitle) detailsTitle.classList.toggle('quotation-info-title', isQuotation);
            
            // Update document number and date labels
            safeSetTextContent('preview-doc-number-label', isQuotation ? 'Quotation #:' : 'Invoice #:');
            safeSetTextContent('preview-doc-date-label', isQuotation ? 'Quotation Date:' : 'Invoice Date:');
            
            // Update info box styling
            const infoBox = safeGetElement('preview-info-box');
            if (infoBox) infoBox.classList.toggle('quotation-info-box', isQuotation);
            
            // Update items table styling
            const itemsTable = safeGetElement('preview-items-table');
            if (itemsTable) itemsTable.classList.toggle('quotation-items-preview', isQuotation);
            
            // Update totals section styling
            const totals = safeGetElement('preview-totals');
            if (totals) totals.classList.toggle('quotation-totals', isQuotation);
            
            safeSetTextContent('preview-grand-total-label', isQuotation ? 'TOTAL QUOTATION:' : 'GRAND TOTAL:');
            document.querySelectorAll('#preview-totals .total-label').forEach(label => {
                label.classList.toggle('quotation-total-label', isQuotation);
            });
            document.querySelectorAll('#preview-totals .total-value').forEach(value => {
                value.classList.toggle('quotation-total-value', isQuotation);
            });
            const grandTotal = document.querySelector('#preview-totals .grand-total');
            if (grandTotal) grandTotal.classList.toggle('quotation-grand-total', isQuotation);
            
            // Update terms section styling
            const termsSection = safeGetElement('preview-terms-section');
            if (termsSection) termsSection.classList.toggle('quotation-terms-section', isQuotation);
            
            const termsTitle = safeGetElement('preview-terms-title');
            if (termsTitle) termsTitle.classList.toggle('quotation-terms-title', isQuotation);
            
            // Update intro box
            const introBox = safeGetElement('preview-intro-box');
            if (introBox) {
                if (isQuotation) {
                    introBox.style.backgroundColor = 'rgba(41, 128, 185, 0.1)';
                    introBox.style.borderLeft = '4px solid var(--kingu-blue)';
                    const subject = safeGetElement('preview-subject');
                    if (subject) {
                        subject.style.color = 'var(--kingu-blue)';
                        subject.textContent = 'Subject: Quotation for Electrical Services';
                    }
                    const quotationText = safeGetElement('preview-quotation-text');
                    if (quotationText) {
                        quotationText.innerHTML = `
                            Dear Sir/Madam,<br><br>
                            Thank you for your inquiry. We are pleased to submit our quotation for the requested electrical services. 
                            All prices are inclusive of VAT where applicable and are valid for 30 days.
                        `;
                    }
                } else {
                    const isProforma = document.getElementById('btn-proforma')?.classList.contains('active');
                    introBox.style.backgroundColor = 'var(--kingu-light)';
                    introBox.style.borderLeft = '4px solid var(--kingu-green)';
                    const subject = safeGetElement('preview-subject');
                    if (subject) {
                        subject.style.color = 'var(--kingu-green)';
                        subject.textContent = isProforma ? 'Subject: Proforma Invoice for Electrical Services' : 'Subject: Invoice for Electrical Services';
                    }
                    const quotationText = safeGetElement('preview-quotation-text');
                    if (quotationText) {
                        quotationText.innerHTML = `
                            ${isProforma ? 'PROFORMA INVOICE' : 'TAX INVOICE'}<br><br>
                            This ${isProforma ? 'proforma invoice' : 'invoice'} is prepared for the services rendered. 
                            All prices are inclusive of VAT where applicable.
                        `;
                    }
                }
            }
            
            // Update footer text
            safeSetTextContent('preview-thank-you', isQuotation 
                ? 'Thank you for considering our quotation. We look forward to the opportunity to serve you.' 
                : 'Thank you for your business! We value our partnership and look forward to serving you.');
            safeSetTextContent('preview-footer-note', isQuotation 
                ? 'This is a computer-generated quotation. No signature is required.' 
                : 'This is a computer-generated document. No signature is required.');
            
            // Update container styling
            if (invoicePreview) invoicePreview.classList.toggle('quotation-preview-container', isQuotation);
        }
        
        // Update preview with additional fields
        function updatePreview() {
            const isQuotation = document.getElementById('btn-quotation')?.classList.contains('quotation-active');
            
            // Update preview labels
            updatePreviewLabels(isQuotation);
            
            const currencySelect = safeGetElement('currency');
            const currency = currencySelect ? currencySelect.value : 'TSh';
            
            // Update stamps visibility
            const stamp = document.querySelector('.stamp');
            const quotationStamp = document.querySelector('.quotation-stamp');
            if (stamp) stamp.style.display = isQuotation ? 'none' : 'block';
            if (quotationStamp) quotationStamp.style.display = isQuotation ? 'block' : 'none';
            
            // Update client info
            const clientName = safeGetElement('client-name')?.value || 'Client Name';
            safeSetHTML('preview-client-name', `<strong>${clientName}</strong>`);
            
            const clientAddress = safeGetElement('client-address')?.value || 'Client Address';
            safeSetTextContent('preview-client-address', clientAddress);
            
            const clientTin = safeGetElement('client-tin')?.value;
            safeSetTextContent('preview-client-tin', clientTin ? `TIN Number: ${clientTin}` : '');
            
            const clientVat = safeGetElement('client-vat')?.value;
            safeSetTextContent('preview-client-vat', clientVat ? `VAT: ${clientVat}` : '');
            
            const clientPhone = safeGetElement('client-phone')?.value;
            safeSetTextContent('preview-client-phone', clientPhone ? `Phone: ${clientPhone}` : '');
            
            const clientEmail = safeGetElement('client-email')?.value;
            safeSetTextContent('preview-client-email', clientEmail ? `Email: ${clientEmail}` : '');
            
            // Update document details
            const invoiceNumber = safeGetElement('invoice-number')?.value;
            safeSetTextContent('preview-invoice-number', invoiceNumber || '');
            
            const invoiceDate = safeGetElement('invoice-date')?.value;
            safeSetTextContent('preview-invoice-date', formatDate(invoiceDate));
            
            const dueDate = safeGetElement('due-date')?.value;
            if (dueDate) {
                // Add due date to preview if it exists
                const infoBox = safeGetElement('preview-info-box');
                if (infoBox) {
                    let dueDateElement = infoBox.querySelector('#preview-due-date');
                    if (!dueDateElement) {
                        const p = document.createElement('p');
                        p.innerHTML = `<strong>Due Date:</strong> <span id="preview-due-date">${formatDate(dueDate)}</span>`;
                        infoBox.appendChild(p);
                    } else {
                        dueDateElement.textContent = formatDate(dueDate);
                    }
                }
            }
            
            const deliveryTime = safeGetElement('delivery-time')?.value || '7';
            safeSetTextContent('preview-delivery-time', `${deliveryTime} days after PO`);
            
            let paymentTerms = safeGetElement('payment-terms')?.value || '';
            if (paymentTerms === 'Custom') {
                paymentTerms = safeGetElement('custom-payment-terms')?.value || '';
            }
            safeSetTextContent('preview-payment-terms', paymentTerms);
            
            // Update document items
            if (previewItems) previewItems.innerHTML = '';
            
            const rows = document.querySelectorAll('#invoice-items tr');
            rows.forEach(row => {
                const description = row.querySelector('.item-description')?.value || 'Service item';
                const quantity = parseFloat(row.querySelector('.item-quantity')?.value) || 0;
                const price = parseFloat(row.querySelector('.item-price')?.value) || 0;
                const total = quantity * price;
                
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td style="word-break: break-word;">${description}</td>
                    <td>${quantity.toFixed(2)}</td>
                    <td>${formatCurrency(price, currency)}</td>
                    <td>${formatCurrency(total, currency)}</td>
                `;
                
                if (previewItems) previewItems.appendChild(newRow);
            });
            
            // Update totals
            const subtotal = extractCurrencyValue(safeGetElement('subtotal')?.textContent || '0');
            const discount = extractCurrencyValue(safeGetElement('discount-amount')?.textContent || '0');
            const tax = extractCurrencyValue(safeGetElement('tax')?.textContent || '0');
            const grandTotal = extractCurrencyValue(safeGetElement('grand-total')?.textContent || '0');
            
            // Update totals in preview
            const previewTotals = safeGetElement('preview-totals');
            if (previewTotals) {
                let totalsHTML = `
                    <div class="total-row">
                        <span class="total-label">Subtotal:</span>
                        <span class="total-value" id="preview-subtotal">${formatCurrency(subtotal, currency)}</span>
                    </div>
                `;
                
                if (discount > 0) {
                    totalsHTML += `
                        <div class="total-row">
                            <span class="total-label">Discount:</span>
                            <span class="total-value" id="preview-discount">${formatCurrency(discount, currency)}</span>
                        </div>
                    `;
                }
                
                totalsHTML += `
                    <div class="total-row">
                        <span class="total-label">VAT (18%):</span>
                        <span class="total-value" id="preview-tax">${formatCurrency(tax, currency)}</span>
                    </div>
                    <div class="total-row grand-total">
                        <span class="total-label" id="preview-grand-total-label">${isQuotation ? 'TOTAL QUOTATION:' : 'GRAND TOTAL:'}</span>
                        <span class="total-value" id="preview-grand-total">${formatCurrency(grandTotal, currency)}</span>
                    </div>
                `;
                
                // Add amount in words
                const amountWords = safeGetElement('amount-words')?.textContent || '';
                totalsHTML += `
                    <div style="margin-top: 10px; font-size: 11px; font-style: italic; color: #555; word-break: break-word;">
                        <strong>Amount in Words:</strong> ${amountWords}
                    </div>
                `;
                
                previewTotals.innerHTML = totalsHTML;
            }
            
            // Update terms
            const bankDetails = safeGetElement('bank-details')?.value || '';
            safeSetTextContent('preview-bank-details', bankDetails);
            
            const notes = safeGetElement('notes')?.value || '';
            safeSetTextContent('preview-notes', notes);
        }
        
        // Setup navigation with new sections
        function setupNavigation() {
            const navItems = ['nav-create', 'nav-proforma', 'nav-history', 'nav-clients', 'nav-reports', 'nav-settings'];
            
            navItems.forEach(navId => {
                const navItem = safeGetElement(navId);
                if (navItem) {
                    navItem.addEventListener('click', function(e) {
                        e.preventDefault();
                        const section = navId.replace('nav-', '');
                        showSection(section);
                        
                        // Update navigation active state
                        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                        this.classList.add('active');
                    });
                }
            });
        }
        
        // Show specific section
        function showSection(section) {
            // Hide all sections
            if (invoiceForm) invoiceForm.style.display = 'none';
            if (invoicePreview) invoicePreview.style.display = 'none';
            
            // Hide all history containers
            document.querySelectorAll('.history-container').forEach(container => {
                container.style.display = 'none';
            });
            
            // Hide action buttons
            if (printBtn) printBtn.style.display = 'none';
            if (pdfBtn) pdfBtn.style.display = 'none';
            if (whatsappBtn) whatsappBtn.style.display = 'none';
            const newDocBtn = safeGetElement('new-document-btn');
            if (newDocBtn) newDocBtn.style.display = 'inline-flex';
            
            // Show selected section
            switch(section) {
                case 'create':
                    if (invoiceForm) invoiceForm.style.display = 'block';
                    if (whatsappBtn) whatsappBtn.style.display = 'inline-flex';
                    break;
                case 'proforma':
                    const proformaContainer = safeGetElement('proforma-invoices');
                    if (proformaContainer) proformaContainer.style.display = 'block';
                    loadSavedDocuments();
                    break;
                case 'history':
                    const historyContainer = safeGetElement('invoice-history');
                    if (historyContainer) historyContainer.style.display = 'block';
                    loadSavedDocuments();
                    break;
                case 'clients':
                    const clientContainer = safeGetElement('client-database');
                    if (clientContainer) clientContainer.style.display = 'block';
                    loadClientDatabase();
                    break;
                case 'reports':
                    const reportsContainer = safeGetElement('reports-section');
                    if (reportsContainer) reportsContainer.style.display = 'block';
                    break;
                case 'settings':
                    const settingsContainer = safeGetElement('settings-section');
                    if (settingsContainer) settingsContainer.style.display = 'block';
                    break;
            }
        }
        
        // Add new item row
        function addNewItem() {
            const currencySelect = safeGetElement('currency');
            const currency = currencySelect ? currencySelect.value : 'TSh';
            const symbol = currency === 'TSh' ? 'TSh' : 
                          currency === 'USD' ? '$' :
                          currency === 'EUR' ? '€' : '£';
            
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" class="item-description" placeholder="Service description" value="New service item"></td>
                <td><input type="number" class="item-quantity" min="0" step="0.01" value="1.00"></td>
                <td>
                    <div style="display: flex; align-items: center;">
                        <span class="currency-symbol" style="margin-right: 5px;">${symbol}</span>
                        <input type="number" class="item-price" min="0" step="0.01" value="0.00" style="flex: 1;">
                    </div>
                </td>
                <td class="item-total text-right">${formatCurrency(0, currency)}</td>
                <td class="text-center"><button class="delete-item"><i class="fas fa-trash"></i></button></td>
            `;
            
            if (invoiceItems) invoiceItems.appendChild(newRow);
            
            // Add event listeners
            newRow.querySelector('.item-quantity').addEventListener('input', updateTotals);
            newRow.querySelector('.item-price').addEventListener('input', updateTotals);
            
            updateTotals();
        }
        
        // Delete item row
        function deleteItem(button) {
            const row = button.closest('tr');
            if (row) row.remove();
            updateTotals();
        }
        
        // Generate document preview
        function generateDocument() {
            // Optimize preview for A4
            optimizeForA4();
            
            // Update preview
            updatePreview();
            
            // Add a small delay to ensure rendering is complete
            setTimeout(() => {
                if (invoiceForm) invoiceForm.style.display = 'none';
                if (invoicePreview) invoicePreview.style.display = 'block';
                if (printBtn) printBtn.style.display = 'inline-flex';
                if (pdfBtn) pdfBtn.style.display = 'inline-flex';
                if (whatsappBtn) whatsappBtn.style.display = 'inline-flex';
                
                // Hide all other sections
                document.querySelectorAll('.history-container').forEach(container => {
                    container.style.display = 'none';
                });
                
                // Update navigation
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            }, 100);
        }
        
        // Optimize preview for A4 printing
        function optimizeForA4() {
            // Apply A4 optimization styles to preview
            const preview = safeGetElement('invoice-preview');
            if (preview) {
                // Ensure preview is properly sized for A4
                preview.style.maxWidth = '800px';
                preview.style.marginLeft = 'auto';
                preview.style.marginRight = 'auto';
            }
        }
        
        // Print document with A4 optimization
        function printDocument() {
            const isQuotation = document.getElementById('btn-quotation')?.classList.contains('quotation-active');
            
            // Store current display states
            const originalDisplay = invoicePreview ? invoicePreview.style.display : 'none';
            
            // Ensure preview is visible
            if (invoicePreview) invoicePreview.style.display = 'block';
            
            // Show appropriate stamp
            if (isQuotation) {
                const quotationStamp = document.querySelector('.quotation-stamp');
                if (quotationStamp) quotationStamp.style.display = 'block';
            } else {
                const stamp = document.querySelector('.stamp');
                if (stamp) stamp.style.display = 'block';
            }
            
            // Force a reflow to ensure rendering
            if (invoicePreview) invoicePreview.offsetHeight;
            
            // Use a timeout to ensure content is rendered before printing
            setTimeout(() => {
                // Trigger browser's print dialog
                window.print();
                
                // Restore original states
                setTimeout(() => {
                    if (invoicePreview) invoicePreview.style.display = originalDisplay;
                    
                    if (isQuotation) {
                        const quotationStamp = document.querySelector('.quotation-stamp');
                        if (quotationStamp) quotationStamp.style.display = 'none';
                    } else {
                        const stamp = document.querySelector('.stamp');
                        if (stamp) stamp.style.display = 'none';
                    }
                }, 100);
            }, 500);
        }
        
        // Save document
        function saveDocument() {
            const isProforma = document.getElementById('btn-proforma')?.classList.contains('active');
            const isStandard = document.getElementById('btn-standard')?.classList.contains('active');
            const isQuotation = document.getElementById('btn-quotation')?.classList.contains('quotation-active');
            
            const documentType = isProforma ? 'Proforma' : isStandard ? 'Standard' : 'Quotation';
            const currencySelect = safeGetElement('currency');
            const currency = currencySelect ? currencySelect.value : 'TSh';
            
            const documentData = {
                id: Date.now(), // Unique ID for each document
                companyName: "KINGU ELECTRICAL COMPANY LIMITED",
                companyTIN: COMPANY_TIN,
                email: COMPANY_EMAIL,
                tagline: COMPANY_TAGLINE,
                phoneNumbers: [COMPANY_PHONE_1, COMPANY_PHONE_2, COMPANY_PHONE_3],
                address: COMPANY_ADDRESS,
                type: documentType,
                documentNumber: safeGetElement('invoice-number')?.value || '',
                documentDate: safeGetElement('invoice-date')?.value || '',
                dueDate: safeGetElement('due-date')?.value || '',
                currency: currency,
                deliveryTime: safeGetElement('delivery-time')?.value || '7',
                clientName: safeGetElement('client-name')?.value || '',
                clientEmail: safeGetElement('client-email')?.value || '',
                clientPhone: safeGetElement('client-phone')?.value || '',
                clientAddress: safeGetElement('client-address')?.value || '',
                clientTIN: safeGetElement('client-tin')?.value || '',
                clientVAT: safeGetElement('client-vat')?.value || '',
                paymentTerms: safeGetElement('payment-terms')?.value || '',
                bankDetails: safeGetElement('bank-details')?.value || '',
                notes: safeGetElement('notes')?.value || '',
                items: [],
                subtotal: extractCurrencyValue(safeGetElement('subtotal')?.textContent || '0'),
                discount: extractCurrencyValue(safeGetElement('discount-amount')?.textContent || '0'),
                tax: extractCurrencyValue(safeGetElement('tax')?.textContent || '0'),
                grandTotal: extractCurrencyValue(safeGetElement('grand-total')?.textContent || '0'),
                savedDate: new Date().toISOString(),
                status: isQuotation ? 'Quotation' : (isProforma ? 'Pending' : 'Unpaid')
            };
            
            // Collect items
            const rows = document.querySelectorAll('#invoice-items tr');
            rows.forEach(row => {
                const item = {
                    description: row.querySelector('.item-description')?.value || '',
                    quantity: parseFloat(row.querySelector('.item-quantity')?.value) || 0,
                    price: parseFloat(row.querySelector('.item-price')?.value) || 0,
                    total: extractCurrencyValue(row.querySelector('.item-total')?.textContent || '0')
                };
                documentData.items.push(item);
            });
            
            // Save to localStorage (simulating saving to a folder)
            let documents = JSON.parse(localStorage.getItem('kinguDocuments')) || [];
            documents.push(documentData);
            localStorage.setItem('kinguDocuments', JSON.stringify(documents));
            
            // Generate and save PDF automatically
            generateAndSavePDF(documentData);
            
            alert(`${documentType} ${isQuotation ? '' : 'Invoice '}${documentData.documentNumber} saved successfully!\nPDF has been generated and saved.`);
            
            // Update the history views
            loadSavedDocuments();
            
            // Show the document preview
            generateDocument();
        }
        
        // Generate and save PDF with A4 optimization
        function generateAndSavePDF(documentData) {
            // Show loading message
            const originalText = pdfBtn ? pdfBtn.innerHTML : '';
            if (pdfBtn) {
                pdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
                pdfBtn.disabled = true;
            }
            
            try {
                // Get document preview element
                const documentElement = safeGetElement('invoice-preview');
                if (!documentElement) {
                    throw new Error('Invoice preview element not found');
                }
                
                // Temporarily update preview with the saved data
                const originalDisplay = invoicePreview ? invoicePreview.style.display : 'none';
                if (invoicePreview) invoicePreview.style.display = 'block';
                
                // Store original content
                const originalClientName = safeGetElement('preview-client-name')?.innerHTML;
                const originalClientAddress = safeGetElement('preview-client-address')?.textContent;
                const originalClientTIN = safeGetElement('preview-client-tin')?.textContent;
                const originalClientPhone = safeGetElement('preview-client-phone')?.textContent;
                const originalClientEmail = safeGetElement('preview-client-email')?.textContent;
                const originalInvoiceNumber = safeGetElement('preview-invoice-number')?.textContent;
                const originalInvoiceDate = safeGetElement('preview-invoice-date')?.textContent;
                const originalPreviewItems = previewItems ? previewItems.innerHTML : '';
                const originalPreviewTotals = safeGetElement('preview-totals')?.innerHTML;
                const originalBankDetails = safeGetElement('preview-bank-details')?.textContent;
                const originalNotes = safeGetElement('preview-notes')?.textContent;
                
                // Update preview with document data
                const isQuotation = documentData.type === 'Quotation';
                updatePreviewLabels(isQuotation);
                
                safeSetTextContent('preview-doc-type', documentData.type.toUpperCase());
                safeSetHTML('preview-client-name', `<strong>${documentData.clientName || 'Client Name'}</strong>`);
                safeSetTextContent('preview-client-address', documentData.clientAddress || 'Client Address');
                safeSetTextContent('preview-client-tin', documentData.clientTIN ? `TIN Number: ${documentData.clientTIN}` : '');
                safeSetTextContent('preview-client-phone', documentData.clientPhone ? `Phone: ${documentData.clientPhone}` : '');
                safeSetTextContent('preview-client-email', documentData.clientEmail ? `Email: ${documentData.clientEmail}` : '');
                safeSetTextContent('preview-invoice-number', documentData.documentNumber);
                safeSetTextContent('preview-invoice-date', formatDate(documentData.documentDate));
                
                // Update due date
                if (documentData.dueDate) {
                    const infoBox = safeGetElement('preview-info-box');
                    if (infoBox) {
                        let dueDateElement = infoBox.querySelector('#preview-due-date');
                        if (!dueDateElement) {
                            const p = document.createElement('p');
                            p.innerHTML = `<strong>Due Date:</strong> <span id="preview-due-date">${formatDate(documentData.dueDate)}</span>`;
                            infoBox.appendChild(p);
                        } else {
                            dueDateElement.textContent = formatDate(documentData.dueDate);
                        }
                    }
                }
                
                safeSetTextContent('preview-delivery-time', documentData.deliveryTime ? `${documentData.deliveryTime} days after PO` : '7 days after PO');
                safeSetTextContent('preview-payment-terms', documentData.paymentTerms || '');
                
                // Set stamps
                const stamp = document.querySelector('.stamp');
                const quotationStamp = document.querySelector('.quotation-stamp');
                if (stamp) stamp.style.display = isQuotation ? 'none' : 'block';
                if (quotationStamp) quotationStamp.style.display = isQuotation ? 'block' : 'none';
                
                // Update items
                if (previewItems) {
                    previewItems.innerHTML = '';
                    documentData.items.forEach(item => {
                        const newRow = document.createElement('tr');
                        newRow.innerHTML = `
                            <td style="word-break: break-word;">${item.description || 'Item'}</td>
                            <td>${parseFloat(item.quantity || 0).toFixed(2)}</td>
                            <td>${formatCurrency(item.price || 0, documentData.currency || 'TSh')}</td>
                            <td>${formatCurrency(item.total || 0, documentData.currency || 'TSh')}</td>
                        `;
                        previewItems.appendChild(newRow);
                    });
                }
                
                // Update totals in preview
                const previewTotals = safeGetElement('preview-totals');
                if (previewTotals) {
                    let totalsHTML = `
                        <div class="total-row">
                            <span class="total-label">Subtotal:</span>
                            <span class="total-value" id="preview-subtotal">${formatCurrency(documentData.subtotal || 0, documentData.currency || 'TSh')}</span>
                        </div>
                    `;
                    
                    if (documentData.discount > 0) {
                        totalsHTML += `
                            <div class="total-row">
                                <span class="total-label">Discount:</span>
                                <span class="total-value" id="preview-discount">${formatCurrency(documentData.discount || 0, documentData.currency || 'TSh')}</span>
                            </div>
                        `;
                    }
                    
                    totalsHTML += `
                        <div class="total-row">
                            <span class="total-label">VAT (18%):</span>
                            <span class="total-value" id="preview-tax">${formatCurrency(documentData.tax || 0, documentData.currency || 'TSh')}</span>
                        </div>
                        <div class="total-row grand-total">
                            <span class="total-label" id="preview-grand-total-label">${isQuotation ? 'TOTAL QUOTATION:' : 'GRAND TOTAL:'}</span>
                            <span class="total-value" id="preview-grand-total">${formatCurrency(documentData.grandTotal || 0, documentData.currency || 'TSh')}</span>
                        </div>
                    `;
                    
                    // Add amount in words
                    const amountWords = numberToWords(Math.round(documentData.grandTotal || 0));
                    totalsHTML += `
                        <div style="margin-top: 10px; font-size: 11px; font-style: italic; color: #555; word-break: break-word;">
                            <strong>Amount in Words:</strong> ${amountWords}
                        </div>
                    `;
                    
                    previewTotals.innerHTML = totalsHTML;
                }
                
                // Update terms
                safeSetTextContent('preview-bank-details', documentData.bankDetails || '');
                safeSetTextContent('preview-notes', documentData.notes || '');
                
                // Force a reflow to ensure all elements are rendered
                documentElement.offsetHeight;
                
                // Use html2canvas to capture the document
                html2canvas(documentElement, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    allowTaint: true,
                    windowWidth: 800, // Set width for A4
                    onclone: function(clonedDoc) {
                        // Ensure stamps are visible in the cloned document
                        if (isQuotation) {
                            const stamp = clonedDoc.querySelector('.quotation-stamp');
                            if (stamp) stamp.style.display = 'block';
                        } else {
                            const stamp = clonedDoc.querySelector('.stamp');
                            if (stamp) stamp.style.display = 'block';
                        }
                        
                        // Apply print styles to clone
                        clonedDoc.body.style.width = '210mm';
                        clonedDoc.body.style.height = '297mm';
                    }
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    
                    // Calculate image dimensions to fit A4
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
                    const imgX = (pdfWidth - imgWidth * ratio) / 2;
                    const imgY = 10; // Top margin
                    
                    // Add image to PDF
                    pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
                    
                    // Generate filename
                    const fileName = `Kingu_${documentData.type}_${documentData.documentNumber}_${(documentData.clientName || 'Client').replace(/\s+/g, '_')}.pdf`;
                    
                    // Restore original content
                    if (originalClientName) safeSetHTML('preview-client-name', originalClientName);
                    if (originalClientAddress) safeSetTextContent('preview-client-address', originalClientAddress);
                    if (originalClientTIN) safeSetTextContent('preview-client-tin', originalClientTIN);
                    if (originalClientPhone) safeSetTextContent('preview-client-phone', originalClientPhone);
                    if (originalClientEmail) safeSetTextContent('preview-client-email', originalClientEmail);
                    if (originalInvoiceNumber) safeSetTextContent('preview-invoice-number', originalInvoiceNumber);
                    if (originalInvoiceDate) safeSetTextContent('preview-invoice-date', originalInvoiceDate);
                    
                    if (originalPreviewItems && previewItems) previewItems.innerHTML = originalPreviewItems;
                    if (originalPreviewTotals) safeGetElement('preview-totals').innerHTML = originalPreviewTotals;
                    if (originalBankDetails) safeSetTextContent('preview-bank-details', originalBankDetails);
                    if (originalNotes) safeSetTextContent('preview-notes', originalNotes);
                    
                    // Restore original display
                    if (invoicePreview) invoicePreview.style.display = originalDisplay;
                    
                    // Save PDF
                    pdf.save(fileName);
                    
                    // Restore button text
                    if (pdfBtn) {
                        pdfBtn.innerHTML = originalText;
                        pdfBtn.disabled = false;
                    }
                    
                }).catch(error => {
                    console.error('Error generating PDF:', error);
                    
                    // Restore button text
                    if (pdfBtn) {
                        pdfBtn.innerHTML = originalText;
                        pdfBtn.disabled = false;
                    }
                    
                    // Restore original display
                    if (invoicePreview) invoicePreview.style.display = 'block';
                    setTimeout(() => {
                        if (invoicePreview) invoicePreview.style.display = 'none';
                    }, 100);
                    
                    alert('Error generating PDF. Please try again. If the problem persists, try printing the document instead.');
                });
                
            } catch (error) {
                console.error('Error in PDF generation:', error);
                if (pdfBtn) {
                    pdfBtn.innerHTML = originalText;
                    pdfBtn.disabled = false;
                }
                alert('Error generating PDF: ' + error.message);
            }
        }
        
        // Export to PDF (manual export)
        function exportToPDF() {
            const isProforma = document.getElementById('btn-proforma')?.classList.contains('active');
            const isStandard = document.getElementById('btn-standard')?.classList.contains('active');
            const isQuotation = document.getElementById('btn-quotation')?.classList.contains('quotation-active');
            
            const documentData = {
                documentNumber: safeGetElement('invoice-number')?.value || '',
                clientName: safeGetElement('client-name')?.value || '',
                type: isQuotation ? 'Quotation' : (isProforma ? 'Proforma' : 'Standard'),
                currency: safeGetElement('currency')?.value || 'TSh',
                // Additional required fields
                clientAddress: safeGetElement('client-address')?.value || '',
                clientEmail: safeGetElement('client-email')?.value || '',
                clientPhone: safeGetElement('client-phone')?.value || '',
                clientTIN: safeGetElement('client-tin')?.value || '',
                clientVAT: safeGetElement('client-vat')?.value || '',
                documentDate: safeGetElement('invoice-date')?.value || '',
                dueDate: safeGetElement('due-date')?.value || '',
                deliveryTime: safeGetElement('delivery-time')?.value || '',
                paymentTerms: safeGetElement('payment-terms')?.value || '',
                bankDetails: safeGetElement('bank-details')?.value || '',
                notes: safeGetElement('notes')?.value || '',
                items: [],
                subtotal: extractCurrencyValue(safeGetElement('subtotal')?.textContent || '0'),
                discount: extractCurrencyValue(safeGetElement('discount-amount')?.textContent || '0'),
                tax: extractCurrencyValue(safeGetElement('tax')?.textContent || '0'),
                grandTotal: extractCurrencyValue(safeGetElement('grand-total')?.textContent || '0')
            };
            
            // Collect items for the PDF
            const rows = document.querySelectorAll('#invoice-items tr');
            rows.forEach(row => {
                const item = {
                    description: row.querySelector('.item-description')?.value || '',
                    quantity: parseFloat(row.querySelector('.item-quantity')?.value) || 0,
                    price: parseFloat(row.querySelector('.item-price')?.value) || 0,
                    total: extractCurrencyValue(row.querySelector('.item-total')?.textContent || '0')
                };
                documentData.items.push(item);
            });
            
            generateAndSavePDF(documentData);
        }
        
        // Load saved documents and display in history
        function loadSavedDocuments() {
            const documents = JSON.parse(localStorage.getItem('kinguDocuments')) || [];
            
            // Filter proforma invoices
            const proformaInvoices = documents.filter(doc => doc.type === 'Proforma');
            // All documents for history
            const allDocuments = [...documents].reverse(); // Show newest first
            
            // Display proforma invoices
            const proformaList = safeGetElement('proforma-list');
            if (proformaList) {
                if (proformaInvoices.length > 0) {
                    let proformaHTML = `
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>Document #</th>
                                    <th>Client</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    proformaInvoices.forEach(document => {
                        proformaHTML += `
                            <tr>
                                <td>${document.documentNumber}</td>
                                <td>${document.clientName}</td>
                                <td>${formatDateShort(document.documentDate)}</td>
                                <td>${formatCurrency(document.grandTotal, document.currency)}</td>
                                <td><span class="status-badge status-pending">${document.status}</span></td>
                                <td>
                                    <button class="action-btn-small" style="background-color: var(--kingu-green); color: white;" onclick="viewDocument(${document.id})">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button class="action-btn-small" style="background-color: #d32f2f; color: white;" onclick="downloadPDF(${document.id})">
                                        <i class="fas fa-file-pdf"></i> PDF
                                    </button>
                                    <button class="action-btn-small" style="background-color: #6b7280; color: white;" onclick="deleteDocument(${document.id})">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    proformaHTML += '</tbody></table>';
                    proformaList.innerHTML = proformaHTML;
                } else {
                    proformaList.innerHTML = '<p>No proforma invoices found. Create your first proforma invoice!</p>';
                }
            }
            
            // Display all documents in history
            const historyList = safeGetElement('history-list');
            if (historyList) {
                if (allDocuments.length > 0) {
                    let historyHTML = `
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Document #</th>
                                    <th>Client</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    allDocuments.forEach(document => {
                        const statusClass = document.status === 'Paid' ? 'status-paid' : 
                                          document.status === 'Overdue' ? 'status-overdue' : 
                                          document.status === 'Quotation' ? 'status-quotation' : 'status-pending';
                        
                        historyHTML += `
                            <tr>
                                <td>${document.type}</td>
                                <td>${document.documentNumber}</td>
                                <td>${document.clientName}</td>
                                <td>${formatDateShort(document.documentDate)}</td>
                                <td>${formatCurrency(document.grandTotal, document.currency)}</td>
                                <td><span class="status-badge ${statusClass}">${document.status}</span></td>
                                <td>
                                    <button class="action-btn-small" style="background-color: var(--kingu-green); color: white;" onclick="viewDocument(${document.id})">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button class="action-btn-small" style="background-color: #d32f2f; color: white;" onclick="downloadPDF(${document.id})">
                                        <i class="fas fa-file-pdf"></i> PDF
                                    </button>
                                    <button class="action-btn-small" style="background-color: #6b7280; color: white;" onclick="deleteDocument(${document.id})">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    historyHTML += '</tbody></table>';
                    historyList.innerHTML = historyHTML;
                } else {
                    historyList.innerHTML = '<p>No document history found. Create your first document!</p>';
                }
            }
        }
        
        // View saved document
        function viewDocument(documentId) {
            const documents = JSON.parse(localStorage.getItem('kinguDocuments')) || [];
            const document = documents.find(doc => doc.id === documentId);
            
            if (document) {
                // Set document type
                setInvoiceType(document.type.toLowerCase());
                
                // Fill form with document data
                safeGetElement('invoice-number').value = document.documentNumber;
                safeGetElement('invoice-date').value = document.documentDate;
                safeGetElement('due-date').value = document.dueDate || '';
                safeGetElement('currency').value = document.currency;
                safeGetElement('delivery-time').value = document.deliveryTime;
                safeGetElement('client-name').value = document.clientName;
                safeGetElement('client-email').value = document.clientEmail;
                safeGetElement('client-phone').value = document.clientPhone;
                safeGetElement('client-address').value = document.clientAddress;
                safeGetElement('client-tin').value = document.clientTIN;
                safeGetElement('client-vat').value = document.clientVAT || '';
                safeGetElement('payment-terms').value = document.paymentTerms;
                safeGetElement('bank-details').value = document.bankDetails;
                safeGetElement('notes').value = document.notes;
                
                // Set items
                if (invoiceItems) invoiceItems.innerHTML = '';
                document.items.forEach(item => {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td><input type="text" class="item-description" value="${item.description}"></td>
                        <td><input type="number" class="item-quantity" min="0" step="0.01" value="${item.quantity}"></td>
                        <td>
                            <div style="display: flex; align-items: center;">
                                <span class="currency-symbol" style="margin-right: 5px;">${document.currency === 'TSh' ? 'TSh' : document.currency === 'USD' ? '$' : document.currency === 'EUR' ? '€' : '£'}</span>
                                <input type="number" class="item-price" min="0" step="0.01" value="${item.price}" style="flex: 1;">
                            </div>
                        </td>
                        <td class="item-total text-right">${formatCurrency(item.total, document.currency)}</td>
                        <td class="text-center"><button class="delete-item"><i class="fas fa-trash"></i></button></td>
                    `;
                    if (invoiceItems) invoiceItems.appendChild(newRow);
                    
                    // Add event listeners
                    newRow.querySelector('.item-quantity').addEventListener('input', updateTotals);
                    newRow.querySelector('.item-price').addEventListener('input', updateTotals);
                });
                
                updateCurrencySymbol();
                updateTotals();
                
                // Show create document page
                showSection('create');
                
                alert(`Loaded ${document.type.toLowerCase()} ${document.documentNumber}. You can edit and save as a new document.`);
            }
        }
        
        // Download PDF
        function downloadPDF(documentId) {
            const documents = JSON.parse(localStorage.getItem('kinguDocuments')) || [];
            const document = documents.find(doc => doc.id === documentId);
            
            if (document) {
                // Regenerate PDF from document data
                generateAndSavePDF(document);
            } else {
                alert('Document not found.');
            }
        }
        
        // Delete document
        function deleteDocument(documentId) {
            if (confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
                let documents = JSON.parse(localStorage.getItem('kinguDocuments')) || [];
                documents = documents.filter(doc => doc.id !== documentId);
                localStorage.setItem('kinguDocuments', JSON.stringify(documents));
                loadSavedDocuments();
                alert('Document deleted successfully.');
            }
        }
        
        // Clear form
        function clearForm() {
            if (confirm('Are you sure you want to clear the form? All entered data will be lost.')) {
                const form = safeGetElement('invoice-form');
                if (form) form.reset();
                
                const currencySelect = safeGetElement('currency');
                const currency = currencySelect ? currencySelect.value : 'TSh';
                const symbol = currency === 'TSh' ? 'TSh' : 
                              currency === 'USD' ? '$' :
                              currency === 'EUR' ? '€' : '£';
                
                if (invoiceItems) {
                    invoiceItems.innerHTML = `
                        <tr>
                            <td><input type="text" class="item-description" placeholder="Service description" value="Service item"></td>
                            <td><input type="number" class="item-quantity" min="0" step="0.01" value="1.00"></td>
                            <td>
                                <div style="display: flex; align-items: center;">
                                    <span class="currency-symbol" style="margin-right: 5px;">${symbol}</span>
                                    <input type="number" class="item-price" min="0" step="0.01" value="0.00" style="flex: 1;">
                                </div>
                            </td>
                            <td class="item-total text-right">${formatCurrency(0, currency)}</td>
                            <td class="text-center"><button class="delete-item"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    `;
                }
                
                const today = new Date();
                const invoiceDate = safeGetElement('invoice-date');
                if (invoiceDate) invoiceDate.valueAsDate = today;
                
                // Set due date to 30 days from now
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 30);
                const dueDateInput = safeGetElement('due-date');
                if (dueDateInput) dueDateInput.valueAsDate = dueDate;
                
                // Reset discount
                const discountType = safeGetElement('discount-type');
                if (discountType) discountType.value = 'none';
                
                const discountValueContainer = safeGetElement('discount-value-container');
                if (discountValueContainer) discountValueContainer.style.display = 'none';
                
                const discountRow = safeGetElement('discount-row');
                if (discountRow) discountRow.style.display = 'none';
                
                const discountValue = safeGetElement('discount-value');
                if (discountValue) discountValue.value = '0';
                
                // Reset custom terms
                const customTermsContainer = safeGetElement('custom-terms-container');
                if (customTermsContainer) customTermsContainer.style.display = 'none';
                
                // Generate new invoice number
                generateInvoiceNumber();
                
                updateTotals();
                
                createNewDocument();
            }
        }
        
        // Load sample data
        function loadSampleProforma() {
            const isQuotation = document.getElementById('btn-quotation')?.classList.contains('quotation-active');
            
            if (isQuotation) {
                // Load sample quotation data
                const sampleItems = [
                    { description: "Electrical Installation for Office Building", quantity: "1.00", price: "5000000.00" },
                    { description: "Lighting System Installation", quantity: "1.00", price: "2500000.00" },
                    { description: "Power Distribution Board", quantity: "2.00", price: "750000.00" },
                    { description: "Wiring and Cabling", quantity: "500.00", price: "5000.00" },
                    { description: "Circuit Breakers and Switches", quantity: "50.00", price: "25000.00" },
                    { description: "Labor and Installation", quantity: "15.00", price: "100000.00" }
                ];
                
                if (invoiceItems) invoiceItems.innerHTML = '';
                
                sampleItems.forEach(item => {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td><input type="text" class="item-description" value="${item.description}"></td>
                        <td><input type="number" class="item-quantity" min="0" step="0.01" value="${item.quantity}"></td>
                        <td>
                            <div style="display: flex; align-items: center;">
                                <span class="currency-symbol" style="margin-right: 5px;">TSh</span>
                                <input type="number" class="item-price" min="0" step="0.01" value="${item.price}" style="flex: 1;">
                            </div>
                        </td>
                        <td class="item-total text-right">TSh 0.00</td>
                        <td class="text-center"><button class="delete-item"><i class="fas fa-trash"></i></button></td>
                    `;
                    
                    if (invoiceItems) invoiceItems.appendChild(newRow);
                    
                    newRow.querySelector('.item-quantity').addEventListener('input', updateTotals);
                    newRow.querySelector('.item-price').addEventListener('input', updateTotals);
                });
                
                safeGetElement('currency').value = 'TSh';
                updateCurrencySymbol();
                
                // Set sample client info for quotation
                safeGetElement('client-name').value = 'TANZANIA COMMERCIAL BANK';
                safeGetElement('client-address').value = 'DAR ES SALAAM, TANZANIA';
                safeGetElement('client-tin').value = '200-456-789';
                safeGetElement('client-phone').value = '+255 222 123 456';
                safeGetElement('client-email').value = 'procurement@tcb.co.tz';
                safeGetElement('payment-terms').value = '30% advance, 70% after completion';
                safeGetElement('bank-details').value = 'STANBIC BANK 912 000 275 9274 (KINGU ELECTRICAL COMPANY LIMITED)';
                safeGetElement('notes').value = 'This quotation is valid for 45 days.\nDelivery time: 30 days after order confirmation.\nPrices include VAT and all taxes.\nWarranty: 12 months on all installations.';
                safeGetElement('delivery-time').value = '30';
                
                updateTotals();
                
                alert('Sample quotation loaded for TANZANIA COMMERCIAL BANK project.');
            } else {
                // Load sample proforma data
                const sampleItems = [
                    { description: "Engine service and Preventive maintenance", quantity: "1.00", price: "350000.00" },
                    { description: "PLC check and configuration", quantity: "1.00", price: "250000.00" },
                    { description: "AC Alternator cleanup and ATS", quantity: "1.00", price: "170000.00" },
                    { description: "Air filter", quantity: "1.00", price: "25000.00" },
                    { description: "fanbelt", quantity: "1.00", price: "8500.00" },
                    { description: "Coolant", quantity: "5.00", price: "15000.00" },
                    { description: "Engine oil", quantity: "9.00", price: "14000.00" }
                ];
                
                if (invoiceItems) invoiceItems.innerHTML = '';
                
                sampleItems.forEach(item => {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td><input type="text" class="item-description" value="${item.description}"></td>
                        <td><input type="number" class="item-quantity" min="0" step="0.01" value="${item.quantity}"></td>
                        <td>
                            <div style="display: flex; align-items: center;">
                                <span class="currency-symbol" style="margin-right: 5px;">TSh</span>
                                <input type="number" class="item-price" min="0" step="0.01" value="${item.price}" style="flex: 1;">
                            </div>
                        </td>
                        <td class="item-total text-right">TSh 0.00</td>
                        <td class="text-center"><button class="delete-item"><i class="fas fa-trash"></i></button></td>
                    `;
                    
                    if (invoiceItems) invoiceItems.appendChild(newRow);
                    
                    newRow.querySelector('.item-quantity').addEventListener('input', updateTotals);
                    newRow.querySelector('.item-price').addEventListener('input', updateTotals);
                });
                
                safeGetElement('currency').value = 'TSh';
                updateCurrencySymbol();
                
                // Set sample client info
                safeGetElement('client-name').value = 'GREENLIGHT PLANNET TANZANIA LTD';
                safeGetElement('client-address').value = 'ARUSHA, TANZANIA';
                safeGetElement('client-tin').value = '109-628-980';
                safeGetElement('client-phone').value = '+255 765 432 100';
                safeGetElement('client-email').value = 'accounts@greenlight.co.tz';
                safeGetElement('payment-terms').value = '100% after delivery';
                safeGetElement('bank-details').value = 'STANBIC BANK 912 000 275 9274 (KINGU ELECTRICAL COMPANY LIMITED)';
                safeGetElement('notes').value = 'This Proforma shall remain valid for 30 days only.\nDelivery time: 7 days after PO issue.';
                
                updateTotals();
                
                alert('Sample proforma invoice loaded from DG SERVICE GREENLIGHT June 2025.pdf');
            }
        }
        
        // Send document via WhatsApp
        function sendWhatsApp() {
            const documentNumber = safeGetElement('invoice-number')?.value || '';
            const clientName = safeGetElement('client-name')?.value || 'Client';
            const grandTotal = safeGetElement('grand-total')?.textContent || '';
            const isQuotation = document.getElementById('btn-quotation')?.classList.contains('quotation-active');
            const isProforma = document.getElementById('btn-proforma')?.classList.contains('active');
            const docType = isQuotation ? 'quotation' : (isProforma ? 'proforma invoice' : 'invoice');
            
            const message = `Hello, here is your ${docType} ${documentNumber} from KINGU ELECTRICAL COMPANY LIMITED for ${clientName}. Total amount: ${grandTotal}. Please review and confirm.`;
            
            // Encode the message for WhatsApp URL
            const encodedMessage = encodeURIComponent(message);
            const phoneNumber = '255682843552';
            
            // Open WhatsApp with pre-filled message
            window.open(`https://wa.me/${phoneNumber}?text=${encodedMessage}`, '_blank');
            
            // Show confirmation
            alert(`Opening WhatsApp to share ${docType} details. Please send to your client.`);
        }
        
        // Make additional functions available globally
        window.selectClientFromList = function(clientId) {
            const clients = JSON.parse(localStorage.getItem('kinguClients')) || [];
            const client = clients.find(c => c.id === clientId);
            if (client) {
                // Find client index
                const index = clients.findIndex(c => c.id === clientId);
                selectClient(index);
                showSection('create');
            }
        };
        
        window.editClient = function(clientId) {
            alert('Edit client functionality would open a form to edit client details');
            // In a real implementation, this would open a modal with the client's details for editing
        };
        
        window.deleteClient = function(clientId) {
            if (confirm('Are you sure you want to delete this client?')) {
                let clients = JSON.parse(localStorage.getItem('kinguClients')) || [];
                clients = clients.filter(c => c.id !== clientId);
                localStorage.setItem('kinguClients', JSON.stringify(clients));
                loadClientDatabase();
                alert('Client deleted successfully.');
            }
        };
        
        // Make functions available globally for onclick handlers
        window.viewInvoice = viewDocument;
        window.viewDocument = viewDocument;
        window.downloadPDF = downloadPDF;
        window.deleteInvoice = deleteDocument;
        window.deleteDocument = deleteDocument;
    </script>
</body>
</html>
